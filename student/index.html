<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PolyTalky ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <meta name="description" content="–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç PolyTalky: –≤–∞—à–∏ –∫—É—Ä—Å—ã, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- —Ñ–∞–≤–∏–∫–æ–Ω -->
  <link rel="icon" type="image/jpg" href="/assets/favicon.jpg">
  <link rel="apple-touch-icon" href="/favicon.png">
  <style>
    :root{
      --brand-1:#FFBA08;
      --brand-2:#F97316;
      --brand-3:#10B981;

      --ink-1:#0F172A;
      --ink-2:#4B5563;
      --ink-soft:#9CA3AF;
      --bg-soft:#F9FAFB;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(circle at top left,#FEF9C3 0,#FEFCE8 40%,#F9FAFB 100%);
      color:#0f172a;
    }
    .wrap{max-width:1040px;margin:0 auto;}
    .card{
      border-radius:1.25rem;
      border:1px solid rgba(15,23,42,.08);
      background-color:rgba(255,255,255,.96);
      box-shadow:0 18px 45px rgba(15,23,42,.08);
    }
    .soft-card{
      border-radius:1rem;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(255,255,255,.9);
    }
    .badge{
      border-radius:.6rem;
      padding:.25rem .45rem;
      font-size:.7rem;
      border: none !important;
      background:rgba(248,250,252,.7);
    }
    .btn{
      border-radius:999px;
      padding:.55rem 1.2rem;
      font-size:.88rem;
      font-weight:600;
      border:1px solid transparent;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.4rem;
      white-space:nowrap;
    }
    .btn-main{
      background:linear-gradient(135deg,var(--brand-2),var(--brand-1));
      color:#111827;
      box-shadow:0 12px 30px rgba(234,179,8,.45);
    }
    .btn-main:hover{filter:brightness(1.03);}
    .btn-ghost{
      background:rgba(255,255,255,.7);
      border-color:rgba(148,163,184,.5);
      color:#374151;
    }
    .btn-ghost:hover{background:white;}
    .pill-label{
      border-radius:999px;
      padding:.18rem .6rem;
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(249,250,251,.9);
      color:#4b5563;
    }
    .hp-field{
      position:absolute;
      left:-9999px;
      opacity:0;
      pointer-events:none;
      height:0;width:0;
    }

    /* PRO-banners */
    .pro-banner{
      max-width:1040px;
      margin:0 auto 0;
      padding:10px 14px;
      border-radius:14px;
      display:none;
      align-items:flex-start;
      gap:10px;
      font-size:13px;
    }
    .pro-banner__icon{
      flex:0 0 28px;
      height:28px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      font-weight:600;
    }
    .pro-banner__body h2{
      margin:0 0 2px;
      font-size:14px;
      font-weight:600;
    }
    .pro-banner__body p{
      margin:0;
      font-size:13px;
    }
    .pro-banner--success{
      background:linear-gradient(135deg,#ecfdf5,#f0fdf4,#ffffff);
      color:#065f46;
    }
    .pro-banner--success .pro-banner__icon{
      background:#22c55e;
      color:#ecfdf5;
      box-shadow:0 0 0 2px #bbf7d0;
    }
    .pro-banner--error{
      background:linear-gradient(135deg,#fef2f2,#fee2e2,#ffffff);
      color:#b91c1c;
    }
    .pro-banner--error .pro-banner__icon{
      background:#ef4444;
      color:#fef2f2;
      box-shadow:0 0 0 2px #fecaca;
    }
    .pro-banner--cancel{
      background:linear-gradient(135deg,#f9fafb,#e5e7eb,#ffffff);
      color:#374151;
    }
    .pro-banner--cancel .pro-banner__icon{
      background:#6b7280;
      color:#f9fafb;
      box-shadow:0 0 0 2px #e5e7eb;
    }
    .pro-banner__btn{
      margin-left:auto;
      border-radius:999px;
      padding:6px 14px;
      border:none;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:#0f172a;
      color:#f9fafb;
      white-space:nowrap;
    }
    .pro-banner__btn:hover{background:#111827;}

    #pro-chip {
      animation: pro-chip-pulse 1.6s ease-in-out infinite alternate;
    }

    @keyframes pro-chip-pulse {
      from { transform: translateY(0); box-shadow: 0 0 0 1px rgba(16,185,129,.15); }
      to   { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(16,185,129,.28); }
    }

    #wheel-modal .card{
  max-height: calc(100vh - 32px);
  overflow-y: scroll;
      scrollbar-gutter: stable;
  -webkit-overflow-scrolling: touch;
}

/* —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
@media (max-width:640px){
  #wheel-modal .card{
    max-height: calc(100vh - 16px);
    padding-bottom: 16px;
  }
  #wheel-result { padding-bottom: 8px; }
}
/* –ö–û–õ–ï–°–û –£–î–ê–ß–ò */
.wheel-container{
  position:relative;
  width:360px;
  height:360px;
  margin:0 auto;
}

/* –º—è–≥–∫–∏–π ‚Äú–ø—Ä–µ–º–∏—É–º‚Äù-–≤–∏–¥ –ø–æ–¥ –≤–∞—à UI */
.wheel-canvas{
  width:100%;
  height:100%;
  border-radius:50%;
  display:block;

  /* –≤–º–µ—Å—Ç–æ ‚Äú—á—ë—Ä–Ω–æ–π —è–º—ã‚Äù ‚Äî –º—è–≥–∫–∞—è —Ç–µ–Ω—å –∫–∞–∫ —É card */
  box-shadow:
    0 18px 45px rgba(15,23,42,.14),
    0 0 0 10px rgba(255,255,255,.92),
    0 0 0 14px rgba(255,186,8,.55);

  /* —á—Ç–æ–±—ã –≤—Ä–∞—â–µ–Ω–∏–µ –±—ã–ª–æ –ø—Ä–∏—è—Ç–Ω—ã–º */
  transform-origin:50% 50%;
}

/* —É–∫–∞–∑–∞—Ç–µ–ª—å –≤ —Ñ–∏—Ä–º–µ–Ω–Ω–æ–º —Å—Ç–∏–ª–µ: –±–µ–ª—ã–π + –∂—ë–ª—Ç–∞—è –æ–∫–∞–Ω—Ç–æ–≤–∫–∞ */
.wheel-pointer{
  position:absolute;
  top:-18px;
  left:50%;
  transform:translateX(-50%);
  width:0;height:0;
  border-left:18px solid transparent;
  border-right:18px solid transparent;
  border-top:42px solid rgba(255,255,255,.98);
  filter:drop-shadow(0 6px 10px rgba(15,23,42,.22));
  z-index:10;
}
.wheel-pointer::after{
  content:"";
  position:absolute;
  left:-18px; top:-42px;
  width:0;height:0;
  border-left:18px solid transparent;
  border-right:18px solid transparent;
  border-top:42px solid rgba(255,186,8,.65);
  transform:translateY(4px) scale(.92);
  z-index:-1;
}

.wheel-center-button{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:96px;
  height:96px;
  border-radius:50%;
  background:linear-gradient(135deg,#fff7d6,#ffffff);
  border:8px solid rgba(255,186,8,.75);
  box-shadow:0 18px 45px rgba(15,23,42,.18);
  display:flex;
  align-items:center;
  justify-content:center;

  font-weight:900;
  letter-spacing:.08em;
  color:#0F172A;
  text-transform:uppercase;
  cursor:pointer;
  z-index:20;

  padding:10px 12px;
  line-height:1.05;
  text-align:center;

   overflow:hidden;
  white-space:normal;
  font-size:14px;
}

@media (max-width:640px){
  .pro-banner{
    margin:0 1rem;
    flex-direction:column;
    align-items:flex-start;
  }
  .pro-banner__btn{
    margin-left:0;
    margin-top:6px;
  }

  /* –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏–º–µ–Ω–Ω–æ –∫—Ä–∞—Å–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –º–æ–±–∏–ª–µ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Ç–∞–∫: */
  .wheel-pointer{
    border-left:16px solid transparent;
    border-right:16px solid transparent;
    border-top:32px solid #ef4444;
  }

      .card{
        border-radius: 1rem;
        box-shadow: 0 10px 24px rgba(15,23,42,0.14);
      }

      .page-stack-mobile{
        padding-top: 1rem;
        padding-bottom: 2.5rem;
        row-gap: 1.25rem;
      }
      .mobile-desc{
        display: none;
      }

      .wheel-container {
        width: 280px;
        height: 280px;
      }

      .wheel-center-button {
        width: 72px;
        height: 72px;
        font-size: 14px;
      }
}
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- HEADER -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200/60">
    <div class="wrap px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
      <a href="/" class="flex items-center gap-2">
        <div class="h-9 w-9 rounded-2xl overflow-hidden bg-white shadow-md flex items-center justify-center">
          <img src="/assets/logo.png" alt="PolyTalky" class="h-full w-full object-cover">
        </div>
        <span class="font-semibold text-slate-900 text-lg">PolyTalky</span>
      </a>
      <nav class="hidden sm:flex items-center gap-5 text-sm text-slate-700">
        <a href="/courses/" class="hover:text-slate-900">–ö—É—Ä—Å—ã</a>
        <a href="/shop/" class="hover:text-slate-900">–ú–∞–≥–∞–∑–∏–Ω</a>
        <span class="font-semibold text-slate-900">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</span>
      </nav>
    </div>
  </header>

  <main class="flex-1">
    <div class="wrap px-4 sm:px-6 lg:px-8 py-6 sm:py-10 space-y-6 page-stack-mobile">

      <!-- PRO STATUS BANNERS -->
      <section id="pro-banner-success" class="pro-banner pro-banner--success">
        <div class="pro-banner__icon">‚òÖ</div>
        <div class="pro-banner__body">
          <h2>–£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ PRO</h2>
          <p id="pro-status-text">
            –¢–µ–ø–µ—Ä—å –≤–∞—à–∏ –∑–∞–¥–∞–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –∫—É—Ä–∞—Ç–æ—Ä–æ–º, –∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –æ—Ç–≤–µ—Ç–∞—Ö –∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –ø—Ä–æ–≥—Ä–µ—Å—Å—É.
          </p>
        </div>

        <button type="button" id="pro-cancel-button" class="pro-banner__btn">
          –û—Ç–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
        </button>

        <button type="button" id="pro-renew-button" class="pro-banner__btn hidden">
          –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        </button>
      </section>

      <section id="pro-banner-error" class="pro-banner pro-banner--error">
        <div class="pro-banner__icon">!</div>
        <div class="pro-banner__body">
          <h2>–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞</h2>
          <p>–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ PRO. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.</p>
        </div>
      </section>

      <section id="pro-banner-cancel" class="pro-banner pro-banner--cancel">
        <div class="pro-banner__icon">‚èπ</div>
        <div class="pro-banner__body">
          <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ</h2>
          <p>–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –µ—ë –∑–∞–≤–µ—Ä—à–∏—Ç—å, –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –æ—Ç–º–µ–Ω—É.</p>
        </div>
        <button type="button" id="pro-cancel-button-2" class="pro-banner__btn">
          –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        </button>
      </section>

      <!-- HERO / AUTH CARD -->
      <section class="card p-5 sm:p-7 space-y-5">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-5">
          <div class="space-y-2 max-w-xl">
            <p class="text-xs font-semibold tracking-[.2em] uppercase text-amber-700">
              –í–∞—à —É–≥–æ–ª–æ–∫ –≤ PolyTalky
            </p>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">
              –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç <span class="text-amber-600">—è–∑—ã–∫–æ–≤–æ–≥–æ –≥–µ—Ä–æ—è</span>
            </h1>
            <p class="text-sm sm:text-base text-slate-600 mobile-desc">
              –ó–¥–µ—Å—å –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤—Å–µ –≤–∞—à–∏ –∫—É—Ä—Å—ã, –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ—é –ª–∏—á–Ω—É—é –∫–∞—Ä—Ç—É –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ –º–∏—Ä–µ —è–∑—ã–∫–æ–≤.
            </p>
          </div>
          <div class="w-full max-w-sm mx-auto">
            <div id="auth-when-logged-out" class="space-y-4">
              <div class="soft-card p-4 space-y-3">
                <p class="text-xs font-semibold text-slate-700 uppercase tracking-[.18em]">
                  –í–æ–π—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç
                </p>
                <p class="text-sm text-slate-600">
                  –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ email, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∫–∞–∑—ã–≤–∞–ª–∏ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∫—É—Ä—Å–æ–≤ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ PolyTalky.
                </p>
                <p class="text-xs text-slate-500">
                  –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –º—ã –ø–æ–∫–∞–∂–µ–º –≤—Å–µ –≤–∞—à–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.
                </p>
              </div>
              <form id="auth-form" class="space-y-3">
                <div>
                  <label for="auth-email" class="block text-xs font-medium text-slate-600 mb-1">
                    Email
                  </label>
                  <input
                    id="auth-email"
                    type="email"
                    autocomplete="email"
                    required
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400"
                    placeholder="you@example.com"
                  />
                </div>

                <div>
                  <label for="auth-pass" class="block text-xs font-medium text-slate-600 mb-1">
                    –ü–∞—Ä–æ–ª—å
                  </label>
                  <input
                    id="auth-pass"
                    type="password"
                    autocomplete="current-password"
                    required
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400"
                    placeholder="–ü–∞—Ä–æ–ª—å"
                  />
                </div>

                <div id="auth-forgot-row" class="flex justify-end">
                  <button
                    type="button"
                    id="auth-forgot"
                    class="text-xs text-slate-500 hover:text-amber-600 underline underline-offset-2"
                  >
                    –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?
                  </button>
                </div>

                <div class="hidden">
                  <label for="auth-website" class="block text-xs font-medium text-slate-600 mb-1">
                    –°–∞–π—Ç
                  </label>
                  <input
                    id="auth-website"
                    name="website"
                    type="text"
                    autocomplete="off"
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm"
                  />
                </div>

                <div id="auth-names-block" class="space-y-3 hidden">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label for="auth-first" class="block text-xs font-medium text-slate-600 mb-1">
                        –ò–º—è
                      </label>
                      <input
                        id="auth-first"
                        type="text"
                        class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400"
                        placeholder="–ò–º—è"
                      />
                    </div>
                    <div>
                      <label for="auth-last" class="block text-xs font-medium text-slate-600 mb-1">
                        –§–∞–º–∏–ª–∏—è
                      </label>
                      <input
                        id="auth-last"
                        type="text"
                        class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400"
                        placeholder="–§–∞–º–∏–ª–∏—è (–∏–ª–∏ –Ω–∏–∫)"
                      />
                    </div>
                  </div>
                  <p class="text-[11px] text-slate-500">
                    –ó–∞–ø–æ–ª–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –º—ã –∑–Ω–∞–ª–∏, –∫–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è
                  </p>
                </div>

                <div id="auth-terms-block" class="space-y-2 text-[11px] text-slate-500 hidden">
                  <label class="flex items-start gap-2">
                    <input
                      id="auth-accept-terms"
                      type="checkbox"
                      class="mt-0.5 h-3 w-3 flex-shrink-0"
                    >
                    <span>
                      –°–æ–∑–¥–∞–≤–∞—è –∞–∫–∫–∞—É–Ω—Ç, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å –∏
                      —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å
                      <a href="/legal/terms.html" class="underline">–£—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a>,
                      <a href="/legal/privacy.html" class="underline">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>,
                      <a href="/legal/cookies.html" class="underline">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è cookies</a>
                      –∏
                      <a href="/legal/consent.html" class="underline">–°–æ–≥–ª–∞—Å–∏–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a>.
                    </span>
                  </label>
                  <p>
                    –ß—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≥–∞–ª–æ—á–∫–æ–π, —á—Ç–æ –≤—ã —Å–æ–≥–ª–∞—Å–Ω—ã —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏.
                  </p>
                </div>

                <p id="auth-error" class="text-xs text-red-500 min-h-[1rem]"></p>

                <div class="flex flex-col sm:flex-row gap-2 pt-1">
                  <button id="btn-login" type="button" class="btn btn-main flex-1 justify-center text-sm">
                    –í–æ–π—Ç–∏
                  </button>
                  <button id="auth-register" type="button" class="btn btn-ghost flex-1 justify-center text-sm">
                    –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                  </button>
                </div>
              </form>
            </div>

            <div id="auth-when-logged-in" class="hidden space-y-4">
              <div class="soft-card p-4 space-y-3">
                <p class="text-xs font-semibold text-slate-700 uppercase tracking-[.18em]">
                  –í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã
                </p>
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-full overflow-hidden bg-slate-200 flex-shrink-0 cursor-pointer" id="profile-avatar-wrapper">
                    <img id="profile-avatar-img" src="/assets/avatarf.png" alt="Avatar" class="h-full w-full object-cover">
                  </div>
                  <div class="min-w-0">
                    <div class="flex items-center gap-2">
                      <p id="profile-name" class="text-sm font-semibold text-slate-900 truncate">
                        –ö–†–£–¢–ò–ú
                      </p>

                      <button
                        type="button"
                        id="pro-chip"
                        class="inline-flex items-center px-2 py-[2px] rounded-full bg-emerald-100 text-emerald-700 text-[10px] font-semibold uppercase tracking-[.16em] border border-emerald-200 shadow-[0_0_0_1px_rgba(16,185,129,.2)] transform transition hover:-translate-y-0.5 hover:shadow-md hidden"
                      >
                        PRO
                      </button>
                    </div>

                    <p id="auth-user-email" class="text-xs text-slate-500 truncate">
                      ...
                    </p>
                  </div>
                </div>
                <p class="text-xs text-slate-500">
                  –≠—Ç–æ –≤–∞—à –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç PolyTalky. –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫—É—Ä—Å–∞–º–∏, –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å–æ–±–∏—Ä–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.
                </p>
              </div>

              <div class="flex flex-col sm:flex-row gap-2">
                <button id="btn-open-profile" class="btn btn-ghost flex-1 text-xs sm:text-sm">
                  –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
                </button>
                <button id="auth-logout" class="btn btn-main flex-1 text-xs sm:text-sm">
                  –í—ã–π—Ç–∏
                </button>
              </div>

              <!-- –ö–û–ò–ù–´ -->
              <div id="coins-card" class="soft-card p-3 sm:p-4 space-y-2 hidden">
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2">
                    <div class="h-7 w-7 rounded-full bg-amber-50 border border-amber-200 flex items-center justify-center overflow-hidden">
                      <img
                        src="/assets/coin.png"
                        alt="–ö–æ–∏–Ω PolyTalky"
                        class="h-6 w-6 object-contain"
                      />
                    </div>
                    <div>
                      <p class="text-xs font-semibold text-slate-700 uppercase tracking-[.18em]">
                        –í–∞—à–∏ –∫–æ–∏–Ω—ã
                      </p>
                      <p class="text-sm text-slate-900">
                        –ë–∞–ª–∞–Ω—Å: <span id="coins-balance">0</span>
                      </p>
                    </div>
                  </div>
                </div>
                <p id="coins-text" class="text-[11px] text-slate-600">
                  –ó–∞—Ö–æ–¥–∏—Ç–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –±–æ–ª—å—à–µ –∫–æ–∏–Ω–æ–≤ –∏ –º–µ–Ω—è—Ç—å –∏—Ö –Ω–∞ –±–æ–Ω—É—Å—ã.
                </p>
                <button id="coins-claim-btn" class="btn btn-main w-full text-xs sm:text-sm">
                  –ó–∞–±—Ä–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- –ö–£–†–°–´ + –î–û–°–¢–ò–ñ–ï–ù–ò–Ø -->
      <section class="grid gap-6 lg:grid-cols-[minmax(0,3fr)_minmax(0,2fr)] items-start">
        <!-- –ö–£–†–°–´ -->
        <div class="space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div class="space-y-1">
              <p class="pill-label">–í–∞—à–∏ –∫—É—Ä—Å—ã</p>
              <h2 class="text-lg sm:text-xl font-semibold text-slate-900">
                –í—Å–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –∫—É—Ä—Å—ã
              </h2>
              <p class="text-xs sm:text-sm text-slate-600 mobile-desc">
                –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –∫—É—Ä—Å—ã, –∫—É–ø–ª–µ–Ω–Ω—ã–µ –≤ <a href="/shop/" class="underline">–º–∞–≥–∞–∑–∏–Ω–µ</a>, –∞ —Ç–∞–∫–∂–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –ø—Ä–æ—à–ª–∏ —Ö–æ—Ç—è –±—ã –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫.
              </p>
            </div>
          </div>

          <div id="courses-need-auth" class="soft-card p-4 text-xs sm:text-sm text-slate-600">
            –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –∫—É—Ä—Å–æ–≤ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å.
          </div>

          <div id="courses-empty" class="soft-card p-4 text-xs sm:text-sm text-slate-600 hidden">
            –ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –≤
            <a href="/shop/" class="underline">–º–∞–≥–∞–∑–∏–Ω</a>, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫—É—Ä—Å, –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö
            <a href="/courses/" class="underline">–º–∏–Ω–∏-–∫—É—Ä—Å–æ–≤</a>.
          </div>

          <div id="courses-list" class="grid gap-3 sm:gap-4 md:grid-cols-2">
            <!-- –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—É—Ä—Å–æ–≤ -->
          </div>
        </div>

        <!-- –î–û–°–¢–ò–ñ–ï–ù–ò–Ø -->
        <div class="space-y-3">
          <div class="space-y-1">
            <p class="pill-label">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</p>
            <h2 class="text-lg sm:text-xl font-semibold text-slate-900">
              –ë–µ–π–¥–∂–∏, –º–µ–¥–∞–ª–∏ –∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã
            </h2>
            <p class="text-xs sm:text-sm text-slate-600 mobile-desc">
              –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤–∞—à–∏ –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ —É—Ä–æ–∫–∏, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –∏ –æ—Å–æ–±—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –°–º–æ–∂–µ—Ç–µ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ?
            </p>
          </div>
          <div id="achievements-list" class="grid gap-3 sm:gap-4">
            <!-- –º–µ–¥–∞–ª–∏ -->
          </div>
        </div>
      </section>

      <!-- –ú–û–î–ê–õ–ö–ê –ö–û–õ–õ–ï–ö–¶–ò–ò –ú–ï–î–ê–õ–ï–ô -->
      <div
        id="badges-modal"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-40"
      >
        <div class="card max-w-2xl w-full mx-4 p-4 sm:p-6 space-y-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs font-semibold tracking-[.18em] uppercase text-amber-700">
                –ö–æ–ª–ª–µ–∫—Ü–∏—è –º–µ–¥–∞–ª–µ–π
              </p>
              <p class="text-xs sm:text-sm text-slate-600">
                –í—Å–µ –≤–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ PolyTalky
              </p>
            </div>
            <button
              id="badges-modal-close"
              class="text-slate-400 hover:text-slate-600 text-xl leading-none"
            >
              √ó
            </button>
          </div>

          <div class="grid gap-3 sm:grid-cols-[minmax(0,2fr)_minmax(0,1.6fr)] items-start">
            <div
              id="badges-modal-grid"
              class="grid grid-cols-4 sm:grid-cols-5 gap-2 sm:gap-3 text-center text-[10px] sm:text-xs"
            >
              <!-- –≤—Å–µ –º–µ–¥–∞–ª–∏ -->
            </div>
            <div
              id="badges-modal-detail"
              class="soft-card p-3 sm:p-4 text-xs sm:text-sm text-slate-700"
            >
              <p class="font-semibold mb-1">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–¥–∞–ª—å</p>
              <p>
                –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –Ω–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ –ª—é–±—É—é –º–µ–¥–∞–ª—å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å, –∑–∞ —á—Ç–æ –æ–Ω–∞ –¥–∞—ë—Ç—Å—è.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- –ú–û–î–ê–õ–ö–ê –û–¢–ú–ï–ù–´ –ü–û–î–ü–ò–°–ö–ò PRO -->
      <div
        id="pro-cancel-modal"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-40"
      >
        <div class="card max-w-md w-full mx-4 p-5 sm:p-6 space-y-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs font-semibold tracking-[.18em] uppercase text-amber-700">
                –ü–æ–¥–ø–∏—Å–∫–∞ PRO
              </p>
              <h2 class="text-lg sm:text-xl font-bold text-slate-900 mt-1">
                –û—Ç–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ?
              </h2>
            </div>
            <button
              type="button"
              id="pro-cancel-modal-close"
              class="text-slate-400 hover:text-slate-600 text-xl leading-none"
            >
              √ó
            </button>
          </div>

          <p class="text-sm text-slate-600" id="pro-cancel-modal-text">
            –ú—ã –æ—Ç–∫–ª—é—á–∏–º –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ PRO. –î–æ—Å—Ç—É–ø –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º –¥–æ –∫–æ–Ω—Ü–∞ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.
          </p>

          <div class="text-xs text-slate-500" id="pro-cancel-modal-subtext">
            –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —ç—Ç–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –ø–ª–∞—Ç–µ–∂–∏ —Å–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–µ –±—É–¥—É—Ç, –∏ –≤—ã –±–æ–ª—å—à–µ –Ω–µ —Å–º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∫—É—Ä–∞—Ç–æ—Ä—É.
          </div>

          <div class="flex flex-col sm:flex-row sm:justify-end gap-2 pt-2">
            <button
              type="button"
              id="pro-cancel-modal-cancel"
              class="btn btn-ghost w-full sm:w-auto"
            >
              –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
            </button>
            <button
              type="button"
              id="pro-cancel-modal-confirm"
              class="btn w-full sm:w-auto"
            >
              –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
            </button>
          </div>
        </div>
      </div>

      <!-- –ú–û–î–ê–õ–ö–ê –ö–û–õ–ï–°–ê –£–î–ê–ß–ò -->
      <div
        id="wheel-modal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4"
      >
        <div class="card max-w-md w-full p-5 sm:p-6 space-y-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs font-semibold tracking-[.18em] uppercase text-amber-700">
                üéâ –î–µ–Ω—å 7 ‚Äî –ö–æ–ª–µ—Å–æ –£–¥–∞—á–∏
              </p>
              <h2 class="text-lg sm:text-xl font-bold text-slate-900 mt-1">
                –ö—Ä—É—Ç–∏—Ç–µ –∫–æ–ª–µ—Å–æ –∏ –ø–æ–ª—É—á–∏—Ç–µ –ø—Ä–∏–∑!
              </h2>
            </div>
          </div>

          <p class="text-sm text-slate-600">
            –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –∑–∞—Ö–æ–¥–∏–ª–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ —É–¥–∞—á–∏ –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Å–æ–±–µ–Ω–Ω—ã–π –ø—Ä–∏–∑ üéÅ
          </p>

          <div class="wheel-container">
            <div class="wheel-pointer"></div>
            <canvas id="wheel-canvas" class="wheel-canvas" width="360" height="360"></canvas>
            <button id="wheel-spin-btn" class="wheel-center-button">
              GO!
            </button>
          </div>

          <div id="wheel-result" class="hidden">
            <div class="soft-card p-4 text-center space-y-2">
              <div class="text-5xl mb-2" id="wheel-result-icon">üéâ</div>
              <p class="text-lg font-bold text-slate-900" id="wheel-result-title">
                –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!
              </p>
              <p class="text-sm text-slate-600" id="wheel-result-description">
                –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø—Ä–∏–∑!
              </p>
              <button id="wheel-claim-btn" class="btn btn-main w-full mt-3">
                –ó–∞–±—Ä–∞—Ç—å –ø—Ä–∏–∑
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- –ù–ê–°–¢–†–û–ô–ö–ò –ü–†–û–§–ò–õ–Ø -->
      <div id="profile-settings" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-40">
        <div class="card max-w-md w-full mx-4 p-5 sm:p-6 space-y-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs font-semibold tracking-[.18em] uppercase text-amber-700">
                –ü—Ä–æ—Ñ–∏–ª—å
              </p>
              <h2 class="text-lg sm:text-xl font-semibold text-slate-900">
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
              </h2>
              <p class="text-xs sm:text-sm text-slate-600">
                –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –Ω–∞–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –æ–ø—ã—Ç –∏, –≤ –±—É–¥—É—â–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±–æ–ª–µ–µ –Ω–∞–≥–ª—è–¥–Ω–æ.
              </p>
            </div>
            <button id="btn-close-profile" class="text-slate-400 hover:text-slate-600 text-xl leading-none">
              √ó
            </button>
          </div>

          <form id="profile-form" class="space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label for="profile-first" class="block text-xs font-medium text-slate-600 mb-1">
                  –ò–º—è
                </label>
                <input
                  id="profile-first"
                  name="firstName"
                  type="text"
                  class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400"
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ê–Ω–Ω–∞"
                />
              </div>
              <div>
                <label for="profile-last" class="block text-xs font-medium text-slate-600 mb-1">
                  –§–∞–º–∏–ª–∏—è
                </label>
                <input
                  id="profile-last"
                  name="lastName"
                  type="text"
                  class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400"
                  placeholder="–§–∞–º–∏–ª–∏—è (–∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º)"
                />
              </div>
              <!-- EMAIL (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è) -->
<div>
  <label for="profile-email" class="block text-xs font-medium text-slate-600 mb-1">
    Email
  </label>
  <input
    id="profile-email"
    type="email"
    readonly
    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-slate-50 text-slate-500"
    placeholder="you@example.com"
  />
  <p class="text-[11px] text-slate-500 mt-1">
    Email –±–µ—Ä—ë—Ç—Å—è –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫—É.
  </p>
</div>

<!-- –°–ú–ï–ù–ê –ü–ê–†–û–õ–Ø -->
<div class="pt-2 border-t border-slate-200/70">
  <p class="text-xs font-semibold tracking-[.18em] uppercase text-slate-600 mb-2">
    –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
  </p>

  <div class="space-y-2">
    <input
      id="pw-current"
      type="password"
      autocomplete="current-password"
      class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400"
      placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å"
    />
    <input
      id="pw-new"
      type="password"
      autocomplete="new-password"
      class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400"
      placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)"
    />
  </div>

  <div class="flex flex-col gap-2 mt-2">
  <button type="button" id="btn-change-password" class="btn btn-ghost w-full">
    –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
  </button>
  <button type="button" id="btn-reset-password" class="btn btn-ghost w-full">
    –ù–µ –ø–æ–º–Ω—é –ø–∞—Ä–æ–ª—å
  </button>
</div>

  <p id="pw-msg" class="text-xs text-slate-500 min-h-[1rem] mt-2"></p>
</div>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">
                –ê–≤–∞—Ç–∞—Ä –ø—Ä–æ—Ñ–∏–ª—è
              </label>
              <p class="text-[11px] text-slate-500 mb-2">
                –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤ PolyTalky.
              </p>
              <div class="flex gap-2">
                <button
                  type="button"
                  class="avatar-choice rounded-xl overflow-hidden border border-slate-200 bg-white p-1 ring-2 ring-amber-400"
                  data-avatar-type="girl"
                >
                  <img src="/assets/avatarf.png" alt="–ê–≤–∞—Ç–∞—Ä –¥–µ–≤–æ—á–∫–∞" class="h-10 w-10 object-cover rounded-lg">
                </button>
                <button
                  type="button"
                  class="avatar-choice rounded-xl overflow-hidden border border-slate-200 bg-white p-1"
                  data-avatar-type="boy"
                >
                  <img src="/assets/avatar.png" alt="–ê–≤–∞—Ç–∞—Ä –º–∞–ª—å—á–∏–∫" class="h-10 w-10 object-cover rounded-lg">
                </button>
              </div>
              <input type="hidden" id="profile-avatar-type" value="girl">
            </div>

            <p id="profile-msg" class="text-xs text-slate-500 min-h-[1rem]"></p>

            <div class="flex items-center justify-end gap-2 pt-2">
              <button type="button" id="btn-cancel-profile" class="btn btn-ghost text-xs sm:text-sm">
                –û—Ç–º–µ–Ω–∞
              </button>
              <button type="submit" class="btn btn-main text-xs sm:text-sm">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–≤–∞—Ç–∞—Ä–æ–≤ -->
      <div
        id="avatar-preview-modal"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-50"
      >
        <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 max-w-xs w-full mx-4 text-center">
          <img
            id="avatar-preview-img"
            src="/assets/avatarf.png"
            alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞"
            class="mx-auto h-32 w-32 sm:h-40 sm:w-40 rounded-2xl object-contain mb-3"
          />
          <button
            type="button"
            id="avatar-preview-close"
            class="btn btn-ghost text-xs sm:text-sm"
          >
            –ó–∞–∫—Ä—ã—Ç—å
          </button>
        </div>
      </div>

      <!-- COIN MODAL -->
      <div id="coin-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center z-40">
        <div class="card max-w-xs w-full mx-6 p-6 text-center space-y-3">
          <img
            src="/assets/coin.png"
            alt="PolyTalky-–∫–æ–∏–Ω"
            class="mx-auto mb-2 w-24 h-24"
          >
          <h3 class="text-lg font-extrabold mb-1">PolyTalky-–∫–æ–∏–Ω—ã</h3>
          <p class="text-sm text-[var(--ink-2)]">
            –ó–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞—Ö–æ–¥—ã –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–∏–Ω—ã. –°–∫–æ—Ä–æ –∏—Ö –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ–±–º–µ–Ω—è—Ç—å –Ω–∞ –ø–ª–∞—Ç–Ω—ã–µ –∫—É—Ä—Å—ã, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä—ã –∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.
          </p>
          <p class="text-xs text-slate-500 mt-1">
            –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <span id="coin-modal-balance">0</span> –∫–æ–∏–Ω–æ–≤.
          </p>
          <button
            id="coin-modal-close"
            type="button"
            class="btn btn-ghost px-4 py-2 mt-2"
          >
            –ü–æ–Ω—è—Ç–Ω–æ
          </button>
        </div>
      </div>

      <!-- COOKIE-BANNER -->
      <div id="cookie-banner" class="fixed bottom-3 inset-x-0 flex justify-center z-50 hidden">
        <div class="soft-card px-4 py-3 flex flex-col sm:flex-row items-start sm:items-center gap-2 text-xs sm:text-sm text-slate-700 max-w-xl mx-4">
          <p class="flex-1">
            –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—É–∫–∏, —á—Ç–æ–±—ã –≤–∞—à–∏ –ª–æ–≥–∏–Ω—ã –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫—É—Ä—Å–∞–º —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è. –ü—Ä–æ–¥–æ–ª–∂–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–∞–π—Ç–æ–º, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å
            <a href="/privacy/" class="underline">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>.
          </p>
          <button id="cookie-accept" class="btn btn-main text-xs sm:text-sm">
            –•–æ—Ä–æ—à–æ
          </button>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-t border-slate-200/70 bg-white/80">
    <div class="wrap px-4 sm:px-6 lg:px-8 py-4 flex flex-col sm:flex-row items-center justify-between gap-3 text-[11px] sm:text-xs text-slate-500">
      <p>¬© PolyTalky. –ö—É—Ä—Å—ã –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –ø–æ–ª–∏–≥–ª–æ—Ç–æ–≤.</p>
      <p class="flex items-center gap-3">
        <a href="/contacts/" class="hover:text-slate-700">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
        <span class="hidden sm:inline text-slate-400">‚Ä¢</span>
        <a href="/legal/" class="hover:text-slate-700">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</a>
      </p>
    </div>
  </footer>

  <!-- Firebase + –ª–æ–≥–∏–∫–∞ –∫–∞–±–∏–Ω–µ—Ç–∞ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBAU_uMTePpKwVNZNhqk2pss2PuSitGfQI",
      authDomain: "polytalky-70999.firebaseapp.com",
      projectId: "polytalky-70999",
      storageBucket: "polytalky-70999.firebasestorage.app",
      messagingSenderId: "62407152289",
      appId: "1:62407152289:web:b0c0efdb2472f12b10d6e0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const COURSE_META = {
      'polyglotpack-mchny': {
        title: 'PolyglotPack MCNHY',
        href: '/courses/mchny/',
        cover: '/assets/courses/mchny.jpg',
        comingSoon: true
      },
     
      'english-intro': {
        title: '–ò–Ω—Ç–µ–Ω—Å–∏–≤ –ø–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É',
        href: '/courses/english-intro/',
        cover: '/assets/courses/english.jpg'
      }
    };

    const FIRST_STEP_BADGE_ID = 'first-step';

    // –ü–†–ò–ó–´ –î–õ–Ø –ö–û–õ–ï–°–ê –£–î–ê–ß–ò
    const WHEEL_PRIZES = [
      { id: 'coins-5', label: '5 –∫–æ–∏–Ω–æ–≤', color: '#fbbf24', image: '/assets/coin.png', coins: 5, weight: 40 },
      { id: 'coins-10', label: '10 –∫–æ–∏–Ω–æ–≤', color: '#f59e0b', image: '/assets/all/coin10.png', coins: 10, weight: 30 },
      { id: 'coins-15', label: '15 –∫–æ–∏–Ω–æ–≤', color: '#fbbf24', image: '/assets/all/coin15.png', coins: 15, weight: 22 },
      { id: 'coins-25', label: '25 –∫–æ–∏–Ω–æ–≤', color: '#f59e0b', image: '/assets/all/coin25.png', coins: 25, weight: 14 },
      { id: 'coins-50', label: '50 –∫–æ–∏–Ω–æ–≤', color: '#fbbf24', image: '/assets/all/coin50.png', coins: 50, weight: 10 },
      { id: 'secret-badge', label: '–°–µ–∫—Ä–µ—Ç–Ω—ã–π –±–µ–π–¥–∂', color: '#f59e0b', image: '/assets/badges/badgewheel.png', badge: 'wheel-secret', weight: 6 },
      { id: 'secret-avatar', label: '–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∞–≤–∞—Ç–∞—Ä', color: '#fbbf24', image: '/assets/all/avatarwheel.PNG', avatar: 'secret', weight: 6 },
      { id: 'pro-month', label: '–ú–µ—Å—è—Ü PRO', color: '#f59e0b', image: '/assets/all/pro.png', proMonth: true, weight: 1 },
      { id: 'course-mchny', label: '–ö—É—Ä—Å MCHNY', color: '#fbbf24', image: '/assets/all/mchny.png', course: 'mchny-course', weight: 1 }
    ];
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const authBoxOut      = document.getElementById('auth-when-logged-out');
      const authBoxIn       = document.getElementById('auth-when-logged-in');
      const authEmailEl     = document.getElementById('auth-email');
      const authPassEl      = document.getElementById('auth-pass');
      const authFirstEl     = document.getElementById('auth-first');
      const authLastEl      = document.getElementById('auth-last');
      const honeypotEl      = document.getElementById('auth-website');
      const authForm        = document.getElementById('auth-form');
      const authRegister    = document.getElementById('auth-register');
      const btnLogin        = document.getElementById('btn-login');
      const authError       = document.getElementById('auth-error');
      const authForgot      = document.getElementById('auth-forgot');
      const authLogout      = document.getElementById('auth-logout');
      const authUserEmail   = document.getElementById('auth-user-email');
      const authAcceptTerms = document.getElementById('auth-accept-terms');
      const authForgotRow   = document.getElementById('auth-forgot-row');
      const authNamesBlock  = document.getElementById('auth-names-block');
      const authTermsBlock  = document.getElementById('auth-terms-block');

      const profileAvatarWrapper = document.getElementById('profile-avatar-wrapper');
      const profileAvatarImg= document.getElementById('profile-avatar-img');
      const profileName     = document.getElementById('profile-name');
      const profileSettings = document.getElementById('profile-settings');
      const profileForm     = document.getElementById('profile-form');
      const profileFirst    = document.getElementById('profile-first');
      const profileLast     = document.getElementById('profile-last');
      const profileMsg      = document.getElementById('profile-msg');
      const profileAvatarType = document.getElementById('profile-avatar-type');
      const avatarChoiceButtons = document.querySelectorAll('.avatar-choice');
      const proChip          = document.getElementById('pro-chip');
      const profileEmail = document.getElementById('profile-email');

const pwCurrent = document.getElementById('pw-current');
const pwNew = document.getElementById('pw-new');
const pwMsg = document.getElementById('pw-msg');
const btnChangePassword = document.getElementById('btn-change-password');
const btnResetPassword = document.getElementById('btn-reset-password');

      const avatarPreviewModal = document.getElementById('avatar-preview-modal');
      const avatarPreviewImg   = document.getElementById('avatar-preview-img');
      const avatarPreviewClose = document.getElementById('avatar-preview-close');
      
      const coursesNeedAuth = document.getElementById('courses-need-auth');
      const coursesList     = document.getElementById('courses-list');
      const coursesEmpty    = document.getElementById('courses-empty');
      const achievementsList= document.getElementById('achievements-list');

      const badgesModal       = document.getElementById('badges-modal');
      const badgesModalClose  = document.getElementById('badges-modal-close');
      const badgesModalGrid   = document.getElementById('badges-modal-grid');
      const badgesModalDetail = document.getElementById('badges-modal-detail');

      const cookieBanner    = document.getElementById('cookie-banner');
      const cookieAccept    = document.getElementById('cookie-accept');

      const proBannerSuccess = document.getElementById('pro-banner-success');
      const proBannerError   = document.getElementById('pro-banner-error');
      const proBannerCancel  = document.getElementById('pro-banner-cancel');
      const proCancelButton  = document.getElementById('pro-cancel-button');
      const proStatusText   = document.getElementById('pro-status-text');
      const proRenewButton  = document.getElementById('pro-renew-button');

      const coinsCard       = document.getElementById('coins-card');
      const coinsBalanceEl  = document.getElementById('coins-balance');
      const coinsTextEl     = document.getElementById('coins-text');
      const coinsClaimBtn   = document.getElementById('coins-claim-btn');

      const coinModal       = document.getElementById('coin-modal');
      const coinModalClose  = document.getElementById('coin-modal-close');
      const coinModalBalance= document.getElementById('coin-modal-balance');

      // –ö–û–õ–ï–°–û –£–î–ê–ß–ò
      const wheelModal      = document.getElementById('wheel-modal');
      const wheelCanvas     = document.getElementById('wheel-canvas');
      const wheelSpinBtn    = document.getElementById('wheel-spin-btn');
      const wheelResult     = document.getElementById('wheel-result');
      const wheelResultIcon = document.getElementById('wheel-result-icon');
      const wheelResultTitle= document.getElementById('wheel-result-title');
      const wheelResultDesc = document.getElementById('wheel-result-description');
      const wheelClaimBtn   = document.getElementById('wheel-claim-btn');

      let wheelOrder = []; // –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–µ–∫—Ç–æ—Ä–æ–≤ (–ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–π)

      if (wheelModal) {
  wheelModal.addEventListener('click', (e) => {
    if (e.target === wheelModal) {
      wheelModal.classList.add('hidden');
      wheelModal.classList.remove('flex');
    }
  });
}
      
function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function initWheelOrder(){
  wheelOrder = shuffle([...WHEEL_PRIZES]); // –º–æ–Ω–µ—Ç—ã –ø–µ—Ä–µ–º–µ—à–∞—é—Ç—Å—è —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º
}
      function pickWeightedIndex(list){
  const total = list.reduce((s,p)=> s + (Number(p.weight)||1), 0);
  let r = Math.random() * total;

  for (let i=0; i<list.length; i++){
    r -= (Number(list[i].weight)||1);
    if (r <= 0) return i;
  }
  return list.length - 1;
}
      let coinsState = {
        balance: 0,
        streak: 0,
        lastDate: null,
        alreadyClaimedToday: false,
        mode: null,
        nextReward: 0
      };

      let allBadgesCache = [];
      let currentWheelPrize = null;
      let wheelRotation = 0;
      let isSpinning = false;

      function todayStr() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      }

      function pluralizeCoin(n) {
        n = Math.abs(n) % 100;
        const n1 = n % 10;
        if (n > 10 && n < 20) return "–∫–æ–∏–Ω–æ–≤";
        if (n1 === 1) return "–∫–æ–∏–Ω";
        if (n1 >= 2 && n1 <= 4) return "–∫–æ–∏–Ω–∞";
        return "–∫–æ–∏–Ω–æ–≤";
      }

      // ============================================
      // –ö–û–õ–ï–°–û –£–î–ê–ß–ò: –õ–û–ì–ò–ö–ê –ò –ê–ù–ò–ú–ê–¶–ò–Ø
      // ============================================

const wheelImgCache = new Map();

function loadWheelImagesOnce(list) {
  const tasks = list.map(p => new Promise((resolve) => {
    if (!p.image) return resolve();
    if (wheelImgCache.has(p.image)) return resolve();
    const img = new Image();
    img.onload = () => { wheelImgCache.set(p.image, img); resolve(); };
    img.onerror = () => resolve();
    img.src = p.image;
  }));
  return Promise.all(tasks);
}

function drawWheel(){
  if (!wheelCanvas) return;

  const ctx = wheelCanvas.getContext('2d');
  const w = wheelCanvas.width;
  const h = wheelCanvas.height;
  const cx = w/2, cy = h/2;
  const r = w/2;

  ctx.clearRect(0,0,w,h);

  const list = (wheelOrder && wheelOrder.length) ? wheelOrder : WHEEL_PRIZES;
  const slice = (2*Math.PI)/list.length;

   list.forEach((prize, i) => {
  const a0 = i * slice;
  const a1 = a0 + slice;

  // —Å–µ–∫—Ç–æ—Ä
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.arc(cx, cy, r - 4, a0, a1);
  ctx.closePath();

  const DARK  = '#f59e0b';
  const LIGHT = '#fbbf24';
  ctx.fillStyle = (i % 2 === 0) ? DARK : LIGHT;
  ctx.fill();

  // —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
  ctx.strokeStyle = 'rgba(255,255,255,.85)';
  ctx.lineWidth = 2;
  ctx.stroke();

  // –∏–∫–æ–Ω–∫–∞
  const mid = a0 + slice / 2;
  const iconRadius = r * 0.74;

    const img = prize.image ? wheelImgCache.get(prize.image) : null;

  const ICON = 68; // –º–æ–∂–Ω–æ 72 –µ—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è –µ—â—ë –±–æ–ª—å—à–µ
  const HALF = ICON / 2;
const ix = cx + Math.cos(mid) * iconRadius;
  const iy = cy + Math.sin(mid) * iconRadius;
     
  ctx.save();
  ctx.translate(ix, iy);
  ctx.rotate(mid + Math.PI / 2);

  if (img) {
    ctx.drawImage(img, -HALF, -HALF, ICON, ICON);
  }

  ctx.restore();
});
}
        
     function spinWheel() {
  if (isSpinning) return;

  isSpinning = true;

  // —Å–ø–∏—Å–æ–∫ —Å–µ–∫—Ç–æ—Ä–æ–≤ (–≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫), –ù–ï –º–µ–Ω—è–µ–º –¥–ª–∏–Ω—É => —Å–µ–∫—Ç–æ—Ä–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
  const list = (wheelOrder && wheelOrder.length) ? wheelOrder : WHEEL_PRIZES;

  // –≤—ã–±–∏—Ä–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–µ–∫—Ç–æ—Ä –ø–æ –≤–µ—Å–∞–º (weight)
  const prizeIndex = pickWeightedIndex(list);
  const prize = list[prizeIndex];
  currentWheelPrize = prize;
       const sliceAngle = 360 / list.length;
const prizeAngle = prizeIndex * sliceAngle + sliceAngle / 2;

  // —É–∫–∞–∑–∞—Ç–µ–ª—å —Å–≤–µ—Ä—Ö—É = 270¬∞ (–∏–ª–∏ -90¬∞)
const POINTER_ANGLE = 270;

// –Ω–∞ —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–æ–∫—Ä—É—Ç–∏—Ç—å, —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä –Ω—É–∂–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞ –ø–æ–ø–∞–ª –ø–æ–¥ —Å—Ç—Ä–µ–ª–∫—É
let align = POINTER_ANGLE - prizeAngle;
align = (align % 360 + 360) % 360; // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è 0..359

const fullSpins = 5 + Math.floor(Math.random() * 3); // 5, 6 –∏–ª–∏ 7 –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤ (—Ü–µ–ª–æ–µ!)
const jitter = (Math.random() - 0.5) * (sliceAngle * 0.25); // –Ω–µ–±–æ–ª—å—à–æ–π —Ä–∞–∑–±—Ä–æ—Å –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ç–æ—Ä–∞
const targetRotation = 360 * fullSpins + align + jitter;

  const duration = 5000;
  const startTime = Date.now();
  const startRotation = wheelRotation;

  wheelSpinBtn.classList.add('spinning');
  wheelSpinBtn.textContent = '...';

  function animate() {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / duration, 1);

    const easeOut = 1 - Math.pow(1 - progress, 4);
    wheelRotation = startRotation + targetRotation * easeOut;

    wheelCanvas.style.transform = `rotate(${wheelRotation}deg)`;

    if (progress < 1) {
      requestAnimationFrame(animate);
    } else {
      isSpinning = false;
      showWheelResult(prize);
      // createConfetti(); // –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å ‚Äî –º–æ–∂–Ω–æ, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ
      wheelSpinBtn.classList.remove('spinning');
      wheelSpinBtn.textContent = 'GO!';
    }
  }

  animate();
}
      function showWheelResult(prize) {
        wheelResultIcon.innerHTML = `<img src="${prize.image}" alt="" class="mx-auto w-16 h-16 object-contain">`;
        wheelResultTitle.textContent = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${prize.label}!`;

        let description = '';
        if (prize.coins) {
          description = `${prize.coins} ${pluralizeCoin(prize.coins)} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤–∞—à —Å—á—ë—Ç.`;
        } else if (prize.badge) {
          description = '–°–µ–∫—Ä–µ—Ç–Ω—ã–π –±–µ–π–¥–∂ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à—É –∫–æ–ª–ª–µ–∫—Ü–∏—é!';
        } else if (prize.avatar) {
          description = '–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∞–≤–∞—Ç–∞—Ä —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è!';
        } else if (prize.proMonth) {
          description = '–ú–µ—Å—è—Ü –ø–æ–¥–ø–∏—Å–∫–∏ PRO –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!';
        } else if (prize.course) {
          description = '–ö—É—Ä—Å MCHNY –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç!';
        }

        wheelResultDesc.textContent = description;
        wheelResult.classList.remove('hidden');
      }

      function createConfetti() {
        const colors = ['#fbbf24', '#f59e0b', '#ef4444', '#10b981', '#3b82f6', '#8b5cf6'];
        for (let i = 0; i < 50; i++) {
          setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            document.body.appendChild(confetti);

            setTimeout(() => confetti.remove(), 3000);
          }, i * 30);
        }
      }

      async function claimWheelPrize() {
        const user = auth.currentUser;
        if (!user || !currentWheelPrize) return;

        const email = user.email;
        if (!email) return;

        const docRef = db.collection('users').doc(email);
        const today = todayStr();

        try {
          const updates = {
            lastCoinDate: today,
            coinStreak: 0 // —Å–±—Ä–æ—Å —Å—Ç—Ä–∏–∫–∞ –ø–æ—Å–ª–µ –∫–æ–ª–µ—Å–∞
          };

          // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—É
          if (currentWheelPrize.coins) {
            const newBalance = coinsState.balance + currentWheelPrize.coins;
            updates.coinsBalance = newBalance;
            coinsState.balance = newBalance;
          }

          if (currentWheelPrize.badge) {
            updates.badges = firebase.firestore.FieldValue.arrayUnion(currentWheelPrize.badge);
          }

          if (currentWheelPrize.avatar) {
            updates.secretAvatars = firebase.firestore.FieldValue.arrayUnion(currentWheelPrize.avatar);
          }

          if (currentWheelPrize.proMonth) {
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –º–µ—Å—è—Ü PRO
            const validUntil = new Date();
            validUntil.setMonth(validUntil.getMonth() + 1);
            updates.proGlobal = true;
            updates.proValidUntil = firebase.firestore.Timestamp.fromDate(validUntil);
          }

          if (currentWheelPrize.course) {
            updates.courses = firebase.firestore.FieldValue.arrayUnion(currentWheelPrize.course);
          }

          await docRef.set(updates, { merge: true });

          // –û–±–Ω–æ–≤–ª—è–µ–º UI
          coinsState.streak = 0;
          coinsState.lastDate = today;
          coinsState.alreadyClaimedToday = true;

          updateCoinsUI({
            coinsBalance: coinsState.balance,
            coinStreak: 0,
            lastCoinDate: today
          });

          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
          wheelModal.classList.add('hidden');
          wheelModal.classList.remove('flex');

          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–µ–π/–∫—É—Ä—Å–æ–≤/PRO
          if (user) {
            await loadUserProfile(user);
            await loadUserEnrollments(user);
            await loadProStatus(user);
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–∏–∑–∞:', err);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        }
      }

      // –°–æ–±—ã—Ç–∏—è –¥–ª—è –∫–æ–ª–µ—Å–∞
      if (wheelSpinBtn) {
        wheelSpinBtn.addEventListener('click', () => {
          if (!isSpinning) spinWheel();
          
        });
      }

      if (wheelClaimBtn) {
        wheelClaimBtn.addEventListener('click', claimWheelPrize);
      }

      // –†–∏—Å—É–µ–º –∫–æ–ª–µ—Å–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      if (wheelCanvas) {
        initWheelOrder();
  loadWheelImagesOnce(wheelOrder).then(drawWheel);
}

      // ============================================
      // –ö–û–ò–ù–´: –û–ë–ù–û–í–õ–ï–ù–ò–ï UI
      // ============================================

      function updateCoinsUI(userData) {
        if (!coinsCard || !coinsBalanceEl || !coinsTextEl || !coinsClaimBtn) return;

        const balance = typeof userData.coinsBalance === 'number' ? userData.coinsBalance : 0;
        let streak    = typeof userData.coinStreak   === 'number' ? userData.coinStreak   : 0;
        const last    = userData.lastCoinDate || null;
        const today   = todayStr();

        let already = false;

        if (last) {
          if (last === today) {
            already = true;
          } else {
            try {
              const lastDate  = new Date(last  + 'T00:00:00');
              const todayDate = new Date(today + 'T00:00:00');
              const diffMs    = todayDate - lastDate;
              const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
              if (diffDays > 1) {
                streak = 0;
              }
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ lastCoinDate', last, e);
              streak = 0;
            }
          }
        }

        coinsState.balance = balance;
        coinsState.streak  = streak;
        coinsState.lastDate= last;
        coinsState.alreadyClaimedToday = already;
        coinsState.mode = null;
        coinsState.nextReward = 0;

        coinsCard.classList.remove('hidden');
        coinsBalanceEl.textContent = balance;
        if (coinModalBalance) {
          coinModalBalance.textContent = balance;
        }

        coinsClaimBtn.disabled = false;
        coinsClaimBtn.classList.remove('opacity-60','cursor-default');

        if (already) {
          coinsTextEl.textContent = '–ë–æ–Ω—É—Å –∑–∞ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –ø–æ–ª—É—á–µ–Ω, –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞ üíõ';
          coinsClaimBtn.textContent = '–ë–æ–Ω—É—Å —É–∂–µ –∑–∞–±—Ä–∞–Ω';
          coinsClaimBtn.disabled = true;
          coinsClaimBtn.classList.add('opacity-60','cursor-default');
          coinsState.mode = null;
          return;
        }

        // –ï—â—ë –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ –±–æ–Ω—É—Å —Å–µ–≥–æ–¥–Ω—è
        if (streak >= 6) {
          // 7-–π –¥–µ–Ω—å: –∫–æ–ª–µ—Å–æ —É–¥–∞—á–∏
          coinsTextEl.textContent = '–°–µ–≥–æ–¥–Ω—è 7-–π –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥! –†–∞—Å–∫—Ä—É—Ç–∏—Ç–µ –∫–æ–ª–µ—Å–æ —É–¥–∞—á–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Å–æ–±–µ–Ω–Ω—ã–π –ø—Ä–∏–∑ üé°';
          coinsClaimBtn.textContent = '–ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ üé°';
          coinsState.mode = 'wheel';
          coinsState.nextReward = 0;
        } else {
          // –û–±—ã—á–Ω—ã–π –¥–µ–Ω—å: 1‚Äì6 –∫–æ–∏–Ω–æ–≤
          const reward = Math.min(streak + 1, 6);
          coinsState.mode = 'daily';
          coinsState.nextReward = reward;

          if (streak === 0 && balance === 0) {
            coinsTextEl.textContent = '–°–µ–≥–æ–¥–Ω—è –ø–æ–ª—É—á–∏—Ç–µ 1 –∫–æ–∏–Ω –∑–∞ –≤—Ö–æ–¥. –ö–æ–∏–Ω—ã ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞ PolyTalky. –°–∫–æ—Ä–æ –∏—Ö –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ–±–º–µ–Ω—è—Ç—å –Ω–∞ –ø–ª–∞—Ç–Ω—ã–µ –∫—É—Ä—Å—ã, –∞–≤–∞—Ç–∞—Ä—ã –∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.';
          } else {
            coinsTextEl.textContent = `–°–µ–≥–æ–¥–Ω—è –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–∞—Ç—å ${reward} ${pluralizeCoin(reward)} –∑–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—Ö–æ–¥. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∑–∞—Ö–æ–¥–∏—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –¥–æ–π—Ç–∏ –¥–æ –∫–æ–ª–µ—Å–∞ —É–¥–∞—á–∏!`;
          }
          coinsClaimBtn.textContent = `–ó–∞–±—Ä–∞—Ç—å ${reward} ${pluralizeCoin(reward)}`;
        }
      }

      // –ö–û–ò–ù–´: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ ¬´–∑–∞–±—Ä–∞—Ç—å¬ª
      if (coinsClaimBtn) {
        coinsClaimBtn.addEventListener('click', async () => {
          const user = auth.currentUser;
          if (!user) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –∫–æ–∏–Ω—ã.');
            return;
          }
          if (coinsState.alreadyClaimedToday) {
            return;
          }
          if (!coinsState.mode) {
            return;
          }

          const email = user.email;
          if (!email) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
            return;
          }

          if (coinsState.mode === 'wheel') {
           wheelModal.classList.remove('hidden');
wheelModal.classList.add('flex');
wheelResult.classList.add('hidden');

isSpinning = false;
currentWheelPrize = null;

wheelRotation = 0;
wheelCanvas.style.transform = 'rotate(0deg)';

initWheelOrder();
loadWheelImagesOnce(wheelOrder).then(drawWheel);
return;
          }

          const docRef = db.collection('users').doc(email);
          const today  = todayStr();

          coinsClaimBtn.disabled = true;
          coinsClaimBtn.textContent = '–ü–æ–¥–æ–∂–¥–∏—Ç–µ...';
          coinsClaimBtn.classList.add('opacity-60','cursor-default');

          try {
            if (coinsState.mode === 'daily') {
              const reward = coinsState.nextReward || 1;
              const newBalance = coinsState.balance + reward;
              const newStreak  = Math.min(coinsState.streak + 1, 6);

              await docRef.set({
                coinsBalance: newBalance,
                coinStreak: newStreak,
                lastCoinDate: today
              }, { merge: true });

              coinsState.balance = newBalance;
              coinsState.streak  = newStreak;
              coinsState.lastDate= today;
              coinsState.alreadyClaimedToday = true;

              updateCoinsUI({
                coinsBalance: newBalance,
                coinStreak: newStreak,
                lastCoinDate: today
              });
              coinsTextEl.textContent = `–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${reward} ${pluralizeCoin(reward)} –∑–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –≤—Ö–æ–¥. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –∑–∞—Ö–æ–¥–∏—Ç–µ! üíõ`;
            }
          } catch (err) {
            console.error('coins error', err);
            coinsTextEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–∞—Ç—å –±–æ–Ω—É—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
            coinsClaimBtn.disabled = false;
            coinsClaimBtn.classList.remove('opacity-60','cursor-default');
            coinsClaimBtn.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å';
          }
        });
      }

      // –ö–ª–∏–∫ –ø–æ –º–∞–ª–µ–Ω—å–∫–æ–º—É –∫–æ–∏–Ω—É ‚Üí –º–æ–¥–∞–ª–∫–∞ —Å –±–æ–ª—å—à–∏–º
      (function setupCoinModal() {
        const coinImgSmall =
          document.querySelector('#coins-card img[src="/assets/coin.png"]') ||
          document.querySelector('#coins-card img');

        if (!coinImgSmall || !coinModal || !coinModalClose) return;

        coinImgSmall.classList.add('transition-transform','duration-200','cursor-pointer');

        const openCoinModal = () => {
          if (coinModalBalance) {
            coinModalBalance.textContent = coinsBalanceEl ? coinsBalanceEl.textContent : coinsState.balance;
          }
          coinModal.classList.remove('hidden');
          coinModal.classList.add('flex');

          coinImgSmall.classList.add('scale-110');
          setTimeout(() => {
            coinImgSmall.classList.remove('scale-110');
          }, 180);
        };

        const closeCoinModal = () => {
          coinModal.classList.add('hidden');
          coinModal.classList.remove('flex');
        };

        coinImgSmall.addEventListener('click', openCoinModal);
        coinModalClose.addEventListener('click', closeCoinModal);
        coinModal.addEventListener('click', (e) => {
          if (e.target === coinModal) closeCoinModal();
        });
      })();

      // ============================================
      // PRO –ü–ê–†–ê–ú–ï–¢–†
      // ============================================

      (function handleProParam() {
        const params = new URLSearchParams(window.location.search);
        const pro = params.get('pro');
        if (!pro) return;

        if (pro === 'success' && proBannerSuccess) {
          proBannerSuccess.style.display = 'flex';
        } else if (pro === 'error' && proBannerError) {
          proBannerError.style.display = 'flex';
        } else if (pro === 'cancel' && proBannerCancel) {
          proBannerCancel.style.display = 'flex';
        }

        if (proRenewButton) {
          proRenewButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
              alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.');
              return;
            }

            try {
              const resp = await fetch('/api/yookassa/create-pro-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  email: user.email || '',
                  userId: user.uid,
                }),
              });

              const data = await resp.json();

              if (!resp.ok || !data.confirmationUrl) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PRO-–ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ YooKassa:', data);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞ hello@polytalky.ru');
                return;
              }

              window.location.href = data.confirmationUrl;
            } catch (e) {
              console.error(e);
              alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞ hello@polytalky.ru');
            }
          });
        }

        params.delete('pro');
        const newSearch = params.toString();
        const newUrl = window.location.pathname + (newSearch ? '?' + newSearch : '') + window.location.hash;
        window.history.replaceState({}, '', newUrl);
      })();

      const proCancelModal      = document.getElementById('pro-cancel-modal');
      const proCancelModalClose = document.getElementById('pro-cancel-modal-close');
      const proCancelModalCancel = document.getElementById('pro-cancel-modal-cancel');
      const proCancelModalConfirm = document.getElementById('pro-cancel-modal-confirm');
      const proCancelModalText  = document.getElementById('pro-cancel-modal-text');

      function openProCancelModal(validUntilText) {
        if (validUntilText) {
          proCancelModalText.textContent =
            `–ú—ã –æ—Ç–∫–ª—é—á–∏–º –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ PRO. –î–æ—Å—Ç—É–ø –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º –¥–æ ${validUntilText}.`;
        } else {
          proCancelModalText.textContent =
            `–ú—ã –æ—Ç–∫–ª—é—á–∏–º –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ PRO. –î–æ—Å—Ç—É–ø –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º –¥–æ –∫–æ–Ω—Ü–∞ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.`;
        }
        proCancelModal.classList.remove('hidden');
        proCancelModal.classList.add('flex');
      }

      function closeProCancelModal() {
        proCancelModal.classList.add('hidden');
        proCancelModal.classList.remove('flex');
      }

      if (proCancelButton) {
        proCancelButton.addEventListener('click', async () => {
          openProCancelModal(window.currentProValidUntilText || '');
        });
      }

      [proCancelModalClose, proCancelModalCancel].forEach((btn) => {
        if (btn) btn.addEventListener('click', closeProCancelModal);
      });

      if (proCancelModalConfirm) {
        proCancelModalConfirm.addEventListener('click', async () => {
          proCancelModalConfirm.disabled = true;
          proCancelModalConfirm.textContent = '–û—Ç–º–µ–Ω—è–µ–º...';

          try {
            const user = auth.currentUser;
            if (!user) {
              alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.');
              return;
            }

            const token = await user.getIdToken();

            const resp = await fetch('/api/pro/cancel-subscription', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token,
              },
              body: JSON.stringify({}),
            });

            const data = await resp.json();

            if (!resp.ok || !data.ok) {
              console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã:', data);
              alert(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞ hello@polytalky.ru');
            } else {
              alert('–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ. –î–æ—Å—Ç—É–ø –∫ PRO –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –¥–æ –∫–æ–Ω—Ü–∞ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.');
              closeProCancelModal();
            }
          } catch (e) {
            console.error(e);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞ hello@polytalky.ru');
          } finally {
            proCancelModalConfirm.disabled = false;
            proCancelModalConfirm.textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ';
          }
        });
      }

      // ============================================
      // COOKIE
      // ============================================

      if (!localStorage.getItem('cookieConsent')) {
        cookieBanner.classList.remove('hidden');
      }
      cookieAccept.addEventListener('click', () => {
        localStorage.setItem('cookieConsent', 'true');
        cookieBanner.classList.add('hidden');
      });

      // ============================================
      // –ú–û–î–ê–õ–ö–ê –ü–†–û–§–ò–õ–Ø
      // ============================================

      function openProfileModal(){
        profileSettings.classList.remove('hidden');
        profileSettings.classList.add('flex');
      }
      function closeProfileModal(){
        profileSettings.classList.add('hidden');
        profileSettings.classList.remove('flex');
      }
      document.getElementById('btn-open-profile')?.addEventListener('click', openProfileModal);
      document.getElementById('btn-close-profile')?.addEventListener('click', closeProfileModal);
      document.getElementById('btn-cancel-profile')?.addEventListener('click', (e)=>{
        e.preventDefault();
        closeProfileModal();
      });
      profileSettings.addEventListener('click', (e)=>{
        if (e.target === profileSettings) closeProfileModal();
      });

      // ============================================
      // –í–´–ë–û–† –ê–í–ê–¢–ê–†–ê
      // ============================================

      function setAvatarChoice(type) {
        if (!profileAvatarType) return;
        const t = type || 'girl';
        profileAvatarType.value = t;

        avatarChoiceButtons.forEach((btn) => {
          const bt = btn.getAttribute('data-avatar-type');
          if (bt === t) {
            btn.classList.add('ring-2','ring-amber-400');
          } else {
            btn.classList.remove('ring-2','ring-amber-400');
          }
        });

        if (profileAvatarImg) {
          profileAvatarImg.src = t === 'girl'
            ? '/assets/avatarf.png'
            : '/assets/avatar.png';
        }
      }

      avatarChoiceButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const t = btn.getAttribute('data-avatar-type') || 'girl';
          setAvatarChoice(t);

          const src = t === 'girl'
            ? '/assets/avatarf.png'
            : '/assets/avatar.png';

          if (avatarPreviewModal && avatarPreviewImg) {
            avatarPreviewImg.src = src;
            avatarPreviewModal.classList.remove('hidden');
            avatarPreviewModal.classList.add('flex');
          }
        });
      });

      if (profileAvatarWrapper && avatarPreviewModal && avatarPreviewImg) {
        profileAvatarWrapper.addEventListener('click', () => {
          const t = profileAvatarType ? (profileAvatarType.value || 'girl') : 'girl';
          const src = t === 'girl'
            ? '/assets/avatarf.png'
            : '/assets/avatar.png';
          avatarPreviewImg.src = src;
          avatarPreviewModal.classList.remove('hidden');
          avatarPreviewModal.classList.add('flex');
        });
      }

      if (avatarPreviewModal) {
        avatarPreviewModal.addEventListener('click', (e) => {
          if (e.target === avatarPreviewModal) {
            avatarPreviewModal.classList.add('hidden');
            avatarPreviewModal.classList.remove('flex');
          }
        });
      }
      if (avatarPreviewClose && avatarPreviewModal) {
        avatarPreviewClose.addEventListener('click', () => {
          avatarPreviewModal.classList.add('hidden');
          avatarPreviewModal.classList.remove('flex');
        });
      }

      // ============================================
      // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
      // ============================================

      function showAuthError(code){
        let msg = '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
        if (code === 'auth/user-not-found') {
          msg = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.';
        } else if (code === 'auth/wrong-password') {
          msg = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Å–±—Ä–æ—Å–æ–º –ø–∞—Ä–æ–ª—è.';
        } else if (code === 'auth/email-already-in-use') {
          msg = '–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏.';
        } else if (code === 'auth/weak-password') {
          msg = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π. –î–æ–±–∞–≤—å—Ç–µ –µ—â—ë —Å–∏–º–≤–æ–ª–æ–≤.';
        }
        authError.textContent = msg;
      }

      let registerMode = false;

      function setAuthMode(isRegister) {
        registerMode = isRegister;

        if (isRegister) {
          authNamesBlock?.classList.remove('hidden');
          authTermsBlock?.classList.remove('hidden');
          authForgotRow?.classList.add('hidden');

          if (authPassEl) authPassEl.placeholder = '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
          if (authAcceptTerms) authAcceptTerms.required = true;

          btnLogin?.classList.remove('btn-main');
          btnLogin?.classList.add('btn-ghost');
          authRegister?.classList.remove('btn-ghost');
          authRegister?.classList.add('btn-main');
        } else {
          authNamesBlock?.classList.add('hidden');
          authTermsBlock?.classList.add('hidden');
          authForgotRow?.classList.remove('hidden');

          if (authPassEl) authPassEl.placeholder = '–ü–∞—Ä–æ–ª—å';
          if (authAcceptTerms) {
            authAcceptTerms.required = false;
            authAcceptTerms.checked = false;
          }

          btnLogin?.classList.add('btn-main');
          btnLogin?.classList.remove('btn-ghost');
          authRegister?.classList.add('btn-ghost');
          authRegister?.classList.remove('btn-main');
        }
      }

      setAuthMode(false);

      async function handleLogin() {
        if (honeypotEl.value && honeypotEl.value.trim() !== '') {
          authError.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
          return;
        }

        try {
          const email = authEmailEl.value.trim();
          const pass  = authPassEl.value.trim();
          await auth.signInWithEmailAndPassword(email, pass);
        } catch (err) {
          console.error(err);
          showAuthError(err.code);
        }
      }

      async function handleRegister() {
        if (honeypotEl.value && honeypotEl.value.trim() !== '') {
          authError.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
          return;
        }

        if (!authAcceptTerms || !authAcceptTerms.checked) {
          authError.textContent = '–ß—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏.';
          return;
        }

        try {
          const email = authEmailEl.value.trim();
          const pass  = authPassEl.value.trim();
          const first = authFirstEl.value.trim();
          const last  = authLastEl.value.trim();

          if (!email || !pass) {
            authError.textContent = '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å.';
            return;
          }

          const cred = await auth.createUserWithEmailAndPassword(email, pass);
          const user = cred.user;
          if (user) {
            await db.collection('users').doc(email).set({
              email,
              firstName:first || null,
              lastName:last || null,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
          }
        } catch (err) {
          console.error(err);
          showAuthError(err.code);
        }
      }

      authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        authError.textContent = '';

        if (registerMode) {
          await handleRegister();
        } else {
          await handleLogin();
        }
      });

      if (btnLogin) {
        btnLogin.addEventListener('click', async () => {
          authError.textContent = '';

          if (registerMode) {
            setAuthMode(false);
            return;
          }

          await handleLogin();
        });
      }

      if (authRegister) {
        authRegister.addEventListener('click', async () => {
          authError.textContent = '';

          if (!registerMode) {
            setAuthMode(true);
            return;
          }

          await handleRegister();
        });
      }

      if (authForgot) {
        authForgot.addEventListener('click', async () => {
          authError.textContent = '';

          const email = (authEmailEl.value || '').trim();
          if (!email) {
            authError.textContent =
              '–í–≤–µ–¥–∏—Ç–µ email –≤ –ø–æ–ª–µ –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?¬ª –µ—â—ë —Ä–∞–∑.';
            return;
          }

          try {
            await auth.sendPasswordResetEmail(email);
            authError.textContent =
              '–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –∏ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª.';
            authError.classList.remove('text-red-500');
            authError.classList.add('text-emerald-600');
          } catch (err) {
            console.error(err);

            let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
            if (err.code === 'auth/user-not-found') {
              msg = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω.';
            } else if (err.code === 'auth/invalid-email') {
              msg = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å.';
            }

            authError.textContent = msg;
            authError.classList.remove('text-emerald-600');
            authError.classList.add('text-red-500');
          }
        });
      }

      authLogout?.addEventListener('click', async () => {
        await auth.signOut();
             });

      // ============================================
      // –ú–ï–î–ê–õ–ò
      // ============================================

      function openBadgesModal(initialBadgeId) {
        if (!badgesModal || !badgesModalGrid) return;
        badgesModal.classList.remove('hidden');
        badgesModal.classList.add('flex');

        if (initialBadgeId && allBadgesCache.length) {
          const b = allBadgesCache.find(x => x.id === initialBadgeId);
          if (b) {
            showBadgeDetail(b);
            highlightSelectedBadge(b.id);
          }
        }
      }

      function closeBadgesModal() {
        if (!badgesModal) return;
        badgesModal.classList.add('hidden');
        badgesModal.classList.remove('flex');
      }

      if (badgesModalClose) {
        badgesModalClose.addEventListener('click', closeBadgesModal);
      }
      if (badgesModal) {
        badgesModal.addEventListener('click', (e) => {
          if (e.target === badgesModal) {
            closeBadgesModal();
          }
        });
      }

      function showBadgeDetail(badge) {
        if (!badgesModalDetail) return;
        const earnedText = badge.earned
          ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-50 border border-emerald-200 text-[10px] text-emerald-700 font-semibold">–ü–æ–ª—É—á–µ–Ω–æ</span>`
          : `<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-50 border border-slate-200 text-[10px] text-slate-500 font-semibold">–ï—â—ë –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ</span>`;

        const desc = badge.earned
          ? (badge.desc || '–í—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ —ç—Ç—É –º–µ–¥–∞–ª—å.')
          : '???';

        const imgSrc = badge.earned
          ? `/assets/badges/${badge.id}.png`
          : '/assets/badges/medalunknown.png';

        badgesModalDetail.innerHTML = `
          <div class="flex items-center gap-3 mb-2">
            <div class="h-24 w-24 sm:h-28 sm:w-28 rounded-full overflow-hidden bg-slate-100 flex items-center justify-center">
              <img src="${imgSrc}" alt="${badge.title}" class="h-full w-full object-contain" />
            </div>
            <div class="min-w-0">
              <p class="text-sm sm:text-base font-semibold text-slate-900 mb-0.5">
                ${badge.earned ? badge.title : '–≠—Ç–∞ –º–µ–¥–∞–ª—å –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞'}
              </p>
              ${earnedText}
            </div>
          </div>
          <p class="text-xs sm:text-sm text-slate-700">
            ${desc}
          </p>
        `;
      }

      function highlightSelectedBadge(badgeId) {
        if (!badgesModalGrid) return;
        const buttons = badgesModalGrid.querySelectorAll('button[data-badge-id]');
        buttons.forEach(btn => {
          if (btn.dataset.badgeId === badgeId) {
            btn.classList.add('ring-2', 'ring-slate-300');
          } else {
            btn.classList.remove('ring-2', 'ring-slate-300');
          }
        });
      }

      function renderBadgesModalGrid(badges) {
        if (!badgesModalGrid) return;
        badgesModalGrid.innerHTML = '';

        badges.forEach(badge => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.dataset.badgeId = badge.id;
          btn.className =
            'flex items-center justify-center p-1 rounded-lg bg-white/80 hover:shadow-sm transition ' +
            (badge.earned ? '' : 'opacity-70');

          const imgSrc = badge.earned
            ? `/assets/badges/${badge.id}.png`
            : `/assets/badges/medalunknown.png`;

          btn.innerHTML = `
            <div class="h-10 w-10 sm:h-12 sm:w-12 rounded-full overflow-hidden bg-slate-100 flex items-center justify-center">
              <img src="${imgSrc}" alt="${badge.title}" class="h-full w-full object-contain" />
            </div>
          `;

          const select = () => {
            highlightSelectedBadge(badge.id);
            showBadgeDetail(badge);
          };

          btn.addEventListener('click', select);
          btn.addEventListener('mouseenter', select);

          badgesModalGrid.appendChild(btn);
        });

        const firstEarned = badges.find(b => b.earned);
        if (firstEarned) {
          showBadgeDetail(firstEarned);
          highlightSelectedBadge(firstEarned.id);
        }
      }
      
      function renderEarnedBadgesStrip(badges) {
        if (!achievementsList) return;

        const earned = badges.filter(b => b.earned);

        achievementsList.innerHTML = `
          <div class="soft-card p-3 sm:p-4 space-y-2">
            <div class="flex flex-wrap items-center gap-2">
              <div id="earned-badges-grid" class="flex flex-wrap gap-2 flex-1"></div>

              <button
                type="button"
                id="open-badges-modal-desktop"
                class="hidden sm:inline-flex btn btn-ghost text-[11px] sm:text-xs px-3 py-1 ml-auto"
              >
                –û—Ç–∫—Ä—ã—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
              </button>
            </div>

            <button
              type="button"
              id="open-badges-modal-mobile"
              class="sm:hidden w-full btn btn-ghost text-xs mt-1"
            >
              –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
            </button>
          </div>
        `;

        const grid = document.getElementById('earned-badges-grid');
        const openDesktop = document.getElementById('open-badges-modal-desktop');
        const openMobile  = document.getElementById('open-badges-modal-mobile');

        if (!earned.length) {
          grid.innerHTML = `
            <p class="text-xs sm:text-sm text-slate-500">
              –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –º–µ–¥–∞–ª–µ–π. –ü—Ä–æ—Ö–æ–¥–∏—Ç–µ —É—Ä–æ–∫–∏ –∏ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è ‚Äî –ø–µ—Ä–≤—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –ø–æ—è–≤—è—Ç—Å—è –æ—á–µ–Ω—å —Å–∫–æ—Ä–æ.
            </p>
          `;
        } else {
          earned.forEach(badge => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.dataset.badgeId = badge.id;
            btn.className =
              'relative h-12 w-12 sm:h-14 sm:w-14 rounded-xl overflow-hidden bg-slate-100 border border-slate-200 flex items-center justify-center hover:shadow-md transition';

            btn.innerHTML = `
              <img src="/assets/badges/${badge.id}.png" alt="${badge.title}" class="h-full w-full object-contain" />
            `;

            btn.addEventListener('click', () => openBadgesModal(badge.id));
            grid.appendChild(btn);
          });
        }

        if (openDesktop) {
          openDesktop.addEventListener('click', () => openBadgesModal());
        }
        if (openMobile) {
          openMobile.addEventListener('click', () => openBadgesModal());
        }
      }

      async function loadProStatus(user) {
        if (!user) {
          if (proBannerSuccess) proBannerSuccess.style.display = 'none';
          if (proCancelButton)  proCancelButton.classList.add('hidden');
          if (proRenewButton)   proRenewButton.classList.add('hidden');
          return;
        }

        const uid   = user.uid;
        const email = user.email || null;

        const usersCol = db.collection('users');
        const emailRef = email ? usersCol.doc(email) : null;
        const uidRef   = uid   ? usersCol.doc(uid)   : null;

        const [emailSnap, uidSnap] = await Promise.all([
          emailRef ? emailRef.get() : Promise.resolve(null),
          uidRef   ? uidRef.get()   : Promise.resolve(null) ]);

        const emailData = emailSnap && emailSnap.exists ? (emailSnap.data() || {}) : null;
        const uidData   = uidSnap   && uidSnap.exists   ? (uidSnap.data()   || {}) : null;

        const proGlobal =
          (emailData && emailData.proGlobal) ||
          (uidData && uidData.proGlobal) ||
          false;

        const proValidUntil =
          (emailData && emailData.proValidUntil) ||
          (uidData && uidData.proValidUntil) ||
          null;

        if (!proGlobal) {
          if (proBannerSuccess) proBannerSuccess.style.display = 'none';
          if (proCancelButton)  proCancelButton.classList.add('hidden');
          if (proRenewButton)   proRenewButton.classList.add('hidden');
          return;
        }

        let hasStripeSub = false;

        try {
          const enrollSnap = await db
            .collection('enrollments')
            .where('userId', '==', uid)
            .where('tier', '==', 'pro-global-monthly')
            .where('status', 'in', ['active', 'cancel_at_period_end'])
            .limit(1)
            .get();

          if (!enrollSnap.empty) {
            const d = enrollSnap.docs[0].data() || {};
            if (d.subscriptionId) {
              hasStripeSub = true;
            }
          }
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å enrollments –¥–ª—è PRO:', e);
        }

        let daysLeft = null;
        let validUntilText = '';

        if (proValidUntil && typeof proValidUntil.toDate === 'function') {
          const end = proValidUntil.toDate();
          validUntilText = end.toLocaleDateString('ru-RU');
          const now = new Date();
          const diffMs = end - now;
          daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
          window.currentProValidUntilText = validUntilText;
        }

        updateProUi({ proGlobal, hasStripeSub, daysLeft, validUntilText });
      }

      function updateProUi({ proGlobal, hasStripeSub, daysLeft, validUntilText }) {
        window.currentProHasStripe = !!hasStripeSub;
        window.currentProValidUntilText = validUntilText || '';

        if (!proGlobal) {
          if (proChip)         proChip.classList.add('hidden');
          if (proCancelButton) proCancelButton.classList.add('hidden');
          if (proRenewButton)  proRenewButton.classList.add('hidden');
          if (proStatusText)   proStatusText.textContent = '';
          return;
        }

        if (proChip) proChip.classList.remove('hidden');

        let text = '–£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ PRO.';

        if (hasStripeSub) {
          if (daysLeft != null && validUntilText) {
            text = `–ü–æ–¥–ø–∏—Å–∫–∞ PRO –∞–∫—Ç–∏–≤–Ω–∞. –°–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ${daysLeft} –¥–Ω. (–¥–æ ${validUntilText}).`;
          } else {
            text = '–ü–æ–¥–ø–∏—Å–∫–∞ PRO –∞–∫—Ç–∏–≤–Ω–∞. –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.';
          }

          if (proCancelButton) proCancelButton.classList.remove('hidden');
          if (proRenewButton)  proRenewButton.classList.add('hidden');
        } else {
          if (daysLeft != null && validUntilText) {
            text = `–ü–æ–¥–ø–∏—Å–∫–∞ PRO –∞–∫—Ç–∏–≤–Ω–∞ –µ—â—ë ${daysLeft} –¥–Ω., –¥–æ ${validUntilText}. –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–µ—Ç ‚Äî –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Å—Ä–æ–∫–∞ –¥–æ—Å—Ç—É–ø –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.`;
          } else {
            text = '–ü–æ–¥–ø–∏—Å–∫–∞ PRO –∞–∫—Ç–∏–≤–Ω–∞. –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–µ—Ç ‚Äî –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Å—Ä–æ–∫–∞ –¥–æ—Å—Ç—É–ø –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.';
          }

          if (proCancelButton) proCancelButton.classList.add('hidden');

          if (proRenewButton) {
            if (daysLeft != null && daysLeft <= 3 && daysLeft >= 1) {
              proRenewButton.classList.remove('hidden');
            } else {
              proRenewButton.classList.add('hidden');
            }
          }
        }

        if (proStatusText) {
          proStatusText.textContent = text;
        }
      }

      if (proChip) {
        proChip.addEventListener('click', () => {
          const hasStripe = !!window.currentProHasStripe;
          const validText = window.currentProValidUntilText || '';

          if (hasStripe) {
            openProCancelModal(validText);
            return;
          }

          const msg = validText
            ? `–ü–æ–¥–ø–∏—Å–∫–∞ PRO –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ ${validText}. –ê–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç ‚Äî –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Å—Ä–æ–∫–∞ –µ—ë –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–¥–ª–∏—Ç—å –≤—Ä—É—á–Ω—É—é.`
            : '–ü–æ–¥–ø–∏—Å–∫–∞ PRO –∞–∫—Ç–∏–≤–Ω–∞. –ê–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç ‚Äî –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Å—Ä–æ–∫–∞ –µ—ë –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–¥–ª–∏—Ç—å –≤—Ä—É—á–Ω—É—é.';

          alert(msg);
        });
      }

      async function loadAndRenderBadges(userBadgeIds) {
        try {
          const earnedIds = Array.isArray(userBadgeIds) ? userBadgeIds : [];

          const snap = await db.collection('badges').get();
          const badges = [];
          snap.forEach(doc => {
            const data = doc.data() || {};
            const id = doc.id;
            badges.push({
              id,
              title: data.title || data.name || '–ú–µ–¥–∞–ª—å',
              desc: data.description || data.desc || '',
              earned: earnedIds.includes(id)
            });
          });

          allBadgesCache = badges;

          if (!badges.length) {
            achievementsList.innerHTML = `
              <div class="soft-card p-4 text-xs sm:text-sm text-slate-600">
                –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã –Ω–∞—á–Ω—ë—Ç–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —É—Ä–æ–∫–∏, –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –ø–µ—Ä–≤—ã–µ –±–µ–π–¥–∂–∏ –∏ –º–µ–¥–∞–ª–∏ –∑–∞ –≤–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ —è–∑—ã–∫–∞—Ö.
              </div>
            `;
            return;
          }

          renderEarnedBadgesStrip(badges);
          renderBadgesModalGrid(badges);
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –º–µ–¥–∞–ª–µ–π:', err);
          achievementsList.innerHTML = `
            <div class="soft-card p-4 text-xs sm:text-sm text-slate-600">
              –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –º–µ–¥–∞–ª–µ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.
            </div>
          `;
        }
      }

      async function setAuthState(user) {
        if (user) {
          localStorage.setItem('pt_uid', user.uid || '');
          if (user.email) localStorage.setItem('pt_email', user.email);

          authBoxOut.classList.add('hidden');
          authBoxIn.classList.remove('hidden');
          coursesNeedAuth.classList.add('hidden');
          authUserEmail.textContent = user.email || '';

          await loadUserProfile(user);
          await loadUserEnrollments(user);
        } else {
          localStorage.removeItem('pt_uid');
          localStorage.removeItem('pt_email');

          authBoxOut.classList.remove('hidden');
          authBoxIn.classList.add('hidden');
          coursesNeedAuth.classList.remove('hidden');
          authUserEmail.textContent = '';
          profileName.textContent = '';
          profileAvatarImg.src = '/assets/avatarf.png';
          if (profileAvatarType) profileAvatarType.value = 'girl';
          setAvatarChoice('girl');
          coursesList.innerHTML = '';
          coursesEmpty.classList.add('hidden');
          achievementsList.innerHTML = `
            <div class="soft-card p-4 text-xs sm:text-sm text-slate-600">
              –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –º–µ–¥–∞–ª–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.
            </div>
          `;
          if (coinsCard) {
            coinsCard.classList.add('hidden');
          }
        }
      }

      async function loadUserProfile(user) {
        try {
          const email = user.email || null;
          if (!email) return;

          const usersCol = db.collection('users');
          const emailRef = email ? usersCol.doc(email) : null;
          
          const [emailSnap] = await Promise.all([
            emailRef ? emailRef.get() : Promise.resolve(null),
                     ]);

          const emailData = emailSnap && emailSnap.exists ? (emailSnap.data() || {}) : null;
         
          let data = {
            ...(emailData || {}),
          };

          if (email) data.email = data.email || email;

          const first = data.firstName || '';
          const last  = data.lastName || '';
          const avatarType = data.avatarType || 'girl';
          const displayEmail = data.email || email || '';

          const displayName = (first || last)
            ? (first + ' ' + (last || '')).trim()
            : displayEmail || '–ë–µ–∑ –∏–º–µ–Ω–∏';

          profileName.textContent = displayName;
          authUserEmail.textContent = displayEmail;
          if (profileEmail) profileEmail.value = displayEmail || '';

          profileFirst.value = first;
          profileLast.value  = last;

          setAvatarChoice(avatarType);

          profileMsg.textContent = '';

          updateCoinsUI(data);

          if (emailRef) {
            try {
              await emailRef.set(
                { ...data, email: displayEmail },
                { merge: true }
              );
            } catch (e) {
              console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å uid‚Üíemail:', e);
            }
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è:', err);
        }
      }

      profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        profileMsg.textContent = '';

        const user = auth.currentUser;
        if (!user) {
          profileMsg.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.';
          return;
        }

        try {
          const email = user.email;
          const first = profileFirst.value.trim();
          const last  = profileLast.value.trim();
          const avatarType = profileAvatarType ? (profileAvatarType.value || 'girl') : 'girl';

          const payload = {
            firstName: first,
            lastName:  last,
            avatarType: avatarType
          };

          profileAvatarImg.src = avatarType === 'girl'
            ? '/assets/avatarf.png'
            : '/assets/avatar.png';

          await db.collection('users').doc(email).set(payload, { merge: true });

          profileMsg.textContent = '–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úîÔ∏è';

          const again = auth.currentUser;
          if (again) {
            await loadUserProfile(again);
          }

          closeProfileModal();
        } catch (err) {
          console.error('profile save error', err);
          profileMsg.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
        }
      });

      async function loadUserEnrollments(user) {
        coursesList.innerHTML = '';
        coursesEmpty.classList.add('hidden');

        try {
          const email = user.email || null;

          if (!email) {
            coursesEmpty.classList.remove('hidden');
            await loadAndRenderBadges([]);
            return;
          }

          const usersCol = db.collection('users');
          const emailRef = email ? usersCol.doc(email) : null;
         

          const [emailSnap] = await Promise.all([
            emailRef ? emailRef.get() : Promise.resolve(null),
             ]);

          const emailData = emailSnap && emailSnap.exists ? (emailSnap.data() || {}) : null;
        
          if (!emailData) {
            coursesEmpty.classList.remove('hidden');
            await loadAndRenderBadges([]);
            return;
          }

          const paidFromEmail = Array.isArray(emailData?.courses)     ? emailData.courses     : [];
           const freeFromEmail = Array.isArray(emailData?.freeCourses) ? emailData.freeCourses : [];
            const badgesEmail   = Array.isArray(emailData?.badges)      ? emailData.badges      : [];
    

          const progressEmail = emailData?.progress || {};
                  const mergedProgress = {
            ...(progressEmail || {}),

         
          };

          const progressCourseIds = Object.keys(mergedProgress || {});

          let mergedPaid = Array.from(new Set([...paidFromEmail]));
          let mergedFree = Array.from(new Set([
               ...freeFromEmail,
            ...progressCourseIds.filter(id => !mergedPaid.includes(id))
          ]));

          let mergedBadges = Array.from(new Set([...badgesEmail]));

          const hasAnyCourse = mergedPaid.length > 0 || mergedFree.length > 0;

          if (hasAnyCourse && !mergedBadges.includes(FIRST_STEP_BADGE_ID)) {
            mergedBadges.push(FIRST_STEP_BADGE_ID);

            const badgeUpdate = {
              badges: firebase.firestore.FieldValue.arrayUnion(FIRST_STEP_BADGE_ID),
            };

            const updates = [];
                  if (emailRef) updates.push(emailRef.set(badgeUpdate, { merge: true }));

            try {
              await Promise.all(updates);
            } catch (e) {
              console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–µ–π–¥–∂ first-step:', e);
            }
          }

          const courses = [];

          for (const id of mergedPaid) {
            courses.push({
              id,
              isPaid: true,
              isFree: false,
              progress: mergedProgress[id] || null
            });
          }

          for (const id of mergedFree) {
            if (mergedPaid.includes(id)) continue;
            courses.push({
              id,
              isPaid: false,
              isFree: true,
              progress: mergedProgress[id] || null
            });
          }

          renderCourses(courses);
          await loadAndRenderBadges(mergedBadges);

          if (emailRef) {
            try {
              await emailRef.set(
                {
                  email: emailData?.email || email || null,
                  courses: mergedPaid,
                  freeCourses: mergedFree,
                  badges: mergedBadges,
                  progress: mergedProgress
                },
                { merge: true }
              );
            } catch (e) {
              console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å—ã uid‚Üíemail:', e);
            }
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤:', err);
          renderCourses([]);
          await loadAndRenderBadges([]);
        }
      }

      function renderCourses(courses) {
        coursesList.innerHTML = '';

        if (!courses || !courses.length) {
          coursesEmpty.classList.remove('hidden');
          return;
        }

        coursesEmpty.classList.add('hidden');

        courses.forEach((c) => {
          const meta = COURSE_META[c.id] || {
            title: '–ö—É—Ä—Å PolyTalky',
            href: '#',
            cover: '/assets/courses/placeholder.jpg'
          };

          const progressData = c.progress || {};
          const percent = typeof progressData.percent === 'number'
            ? Math.max(0, Math.min(100, progressData.percent))
            : 0;
          const lastLessonId = progressData.lastLessonId || null;

          const isFree = !!c.isFree;
          const isPaid = !!c.isPaid;

          const badgeLabel = isFree ? '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫—É—Ä—Å' : '–û–ø–ª–∞—á–µ–Ω–Ω—ã–π –∫—É—Ä—Å';
          const badgeClass = isFree
            ? 'border-emerald-300 bg-emerald-50 text-emerald-700'
            : 'border-amber-300 bg-amber-50 text-amber-700';

          let statusLabel;
          if (percent > 0 && lastLessonId) {
            statusLabel = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${percent}% ¬∑ –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Ä–æ–∫: ${lastLessonId}`;
          } else if (percent > 0) {
            statusLabel = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${percent}%`;
          } else if (isPaid) {
            statusLabel = '–ö—É—Ä—Å –æ–ø–ª–∞—á–µ–Ω, –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.';
          } else {
            statusLabel = '–ö—É—Ä—Å –æ—Ç–∫—Ä—ã—Ç, –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫.';
          }

          const card = document.createElement('a');
          card.href = meta.href;
          card.className = 'soft-card p-3 sm:p-4 flex flex-col gap-2 hover:shadow-md transition-shadow group';

          card.innerHTML = `
            <div class="flex gap-3 items-center">
              <div class="h-14 w-14 rounded-xl bg-slate-100 overflow-hidden flex-shrink-0">
                <img src="${meta.cover}" alt="" class="h-full w-full object-cover group-hover:scale-105 transition-transform" />
              </div>
              <div class="flex-1 min-w-0 space-y-1">
                <div class="flex items-center gap-2">
                  <span class="badge text-[10px] ${badgeClass}">${badgeLabel}</span>
                </div>
                <p class="text-sm font-semibold text-slate-900 truncate">${meta.title}</p>
                <p class="text-[11px] text-slate-500">${statusLabel}</p>
              </div>
            </div>
            <div class="mt-2 h-1.5 rounded-full bg-slate-100 overflow-hidden">
              <div class="h-full bg-gradient-to-r from-emerald-400 to-emerald-500" style="width:${percent}%;"></div>
            </div>
          `;

          coursesList.appendChild(card);
        });
      }
 if (btnResetPassword) {
  btnResetPassword.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user || !user.email) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.');
      return;
    }
    try {
      await auth.sendPasswordResetEmail(user.email);
      if (pwMsg) {
        pwMsg.textContent = '–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –∏ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª.';
        pwMsg.classList.remove('text-red-500');
        pwMsg.classList.add('text-emerald-600');
      }
    } catch (e) {
      console.error(e);
      if (pwMsg) {
        pwMsg.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
        pwMsg.classList.remove('text-emerald-600');
        pwMsg.classList.add('text-red-500');
      }
    }
  });
}
        if (btnChangePassword) {
  btnChangePassword.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user || !user.email) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.');
      return;
    }

    const current = (pwCurrent?.value || '').trim();
    const next = (pwNew?.value || '').trim();

    if (!current || !next) {
      if (pwMsg) {
        pwMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –∏ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.';
        pwMsg.classList.add('text-red-500');
      }
      return;
    }
    if (next.length < 6) {
      if (pwMsg) {
        pwMsg.textContent = '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.';
        pwMsg.classList.add('text-red-500');
      }
      return;
    }

    btnChangePassword.disabled = true;

    try {
      const cred = firebase.auth.EmailAuthProvider.credential(user.email, current);
      await user.reauthenticateWithCredential(cred);
      await user.updatePassword(next);

      if (pwMsg) {
        pwMsg.textContent = '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω ‚úîÔ∏è';
        pwMsg.classList.remove('text-red-500');
        pwMsg.classList.add('text-emerald-600');
      }
      if (pwCurrent) pwCurrent.value = '';
      if (pwNew) pwNew.value = '';
    } catch (e) {
      console.error(e);
      let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
      if (e.code === 'auth/wrong-password') msg = '–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–Ω—ã–π.';
      if (e.code === 'auth/too-many-requests') msg = '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
      if (e.code === 'auth/requires-recent-login') msg = '–ù—É–∂–Ω–æ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É.';

      if (pwMsg) {
        pwMsg.textContent = msg;
        pwMsg.classList.remove('text-emerald-600');
        pwMsg.classList.add('text-red-500');
      }
    } finally {
      btnChangePassword.disabled = false;
    }
  });
              }
      auth.onAuthStateChanged((user) => {
        setAuthState(user || null);
        loadProStatus(user || null);
      });
    });
  </script>
</body>
</html>
‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã
