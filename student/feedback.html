<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ú–æ–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî PolyTalky PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-soft: #FFF8E9;
      --card-bg: #FFFFFF;
      --accent: #FFBA08;
      --accent-soft: #FFE8A3;
      --accent-strong: #CF2C02;
      --text-main: #222222;
      --text-soft: #6B7280;
      --border-soft: #E5E7EB;
      --radius-xl: 24px;
      --radius-l: 18px;
      --radius-m: 12px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #FFEED2 0, #FFF8E9 45%, #FFFFFF 100%);
      color: var(--text-main);
    }

    a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px 16px 48px;
    }

    /* HEADER */

    header.feedback-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #FFFFFF 0, #FFE09C 45%, #FFB347 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      box-shadow: var(--shadow-soft);
    }

    .brand-title {
      font-size: 18px;
      font-weight: 600;
    }

    .brand-sub {
      font-size: 12px;
      color: var(--text-soft);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .pill {
      border-radius: var(--radius-pill);
      padding: 6px 12px;
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill.pro {
      background: #FEF3C7;
      border-color: #FDE68A;
      color: #92400E;
      font-weight: 500;
    }

    .btn-ghost {
      border-radius: var(--radius-pill);
      padding: 6px 12px;
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border-soft);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost:hover {
      background: #FFF3C7;
    }

    /* LOCKED (NO PRO) */

    .locked {
      max-width: 640px;
      margin: 40px auto;
      background: rgba(255,255,255,0.92);
      border-radius: var(--radius-xl);
      padding: 20px 22px 22px;
      box-shadow: var(--shadow-soft);
      text-align: center;
    }

    .locked h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }

    .locked p {
      margin: 0 0 10px;
      font-size: 14px;
      color: var(--text-soft);
    }

    .btn-main {
      border-radius: var(--radius-pill);
      padding: 8px 18px;
      border: none;
      background: linear-gradient(135deg, #FFBA08, #FF8A3D);
      color: #111827;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 32px rgba(248,181,71,0.4);
    }

    .btn-main:hover {
      filter: brightness(1.04);
      transform: translateY(-1px);
    }

    /* HERO */

    .hero {
      background: rgba(255,255,255,0.9);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px 16px;
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .hero-left h1 {
      margin: 0 0 6px;
      font-size: 22px;
    }

    .hero-left p {
      margin: 0;
      font-size: 14px;
      color: var(--text-soft);
    }

    .hero-right {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 13px;
    }

    .stat-pill {
      border-radius: var(--radius-pill);
      padding: 6px 10px;
      background: #FFF7D1;
      border: 1px solid #FFE08A;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .stat-pill strong {
      font-weight: 600;
      color: var(--accent-strong);
    }

    /* FILTERS + TABS */

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    .filters-row label {
      font-size: 13px;
      color: var(--text-soft);
    }

    .filters-row select {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      padding: 5px 10px;
      font-size: 13px;
      background: #FFFFFF;
    }

    .filters-row input[type="text"] {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 13px;
      background: #FFFFFF;
      min-width: 180px;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tab-btn {
      border-radius: var(--radius-pill);
      border: 1px solid transparent;
      padding: 6px 12px;
      font-size: 13px;
      background: transparent;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-soft);
    }

    .tab-btn.active {
      background: #FFFFFF;
      border-color: #FFE08A;
      color: var(--text-main);
      box-shadow: 0 8px 20px rgba(15,23,42,0.06);
    }

    /* CONTENT GRID */

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.2fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 840px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 16px;
      max-height: 520px;
      overflow-y: auto;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 15px;
    }

    .card p.subtitle {
      margin: 0 0 8px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .empty {
      font-size: 14px;
      color: var(--text-soft);
      text-align: center;
      padding: 28px 0;
    }

    /* LIST */

    .list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .list-item {
      border-radius: var(--radius-l);
      border: 1px solid var(--border-soft);
      padding: 10px 11px;
      background: #FFFFFF;
      font-size: 13px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: box-shadow 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
    }

    .list-item:hover {
      box-shadow: 0 10px 24px rgba(148,163,184,0.3);
      border-color: #FFE08A;
      transform: translateY(-1px);
    }

    .list-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .course-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      padding: 2px 7px;
      border-radius: var(--radius-pill);
      background: #EEF2FF;
      color: #4338CA;
    }

    .status-tag {
      font-size: 11px;
      border-radius: var(--radius-pill);
      padding: 2px 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-checked {
      background: #DCFCE7;
      color: #166534;
    }

    .status-pending {
      background: #FEF3C7;
      color: #92400E;
    }

    .status-needs {
      background: #FEE2E2;
      color: #991B1B;
    }

    .lesson-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .snippet {
      font-size: 12px;
      color: var(--text-soft);
    }

    /* DETAIL */

    .detail-section {
      margin-bottom: 10px;
      font-size: 13px;
    }

    .detail-section h3 {
      margin: 0 0 4px;
      font-size: 13px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .badge-small {
      border-radius: var(--radius-pill);
      padding: 2px 8px;
      background: #ECFDF5;
      color: #166534;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .detail-section p {
      margin: 0;
      white-space: pre-wrap;
    }

    .detail-meta {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .highlight {
      background: #FFFBEB;
      padding: 6px 8px;
      border-radius: var(--radius-m);
      border: 1px dashed #FACC15;
      font-size: 12px;
      color: #854D0E;
    }

    .progress-line {
      margin-bottom: 8px;
      font-size: 13px;
    }

    .progress-line span {
      font-weight: 600;
    }

    audio {
      width: 100%;
      margin-top: 4px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
<div class="page">
  <header class="feedback-header">
    <div class="brand-block">
      <div class="brand-logo">PT</div>
      <div>
        <div class="brand-title">–ú–æ–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
        <div class="brand-sub">–õ–∏—á–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ PolyTalky</div>
      </div>
    </div>

    <div class="header-right">
      <div id="proStatusPill" class="pill">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      <button class="btn-ghost" type="button" id="backToStudent">
        ‚Üê –í –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
      </button>
    </div>
  </header>

  <!-- –ë–ª–æ–∫, –µ—Å–ª–∏ –Ω–µ—Ç PRO -->
  <section id="lockedBlock" class="locked hidden">
    <h1>üîí –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è PRO</h1>
    <p>
      –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π, –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ¬´–∫—É–¥–∞ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ¬ª ‚Äî
      —ç—Ç–æ —á–∞—Å—Ç—å —Ç–∞—Ä–∏—Ñ–∞ <strong>PolyTalky PRO</strong>.
    </p>
    <p>
      –°–µ–π—á–∞—Å –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –±–µ–∑ PRO-–ø–æ–¥–ø–∏—Å–∫–∏, –ø–æ—ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
    </p>
    <button class="btn-main" type="button" id="goToPro">
      ‚ú® –û—Ñ–æ—Ä–º–∏—Ç—å PRO
    </button>
    <p style="margin-top:10px;font-size:12px;color:var(--text-soft);">
      –ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è PRO –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –≤—Å–µ –≤–∞—à–∏ –∑–∞–¥–∞–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫—É—Ä–∞—Ç–æ—Ä–æ–≤
      –ø–æ –∫–∞–∂–¥–æ–º—É –∫—É—Ä—Å—É.
    </p>
  </section>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è PRO -->
  <main id="feedbackMain" class="hidden">
    <section class="hero">
      <div class="hero-left">
        <h1>–í–∞—à–∞ –ª–∏—á–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h1>
        <p>
          –ó–¥–µ—Å—å —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.
          –£–¥–æ–±–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è, –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞—Ç—å –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –∫–∞–∫ —Ä–∞—Å—Ç—ë—Ç –≤–∞—à –∞–Ω–≥–ª–∏–π—Å–∫–∏–π.
        </p>
      </div>
      <div class="hero-right">
        <div class="stat-pill">
          üì® –ù–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: <strong id="statNew">0</strong>
        </div>
        <div class="stat-pill">
          ‚úÖ –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ: <strong id="statChecked">0</strong>
        </div>
        <div class="stat-pill">
          üìö –ö—É—Ä—Å–æ–≤: <strong id="statCourses">0</strong>
        </div>
      </div>
    </section>

    <section class="filters-row">
      <label for="filterCourse">–ö—É—Ä—Å:</label>
      <select id="filterCourse">
        <option value="all">–í—Å–µ –∫—É—Ä—Å—ã</option>
      </select>

      <label for="filterStatus">–°—Ç–∞—Ç—É—Å:</label>
      <select id="filterStatus">
        <option value="all">–í—Å–µ</option>
        <option value="with-feedback">–° –ø—Ä–æ–≤–µ—Ä–∫–æ–π</option>
        <option value="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
        <option value="needs">–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏</option>
      </select>

      <label for="filterLesson">–£—Ä–æ–∫:</label>
      <select id="filterLesson">
        <option value="all">–õ—é–±–æ–π —É—Ä–æ–∫</option>
      </select>
    </section>

    <section class="tabs">
      <button class="tab-btn active" data-tab="all">
        üåç –í—Å–µ –æ—Ç–∑—ã–≤—ã
      </button>
      <button class="tab-btn" data-tab="recent">
        ‚ú® –ü–æ—Å–ª–µ–¥–Ω–∏–µ
      </button>
      <button class="tab-btn" data-tab="practice">
        üîÅ –ö—É–¥–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è
      </button>
    </section>

    <section class="grid">
      <!-- –°–ø–∏—Å–æ–∫ -->
      <article class="card">
        <h2>–ó–∞–¥–∞–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
        <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
        <ul id="feedbackList" class="list"></ul>
        <div id="feedbackEmpty" class="empty hidden">
          –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∑–∞–¥–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –∫—É—Ä—Å–µ.
        </div>
      </article>

      <!-- –î–µ—Ç–∞–ª–∏ -->
      <article class="card">
        <h2 id="detailTitle">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
        <p class="subtitle" id="detailSubtitle">
          –°–ø—Ä–∞–≤–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Å–≤–æ–π –æ—Ç–≤–µ—Ç, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–ª—å—à–µ.
        </p>

        <div id="detailBody" class="hidden">
          <div class="detail-section">
            <h3>–ö—É—Ä—Å –∏ —É—Ä–æ–∫</h3>
            <p id="detailCourseLesson"></p>
          </div>

          <div class="detail-section">
            <h3>–í–∞—à –æ—Ç–≤–µ—Ç</h3>
            <p id="detailAnswer"></p>
            <div id="detailAudioWrap" class="hidden">
              <audio id="detailAudio" controls></audio>
            </div>
          </div>

          <div class="detail-section">
            <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫—É—Ä–∞—Ç–æ—Ä–∞</h3>
            <p id="detailFeedback"></p>
          </div>

          <div class="detail-section">
            <h3>–°—Ç–∞—Ç—É—Å</h3>
            <div id="detailStatusBadge"></div>
          </div>

          <div class="detail-section">
            <div class="highlight" id="detailHighlight">
              –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∫—É—Ä–∞—Ç–æ—Ä–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.
            </div>
          </div>

          <div class="detail-meta" id="detailMeta"></div>
        </div>

        <div id="detailEmpty" class="empty">
          –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä.
        </div>
      </article>
    </section>
  </main>
</div>

<!-- –õ–û–ì–ò–ö–ê -->
<script type="module">
  import {
    onAuthStateChanged,
    getIdTokenResult
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

  import {
    collectionGroup,
    query,
    where,
    orderBy,
    onSnapshot,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≥–¥–µ-—Ç–æ –Ω–∞ —Å–∞–π—Ç–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω firebase-init
  // –∏ –¥–æ—Å—Ç—É–ø–Ω—ã:
  const auth = window.firebaseAuth;
  const db   = window.firebaseDb;

  // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
  const proStatusPill = document.getElementById("proStatusPill");
  const backToStudent = document.getElementById("backToStudent");
  const goToPro       = document.getElementById("goToPro");

  const lockedBlock   = document.getElementById("lockedBlock");
  const feedbackMain  = document.getElementById("feedbackMain");

  const statNewEl      = document.getElementById("statNew");
  const statCheckedEl  = document.getElementById("statChecked");
  const statCoursesEl  = document.getElementById("statCourses");

  const filterCourseEl = document.getElementById("filterCourse");
  const filterStatusEl = document.getElementById("filterStatus");
  const filterLessonEl = document.getElementById("filterLesson");

  const tabs           = document.querySelectorAll(".tab-btn");

  const feedbackList   = document.getElementById("feedbackList");
  const feedbackEmpty  = document.getElementById("feedbackEmpty");

  const detailTitle    = document.getElementById("detailTitle");
  const detailSubtitle = document.getElementById("detailSubtitle");
  const detailBody     = document.getElementById("detailBody");
  const detailEmpty    = document.getElementById("detailEmpty");
  const detailCourseLesson = document.getElementById("detailCourseLesson");
  const detailAnswer   = document.getElementById("detailAnswer");
  const detailAudioWrap= document.getElementById("detailAudioWrap");
  const detailAudio    = document.getElementById("detailAudio");
  const detailFeedback = document.getElementById("detailFeedback");
  const detailStatusBadge = document.getElementById("detailStatusBadge");
  const detailHighlight= document.getElementById("detailHighlight");
  const detailMeta     = document.getElementById("detailMeta");

  let currentUser = null;
  let hasPro      = false;
  let submissions = []; // –º–∞—Å—Å–∏–≤ –¥–µ—Ä–≥–∞–µ–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  let activeTab   = "all";

  backToStudent.addEventListener("click", () => {
    window.location.href = "/student/";
  });

  goToPro.addEventListener("click", () => {
    window.location.href = "/courses/pro.html";
  });

  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      activeTab = btn.dataset.tab;
      renderList();
      clearDetail();
    });
  });

  filterCourseEl.addEventListener("change", () => {
    buildLessonFilter();
    renderList();
    clearDetail();
  });
  filterStatusEl.addEventListener("change", () => {
    renderList();
    clearDetail();
  });
  filterLessonEl.addEventListener("change", () => {
    renderList();
    clearDetail();
  });

  // --- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ PRO ---

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      proStatusPill.textContent = "–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏";
      lockedBlock.classList.remove("hidden");
      feedbackMain.classList.add("hidden");
      return;
    }

    currentUser = user;
    proStatusPill.textContent = user.email || "–ü—Ä–æ—Ñ–∏–ª—å";

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º custom claims (–µ—Å–ª–∏ –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –±—É–¥–µ—à—å –∏—Ö —Å—Ç–∞–≤–∏—Ç—å)
    let claimsHasPro = false;
    try {
      const tokenRes = await getIdTokenResult(user);
      const claims = tokenRes.claims || {};
      claimsHasPro = !!(claims.hasPro || claims.pro === true);
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å custom claims:", e);
    }

   // --- –ü—Ä–æ–≤–µ—Ä—è–µ–º Firestore –ø—Ä–æ—Ñ–∏–ª—å /users/{uid} –∏ /users/{email}
let profileHasPro = false;
try {
  const email = user.email || null;
  const uid   = user.uid   || null;

  if (email || uid) {
    const usersCol = collection(db, "users");
    const emailRef = email ? doc(usersCol, email) : null;
    const uidRef   = uid   ? doc(usersCol, uid)   : null;

    const [emailSnap, uidSnap] = await Promise.all([
      emailRef ? getDoc(emailRef) : Promise.resolve(null),
      uidRef   ? getDoc(uidRef)   : Promise.resolve(null),
    ]);

    const emailData = emailSnap && emailSnap.exists() ? (emailSnap.data() || {}) : null;
    const uidData   = uidSnap   && uidSnap.exists()   ? (uidSnap.data()   || {}) : null;

    const merged = {
      ...(uidData || {}),
      ...(emailData || {}),
    };

    if (Object.keys(merged).length) {
      const proGlobal = merged.proGlobal === true;

      let proValidUntil = merged.proValidUntil  merged.proUntil  null;
      if (proValidUntil && typeof proValidUntil.toDate === "function") {
        proValidUntil = proValidUntil.toDate();
      }

      const legacyPro =
        merged.proActive ||
        merged.isPro ||
        merged.hasPro ||
        (merged.pro && merged.pro.active);

      let active = !!(proGlobal || legacyPro);

      if (proValidUntil instanceof Date) {
        const now = new Date();
        if (proValidUntil <= now) {
          active = false;
        }
      }

      profileHasPro = active;
    }
  }
} catch (e) {
  console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", e);
}

    hasPro = claimsHasPro || profileHasPro;

    if (!hasPro) {
      proStatusPill.classList.remove("pro");
      proStatusPill.textContent = "PRO –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω";
      lockedBlock.classList.remove("hidden");
      feedbackMain.classList.add("hidden");
      return;
    }

    proStatusPill.classList.add("pro");
    proStatusPill.innerHTML = "‚ú® PRO –∞–∫—Ç–∏–≤–Ω–æ";

    lockedBlock.classList.add("hidden");
    feedbackMain.classList.remove("hidden");

    initFeedbackListener();
  });

  // --- –°–ª—É—à–∞–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã —É—á–µ–Ω–∏–∫–∞ –≤–æ –≤—Å–µ—Ö –∫—É—Ä—Å–∞—Ö ---

  function initFeedbackListener() {
    if (!currentUser) return;

    const email = currentUser.email || null;
    const uid   = currentUser.uid;

    // –ë–µ—Ä—ë–º –≤—Å—ë –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–π answers, –≥–¥–µ userEmail == email –ò–õ–ò userUid == uid
    const qRef = query(
      collectionGroup(db, "answers"),
      where("userUid", "==", uid),
      orderBy("createdAt", "desc")
    );

    onSnapshot(qRef, (snap) => {
      submissions = [];
      snap.forEach(docSnap => {
        const d = docSnap.data();
        // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä–∞–Ω—ë–º –ø–æ email, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (d.userUid === uid || d.userEmail === email) {
          submissions.push({
            id: docSnap.id,
            refPath: docSnap.ref.path,
            ...d
          });
        }
      });

      buildCourseFilter();
      buildLessonFilter();
      renderStats();
      renderList();
      clearDetail();
    });
  }

  function renderStats() {
    const coursesSet = new Set();
    let checked = 0;
    let newFeedback = 0;

    submissions.forEach(s => {
      if (s.courseId) coursesSet.add(s.courseId);
      if (s.status && s.status !== "pending") {
        checked++;
      }
      // "–Ω–æ–≤—ã–µ" —É—Å–ª–æ–≤–Ω–æ —Å—á–∏—Ç–∞–µ–º –≤—Å–µ, –≥–¥–µ –µ—Å—Ç—å feedback –∏ –Ω–µ—Ç –ø–æ–ª—è feedbackSeen === true
      if (s.feedback && !s.feedbackSeen) {
        newFeedback++;
      }
    });

    statNewEl.textContent     = newFeedback;
    statCheckedEl.textContent = checked;
    statCoursesEl.textContent = coursesSet.size;
  }

  function buildCourseFilter() {
    const selected = filterCourseEl.value || "all";
    filterCourseEl.innerHTML = `<option value="all">–í—Å–µ –∫—É—Ä—Å—ã</option>`;

    const byCourse = new Map();
    submissions.forEach(s => {
      const cid = s.courseId || "unknown";
      const title = s.courseTitle || cid;
      if (!byCourse.has(cid)) {
        byCourse.set(cid, { title, count: 0 });
      }
      byCourse.get(cid).count++;
    });

    byCourse.forEach((bucket, cid) => {
      const opt = document.createElement("option");
      opt.value = cid;
      opt.textContent = `${bucket.title} (${bucket.count})`;
      filterCourseEl.appendChild(opt);
    });

    if ([...byCourse.keys()].includes(selected)) {
      filterCourseEl.value = selected;
    } else {
      filterCourseEl.value = "all";
    }
  }

  function buildLessonFilter() {
    const courseFilter = filterCourseEl.value;
    const selectedLesson = filterLessonEl.value || "all";

    filterLessonEl.innerHTML = `<option value="all">–õ—é–±–æ–π —É—Ä–æ–∫</option>`;

    const setLessons = new Map(); // key: lessonId

    submissions.forEach(s => {
      if (courseFilter !== "all" && (s.courseId || "unknown") !== courseFilter) return;
      const lid = s.lessonId || "lesson";
      if (!setLessons.has(lid)) {
        setLessons.set(lid, s.lessonTitle || lid);
      }
    });

    setLessons.forEach((title, lid) => {
      const opt = document.createElement("option");
      opt.value = lid;
      opt.textContent = title;
      filterLessonEl.appendChild(opt);
    });

    if ([...setLessons.keys()].includes(selectedLesson)) {
      filterLessonEl.value = selectedLesson;
    } else {
      filterLessonEl.value = "all";
    }
  }

  // --- –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –≤–∫–ª–∞–¥–æ–∫ ---

  function renderList() {
    feedbackList.innerHTML = "";
    feedbackEmpty.classList.add("hidden");

    let list = submissions.slice();

    const courseFilter = filterCourseEl.value;
    const statusFilter = filterStatusEl.value;
    const lessonFilter = filterLessonEl.value;

    if (courseFilter !== "all") {
      list = list.filter(s => (s.courseId || "unknown") === courseFilter);
    }

    if (lessonFilter !== "all") {
      list = list.filter(s => (s.lessonId || "lesson") === lessonFilter);
    }

    if (statusFilter === "with-feedback") {
      list = list.filter(s => !!s.feedback);
    } else if (statusFilter === "pending") {
      list = list.filter(s => (s.status || "pending") === "pending");
    } else if (statusFilter === "needs") {
      list = list.filter(s => s.status === "needs-more-practice" || s.status === "needs-fix");
    }

    // –≤–∫–ª–∞–¥–∫–∏
    if (activeTab === "recent") {
      list = list.slice(0, 5);
    } else if (activeTab === "practice") {
      list = list.filter(s => s.status === "needs-more-practice" || s.status === "needs-fix");
    }

    if (!list.length) {
      feedbackEmpty.classList.remove("hidden");
      return;
    }

    list.forEach(s => {
      const li = document.createElement("li");
      li.className = "list-item";
      li.addEventListener("click", () => showDetail(s));

      const statusClass =
        s.status === "approved"
          ? "status-checked"
          : s.status === "needs-more-practice" || s.status === "needs-fix"
          ? "status-needs"
          : "status-pending";

      const lessonTitle = s.lessonTitle || "–£—Ä–æ–∫";
      const courseTitle = s.courseTitle || s.courseId || "–ö—É—Ä—Å";

      const answerText = (s.answerText || s.answer || "").toString();
      const shortAnswer = answerText.length > 90
        ? answerText.slice(0, 90).trim() + "‚Ä¶"
        : answerText || "<em>–û—Ç–≤–µ—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞</em>";

      li.innerHTML = `
        <div class="list-top">
          <div>
            <span class="course-label">${courseTitle}</span>
          </div>
          <div class="status-tag ${statusClass}">
            ${statusLabel(s)}
          </div>
        </div>
        <div class="lesson-title">${lessonTitle}</div>
        <div class="snippet">${shortAnswer}</div>
      `;

      feedbackList.appendChild(li);
    });
  }

  function statusLabel(s) {
    const st = s.status || "pending";
    if (st === "approved") return "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚úÖ";
    if (st === "needs-more-practice" || st === "needs-fix") return "–ù—É–∂–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–∞ ‚úèÔ∏è";
    return "–í –æ–∂–∏–¥–∞–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚è≥";
  }

  // --- –î–µ—Ç–∞–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ ---

  function showDetail(s) {
    detailBody.classList.remove("hidden");
    detailEmpty.classList.add("hidden");

    const courseTitle = s.courseTitle || s.courseId || "–ö—É—Ä—Å";
    const lessonTitle = s.lessonTitle || "–£—Ä–æ–∫";

    detailTitle.textContent = lessonTitle;
    detailSubtitle.textContent = "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫—É—Ä–∞—Ç–æ—Ä–∞ –ø–æ —ç—Ç–æ–º—É –∑–∞–¥–∞–Ω–∏—é.";

    detailCourseLesson.innerHTML = `
      <strong>${courseTitle}</strong><br/>
      ${lessonTitle}
    `;

    const answerText = (s.answerText || s.answer || "").toString().trim();
    detailAnswer.innerHTML = answerText
      ? answerText.replace(/\n/g, "<br/>")
      : "<em>–û—Ç–≤–µ—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞</em>";

    if (s.audioAnswerBase64) {
      const src = "data:audio/webm;base64," + s.audioAnswerBase64;
      detailAudio.src = src;
      detailAudioWrap.classList.remove("hidden");
    } else {
      detailAudioWrap.classList.add("hidden");
    }

    detailFeedback.innerHTML = s.feedback
      ? s.feedback.replace(/\n/g, "<br/>")
      : "<em>–ö—É—Ä–∞—Ç–æ—Ä –µ—â—ë –Ω–µ –æ—Å—Ç–∞–≤–∏–ª –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞, –≤—ã —É–≤–∏–¥–∏—Ç–µ –µ—ë –∑–¥–µ—Å—å.</em>";

    const st = s.status || "pending";
    const statusText = statusLabel(s);
    let badgeClass = "status-pending";
    if (st === "approved") badgeClass = "status-checked";
    else if (st === "needs-more-practice" || st === "needs-fix") badgeClass = "status-needs";

    detailStatusBadge.innerHTML = `
      <span class="badge-small ${badgeClass}">
        ${statusText}
      </span>
    `;

    // –ü–æ–¥—Å–∫–∞–∑–∫–∞
    if (st === "approved") {
      detailHighlight.textContent =
        "–ö—É—Ä–∞—Ç–æ—Ä —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ —Å —ç—Ç–∏–º –∑–∞–¥–∞–Ω–∏–µ–º –≤—ã —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å –æ—Ç–ª–∏—á–Ω–æ. –ú–æ–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ ‚Äî –∏ –≤—Ä–µ–º—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è —Å—é–¥–∞ –¥–ª—è —Å–≤–µ—Ä–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.";
    } else if (st === "needs-more-practice" || st === "needs-fix") {
      detailHighlight.textContent =
        "–ó–¥–µ—Å—å –µ—Å—Ç—å —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫—É—Ä–∞—Ç–æ—Ä–∞, –ø–µ—Ä–µ—á–∏—Ç–∞–π—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ ‚Äî –≤—ã —É–∂–µ –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ!";
    } else {
      detailHighlight.textContent =
        "–í–∞—à–µ –∑–∞–¥–∞–Ω–∏–µ —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä –æ—Å—Ç–∞–≤–∏—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.";
    }

    const createdAt = s.createdAt?.toDate ? s.createdAt.toDate() : null;
    const checkedAt = s.checkedAt?.toDate ? s.checkedAt.toDate() : null;

    detailMeta.textContent =
      "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: " +
      (createdAt ? createdAt.toLocaleString("ru-RU") : "‚Äî") +
      (checkedAt ? " ¬∑ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: " + checkedAt.toLocaleString("ru-RU") : "");
  }

  function clearDetail() {
    detailBody.classList.add("hidden");
    detailEmpty.classList.remove("hidden");
    detailTitle.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ";
    detailSubtitle.textContent =
      "–°–ø—Ä–∞–≤–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Å–≤–æ–π –æ—Ç–≤–µ—Ç, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–ª—å—à–µ.";
  }
</script>
</body>
</html>
