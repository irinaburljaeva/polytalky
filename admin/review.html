<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π ‚Äî PolyTalky</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />

  <style>
    :root {
      --bg: #fffaf0;
      --card-bg: #ffffff;
      --accent: #ffba08;
      --accent-soft: #ffe8a3;
      --accent-strong: #cf2c02;
      --text-main: #222222;
      --text-soft: #70737c;
      --border-soft: #e5e5e5;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.05);
      --radius-xl: 24px;
      --radius-l: 18px;
      --radius-m: 12px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #fff2d7, #fffaf0 50%, #ffffff 100%);
      color: var(--text-main);
    }

    a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header.admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
    }

    .logo-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-title {
      font-weight: 600;
      font-size: 18px;
    }

    .back-link {
      border-radius: var(--radius-pill);
      padding: 8px 16px;
      border: 1px solid var(--border-soft);
      font-size: 14px;
      background: rgba(255,255,255,0.8);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    .admin-user-pill {
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* –ö–ê–†–¢–û–ß–ö–ê –í–•–û–î–ê */

    .login-card {
      margin: 16px 0 18px;
      display: flex;
      justify-content: center;
    }

    .login-card-inner {
      max-width: 420px;
      width: 100%;
      background: rgba(255, 255, 255, 0.96);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px 20px;
    }

    .login-card-inner h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }

    .login-card-inner p {
      margin: 0 0 14px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .login-field label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--text-soft);
    }

    .login-field input {
      width: 100%;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      padding: 7px 11px;
      font-size: 13px;
    }

    .login-submit {
      margin-top: 6px;
      border-radius: var(--radius-pill);
      border: none;
      background: var(--accent-strong);
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      padding: 8px 14px;
      cursor: pointer;
    }

    .login-submit:hover {
      filter: brightness(1.03);
    }

    .login-error {
      margin: 6px 0 0;
      min-height: 16px;
      font-size: 12px;
      color: #b91c1c;
    }

    /* HERO */

    .hero {
      background: rgba(255, 255, 255, 0.8);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 20px 22px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      justify-content: space-between;
    }

    .hero-text h1 {
      margin: 0 0 4px;
      font-size: 22px;
    }

    .hero-text p {
      margin: 0;
      font-size: 14px;
      color: var(--text-soft);
    }

    .hero-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    .hero-stat-pill {
      border-radius: var(--radius-pill);
      border: 1px dashed var(--border-soft);
      background: #ffffff;
      font-size: 12px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* FILTERS */

    .filters {
      background: #ffffff;
      border-radius: var(--radius-l);
      box-shadow: var(--shadow-soft);
      padding: 12px 16px;
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
    }

    .filters-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .filters-group label {
      color: var(--text-soft);
      font-size: 12px;
    }

    select,
    input[type="text"] {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 13px;
      background: #ffffff;
    }

    .btn-refresh {
      border-radius: var(--radius-pill);
      border: none;
      background: var(--accent-soft);
      font-size: 13px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .btn-refresh span {
      display: inline-block;
      transform-origin: center;
    }

    /* COLUMNS */

    .columns {
      display: grid;
      grid-template-columns: minmax(0, 260px) minmax(0, 1fr);
      gap: 16px;
    }

    .courses-list {
      background: #ffffff;
      border-radius: var(--radius-l);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 10px;
      max-height: 420px;
      overflow: auto;
    }

    .courses-list h2 {
      margin: 0 0 8px;
      font-size: 15px;
    }

    .course-pill {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      margin-bottom: 6px;
      cursor: pointer;
    }

    .course-pill .title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 170px;
    }

    .course-pill .count {
      font-weight: 600;
      font-size: 12px;
    }

    .course-pill.active {
      background: #fffbeb;
      border: 1px solid #fde68a;
    }

    .course-pill.inactive {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .submissions {
      background: #ffffff;
      border-radius: var(--radius-l);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px;
      max-height: 520px;
      overflow: auto;
    }

    .submissions-empty {
      font-size: 14px;
      color: var(--text-soft);
      text-align: center;
      padding: 24px 0;
    }

    .lesson-group {
      margin-bottom: 14px;
    }

    .lesson-group h3 {
      margin: 0 0 6px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lesson-tag {
      font-size: 11px;
      border-radius: var(--radius-pill);
      padding: 2px 8px;
      background: #f3f4ff;
      color: #4338ca;
    }

    .submission-card {
      border-radius: var(--radius-m);
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
      background: #f9fafb;
    }

    .submission-main p {
      margin: 0 0 3px;
    }

    .submission-meta {
      font-size: 11px;
      color: var(--text-soft);
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      border-radius: var(--radius-pill);
      padding: 2px 8px;
      font-size: 11px;
      margin-top: 4px;
    }

    .status-pending {
      background: #fffbeb;
      color: #854d0e;
    }

    .status-approved {
      background: #ecfdf5;
      color: #166534;
    }

    .status-needs-fix {
      background: #fef2f2;
      color: #b91c1c;
    }

    .submission-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      justify-content: center;
      white-space: nowrap;
    }

    .btn-xs {
      border-radius: var(--radius-pill);
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .btn-xs.success {
      background: #ecfdf5;
      color: #166534;
      border-color: #bbf7d0;
    }

    .btn-xs.warn {
      background: #fef2f2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    /* –ú–û–î–ê–õ–ö–ê */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.28);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: var(--radius-xl);
      max-width: 640px;
      width: 100%;
      padding: 18px 18px 16px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.26);
      max-height: 80vh;
      overflow: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }

    .modal-section {
      margin-bottom: 10px;
      font-size: 13px;
    }

    .modal-section h3 {
      margin: 0 0 4px;
      font-size: 13px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .feedback-textarea {
      width: 100%;
      min-height: 80px;
      border-radius: var(--radius-m);
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      font-size: 13px;
      resize: vertical;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .modal-footer-left {
      font-size: 12px;
      color: var(--text-soft);
    }

    @media (max-width: 800px) {
      .columns {
        grid-template-columns: minmax(0, 1fr);
      }
      .courses-list {
        max-height: 200px;
      }
      .submissions {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="admin-header">
      <div class="logo-block">
        <div class="logo-circle">‚úèÔ∏è</div>
        <div>
          <div class="logo-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π</div>
          <div style="font-size:12px;color:var(--text-soft);">–ö—É—Ä–∞—Ç–æ—Ä—Å–∫–∞—è –∑–æ–Ω–∞ PolyTalky</div>
        </div>
      </div>

      <div class="admin-user-pill" id="adminUserInfo">
        –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è‚Ä¶
      </div>
    </header>

    <a href="/courses/english-intro/" class="back-link">
      ‚Üê –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É
    </a>

    <!-- –ö–ê–†–¢–û–ß–ö–ê –í–•–û–î–ê -->
    <section class="login-card" id="loginCard">
      <div class="login-card-inner">
        <h1>–í—Ö–æ–¥ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞</h1>
        <p>
          –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ –∞–∫–∫–∞—É–Ω—Ç–æ–º –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
          –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É—á–µ–Ω–∏–∫–∞–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.
        </p>

        <form id="loginForm" class="login-form">
          <div class="login-field">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" required placeholder="you@example.com" />
          </div>

          <div class="login-field">
            <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="loginPassword" required placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" />
          </div>

          <button type="submit" class="login-submit">–í–æ–π—Ç–∏</button>

          <p id="loginError" class="login-error" aria-live="polite"></p>
        </form>
      </div>
    </section>

    <!-- –ö–û–ù–¢–ï–ù–¢ –î–õ–Ø –ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–û–ì–û –ö–£–†–ê–¢–û–†–ê -->
    <div id="adminContent" style="display:none;">
      <section class="hero">
        <div class="hero-text">
          <h1>–í—Å–µ –∑–∞–¥–∞–Ω–∏—è —Å –∫—É—Ä—Å–æ–≤</h1>
          <p>–§–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ –∫—É—Ä—Å—É, —Å—Ç–∞—Ç—É—Å—É –∏ email, –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.</p>
        </div>
        <div class="hero-stats">
          <div class="hero-stat-pill">
            üîî –í –æ–∂–∏–¥–∞–Ω–∏–∏: <strong id="statPending">0</strong>
          </div>
          <div class="hero-stat-pill">
            ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã: <strong id="statChecked">0</strong>
          </div>
          <div class="hero-stat-pill">
            üìö –ö—É—Ä—Å–æ–≤ –≤ —Å–ø–∏—Å–∫–µ: <strong id="statCourses">0</strong>
          </div>
        </div>
      </section>

      <section class="filters">
        <div class="filters-group">
          <label for="filterCourse">–ö—É—Ä—Å:</label>
          <select id="filterCourse">
            <option value="all">–í—Å–µ –∫—É—Ä—Å—ã</option>
          </select>

          <label for="filterStatus">–°—Ç–∞—Ç—É—Å:</label>
          <select id="filterStatus">
            <option value="pending">–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</option>
            <option value="all">–í—Å–µ</option>
            <option value="approved">–û–¥–æ–±—Ä–µ–Ω—ã</option>
            <option value="needs-fix">–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏</option>
          </select>
        </div>

        <div class="filters-group">
          <label for="filterEmail">Email:</label>
          <input type="text" id="filterEmail" placeholder="–ø–æ–∏—Å–∫ –ø–æ email‚Ä¶" />
          <button class="btn-refresh" id="btnRefresh">
            <span>‚ü≥</span> –û–±–Ω–æ–≤–∏—Ç—å
          </button>
        </div>
      </section>

      <section class="columns">
        <aside class="courses-list" id="coursesList">
          <h2>–ö—É—Ä—Å—ã</h2>
        </aside>

        <div class="submissions" id="submissionsContainer">
          <div class="submissions-empty">
            –ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞–Ω–∏—è -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞</h2>
        <button class="modal-close" id="modalCloseBtn">&times;</button>
      </div>

      <div class="modal-section">
        <h3>–£—á–µ–Ω–∏–∫</h3>
        <div id="modalStudent"></div>
      </div>

      <div class="modal-section">
        <h3>–ó–∞–¥–∞–Ω–∏–µ</h3>
        <div id="modalTask"></div>
      </div>

      <div class="modal-section">
        <h3>–û—Ç–≤–µ—Ç</h3>
        <div id="modalAnswer"></div>
      </div>

      <div class="modal-section">
        <h3>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∫—É—Ä–∞—Ç–æ—Ä–∞</h3>
        <textarea id="modalFeedback" class="feedback-textarea" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —É—á–µ–Ω–∏–∫–∞‚Ä¶"></textarea>
      </div>

      <div class="modal-footer">
        <div class="modal-footer-left" id="modalMeta"></div>
        <div>
          <button class="btn-xs warn" id="btnNeedFixModal">–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏</button>
          <button class="btn-xs success" id="btnApproveModal">–û–¥–æ–±—Ä–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + –ª–æ–≥–∏–∫–∞ -->
  <!-- Firebase init -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAU_uMTePpKwVNZNhqk2pss2PuSitGfQI",
      authDomain: "polytalky-70999.firebaseapp.com",
      projectId: "polytalky-70999",
      storageBucket: "polytalky-70999.firebasestorage.app",
      messagingSenderId: "62407152289",
      appId: "1:62407152289:web:b0c0efdb2472f12b10d6e0"
    };

    window.firebaseApp  = initializeApp(firebaseConfig);
    window.firebaseAuth = getAuth(window.firebaseApp);
    window.firebaseDb   = getFirestore(window.firebaseApp);
  </script>

 <script type="module">
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        signOut
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      import {
        getFirestore,
        collection,
        collectionGroup,
        addDoc,
        serverTimestamp,
        getDocs,
        query,
        where,
        orderBy,
        doc,
        setDoc,
        arrayUnion,
        getDoc,
        updateDoc
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const auth = window.firebaseAuth;
      const db   = window.firebaseDb;


    const adminUserInfoEl      = document.getElementById("adminUserInfo");
    const filterCourseEl       = document.getElementById("filterCourse");
    const filterStatusEl       = document.getElementById("filterStatus");
    const filterEmailEl        = document.getElementById("filterEmail");
    const btnRefreshEl         = document.getElementById("btnRefresh");
    const coursesListEl        = document.getElementById("coursesList");
    const submissionsContainer = document.getElementById("submissionsContainer");

    const statPendingEl  = document.getElementById("statPending");
    const statCheckedEl  = document.getElementById("statChecked");
    const statCoursesEl  = document.getElementById("statCourses");

    const modalBackdrop   = document.getElementById("modalBackdrop");
    const modalTitleEl    = document.getElementById("modalTitle");
    const modalStudentEl  = document.getElementById("modalStudent");
    const modalTaskEl     = document.getElementById("modalTask");
    const modalAnswerEl   = document.getElementById("modalAnswer");
    const modalFeedbackEl = document.getElementById("modalFeedback");
    const modalMetaEl     = document.getElementById("modalMeta");
    const modalCloseBtn   = document.getElementById("modalCloseBtn");
    const btnApproveModal = document.getElementById("btnApproveModal");
    const btnNeedFixModal = document.getElementById("btnNeedFixModal");

    const loginCardEl     = document.getElementById("loginCard");
    const adminContentEl  = document.getElementById("adminContent");
    const loginFormEl     = document.getElementById("loginForm");
    const loginEmailEl    = document.getElementById("loginEmail");
    const loginPasswordEl = document.getElementById("loginPassword");
    const loginErrorEl    = document.getElementById("loginError");

    let currentUser = null;
    let currentSubmissions = [];
    let currentModalSubmissionId = null;
    let isAdminOrCurator = false;

   async function checkAdminClaims(user) {
  try {
    const dbUsers = collection(db, "users");

    const emailRef = user.email ? doc(dbUsers, user.email) : null;
    const uidRef   = user.uid   ? doc(dbUsers, user.uid)   : null;

    const [emailSnap, uidSnap] = await Promise.all([
      emailRef ? getDoc(emailRef) : Promise.resolve(null),
      uidRef   ? getDoc(uidRef)   : Promise.resolve(null),
    ]);

    const emailData = emailSnap && emailSnap.exists() ? (emailSnap.data() || {}) : {};
    const uidData   = uidSnap   && uidSnap.exists()   ? (uidSnap.data()   || {}) : {};

    const merged = { ...uidData, ...emailData };

    isAdminOrCurator = !!(merged.isAdmin === true || merged.isCurator === true);
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∫—É—Ä–∞—Ç–æ—Ä–∞:", e);
    isAdminOrCurator = false;
  }
}

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        currentUser = null;
        isAdminOrCurator = false;
        adminUserInfoEl.textContent = "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∫—É—Ä–∞—Ç–æ—Ä.";
        loginCardEl.style.display   = "flex";
        adminContentEl.style.display = "none";
        submissionsContainer.innerHTML =
          "<div class='submissions-empty'>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∑–∞–¥–∞–Ω–∏—è.</div>";
        return;
      }

      currentUser = user;
      adminUserInfoEl.textContent = user.email || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
      await checkAdminClaims(user);

      if (!isAdminOrCurator) {
        loginCardEl.style.display    = "none";
        adminContentEl.style.display = "none";
        adminUserInfoEl.textContent =
          (user.email || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å") + " ‚Äî –Ω–µ—Ç –ø—Ä–∞–≤ –∫—É—Ä–∞—Ç–æ—Ä–∞/–∞–¥–º–∏–Ω–∞.";
        // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ —É–≤–∏–¥–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
        submissionsContainer.innerHTML =
          "<div class='submissions-empty'>–£ —ç—Ç–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–¥–∞–Ω–∏–π. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</div>";
        return;
      }

      // –ï—Å—Ç—å –ø—Ä–∞–≤–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      loginCardEl.style.display    = "none";
      adminContentEl.style.display = "block";

      loadSubmissions();
    });

    // –í—Ö–æ–¥ –ø–æ email+–ø–∞—Ä–æ–ª—é
    loginFormEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginErrorEl.textContent = "";

      const email = loginEmailEl.value.trim();
      const pass  = loginPasswordEl.value;

      if (!email || !pass) {
        loginErrorEl.textContent = "–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å.";
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, pass);
        // –î–∞–ª—å—à–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç onAuthStateChanged
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", err);
        loginErrorEl.textContent =
          "–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email/–ø–∞—Ä–æ–ª—å –∏–ª–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.";
      }
    });

    btnRefreshEl.addEventListener("click", () => loadSubmissions());
    filterStatusEl.addEventListener("change", () => renderSubmissions());
    filterCourseEl.addEventListener("change", () => renderSubmissions());
    filterEmailEl.addEventListener("input",  () => renderSubmissions());

    modalCloseBtn.addEventListener("click", () => {
      modalBackdrop.classList.remove("visible");
      currentModalSubmissionId = null;
    });

    async function loadSubmissions() {
  if (!currentUser || !isAdminOrCurator) return;

  submissionsContainer.innerHTML =
    "<div class='submissions-empty'>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>";

  try {
    // —á–∏—Ç–∞–µ–º –í–°–ï answers –≤–æ –≤—Å–µ—Ö —É—Ä–æ–∫–∞—Ö
    let qRef = collectionGroup(db, "answers");

    // —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
    const statusValue = filterStatusEl.value;
    if (statusValue !== "all") {
      qRef = query(qRef, where("status", "==", statusValue));
    }

    const snap = await getDocs(qRef);

    currentSubmissions = snap.docs.map(d => ({
      id: d.id,
      path: d.ref.path, // –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
      ...d.data()
    }));

    buildCourseFilter(currentSubmissions);
    renderSubmissions();
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:", err);
    submissionsContainer.innerHTML =
      "<div class='submissions-empty'>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è.</div>";
  }
}

    function buildCourseFilter(submissions) {
      const byCourse = new Map();
      let pendingCount = 0;
      let checkedCount = 0;

      submissions.forEach(s => {
        const cid = s.courseId || "unknown";
        const title = s.courseTitle || cid;

        if (!byCourse.has(cid)) {
          byCourse.set(cid, { title, total: 0, pending: 0 });
        }

        const bucket = byCourse.get(cid);
        bucket.total += 1;
        if (s.status === "pending") {
          bucket.pending += 1;
          pendingCount++;
        } else {
          checkedCount++;
        }
      });

      statPendingEl.textContent = pendingCount;
      statCheckedEl.textContent = checkedCount;
      statCoursesEl.textContent = byCourse.size;

      const selected = filterCourseEl.value || "all";
      filterCourseEl.innerHTML = '<option value="all">–í—Å–µ –∫—É—Ä—Å—ã</option>';

      byCourse.forEach((bucket, cid) => {
        const opt = document.createElement("option");
        opt.value = cid;
        opt.textContent = `${bucket.title} (${bucket.pending || 0} –≤ –æ–∂–∏–¥–∞–Ω–∏–∏)`;
        filterCourseEl.appendChild(opt);
      });

      if ([...byCourse.keys()].includes(selected)) {
        filterCourseEl.value = selected;
      } else {
        filterCourseEl.value = "all";
      }

      coursesListEl.innerHTML = "<h2>–ö—É—Ä—Å—ã</h2>";

      const allPill = document.createElement("div");
      allPill.className =
        "course-pill " +
        (filterCourseEl.value === "all" ? "active" : "inactive");
      allPill.innerHTML = `
        <span class="title">–í—Å–µ –∫—É—Ä—Å—ã</span>
        <span class="count">${submissions.length}</span>
      `;
      allPill.addEventListener("click", () => {
        filterCourseEl.value = "all";
        renderSubmissions();
        buildCourseFilter(currentSubmissions);
      });
      coursesListEl.appendChild(allPill);

      byCourse.forEach((bucket, cid) => {
        const pill = document.createElement("div");
        pill.className =
          "course-pill " +
          (filterCourseEl.value === cid ? "active" : "inactive");
        pill.innerHTML = `
          <span class="title">${bucket.title}</span>
          <span class="count">${bucket.pending || 0}</span>
        `;
        pill.addEventListener("click", () => {
          filterCourseEl.value = cid;
          renderSubmissions();
          buildCourseFilter(currentSubmissions);
        });
        coursesListEl.appendChild(pill);
      });
    }

    function renderSubmissions() {
      if (!currentSubmissions.length) {
        submissionsContainer.innerHTML =
          "<div class='submissions-empty'>–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>";
        return;
      }

      const courseFilter = filterCourseEl.value;
      const statusFilter = filterStatusEl.value;
      const emailFilter  = filterEmailEl.value.trim().toLowerCase();

      let list = currentSubmissions.slice();

      if (courseFilter !== "all") {
        list = list.filter(
          s => (s.courseId || "unknown") === courseFilter
        );
      }

      if (statusFilter !== "all") {
        list = list.filter(
          s => (s.status || "pending") === statusFilter
        );
      }

      if (emailFilter) {
        list = list.filter(s =>
          (s.userEmail || "").toLowerCase().includes(emailFilter)
        );
      }

      if (!list.length) {
        submissionsContainer.innerHTML =
          "<div class='submissions-empty'>–ü–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –∑–∞–¥–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>";
        return;
      }

      const groups = new Map();
      list.forEach(s => {
        const lid = s.lessonId || "unknown-lesson";
        if (!groups.has(lid)) {
          groups.set(lid, {
            courseTitle: s.courseTitle || s.courseId || "–ö—É—Ä—Å",
            lessonTitle: s.lessonTitle || lid,
            items: [],
          });
        }
        groups.get(lid).items.push(s);
      });

      submissionsContainer.innerHTML = "";

      [...groups.values()].forEach(group => {
        const wrap = document.createElement("div");
        wrap.className = "lesson-group";

        wrap.innerHTML = `
          <h3>
            <span class="lesson-tag">${group.courseTitle}</span>
            ${group.lessonTitle}
          </h3>
        `;

        group.items.forEach(s => {
          const card = document.createElement("article");
          card.className = "submission-card";
          card.dataset.id = s.id;

          const statusClass =
            s.status === "approved"
              ? "status-approved"
              : s.status === "needs-fix"
              ? "status-needs-fix"
              : "status-pending";

          const createdAt = s.createdAt?.toDate ? s.createdAt.toDate() : null;
          const createdStr = createdAt
            ? createdAt.toLocaleString("ru-RU")
            : "‚Äî";

          const fullText = (s.answerText || s.answer || "").toString();
          const shortAnswer =
            fullText.slice(0, 120).trim() +
            (fullText.length > 120 ? "‚Ä¶" : "");

          card.innerHTML = `
            <div class="submission-main">
              <p><strong>${s.userEmail || "–ë–µ–∑ email"}</strong></p>
              <p class="submission-meta">
                –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${createdStr} ¬∑ –¢–∏–ø: ${s.answerType || "‚Äî"}
              </p>
              <p>${shortAnswer || "<em>–û—Ç–≤–µ—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞</em>"}</p>
              <div class="status-chip ${statusClass}">
                –°—Ç–∞—Ç—É—Å: ${labelStatus(s.status)}
              </div>
            </div>
            <div class="submission-actions">
              <button class="btn-xs" data-action="open">–û—Ç–∫—Ä—ã—Ç—å</button>
              <button class="btn-xs success" data-action="approve">–û–¥–æ–±—Ä–∏—Ç—å</button>
              <button class="btn-xs warn" data-action="needs-fix">–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏</button>
            </div>
          `;

          card.addEventListener("click", (e) => {
            const action = e.target.dataset.action;
            if (!action) return;
            e.stopPropagation();

            if (action === "open") {
              openModalForSubmission(s);
            } else if (action === "approve") {
              updateSubmissionStatus(s.id, "approved", s.feedback || "");
            } else if (action === "needs-fix") {
              updateSubmissionStatus(s.id, "needs-fix", s.feedback || "");
            }
          });

          wrap.appendChild(card);
        });

        submissionsContainer.appendChild(wrap);
      });
    }

    function labelStatus(status) {
      if (status === "approved") return "–û–¥–æ–±—Ä–µ–Ω–æ";
      if (status === "needs-fix") return "–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏";
      return "–û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏";
    }

    function openModalForSubmission(s) {
      currentModalSubmissionId = s.id;

      modalTitleEl.textContent = s.lessonTitle || "–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞";
      modalStudentEl.innerHTML = `
        <strong>${s.userEmail || "–ë–µ–∑ email"}</strong><br/>
        –ö—É—Ä—Å: ${s.courseTitle || s.courseId || "‚Äî"}<br/>
        –¢–∏–ø: ${s.answerType || "‚Äî"}
      `;
      modalTaskEl.textContent =
        s.taskText ||
        "–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∑–¥–Ω–µ–µ).";

      const textAnswer = (s.answerText || s.answer || "").trim();
      modalAnswerEl.innerHTML = textAnswer
        ? `<p>${textAnswer.replace(/\n/g, "<br/>")}</p>`
        : "<em>–û—Ç–≤–µ—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞</em>";

      modalFeedbackEl.value = s.feedback || "";
      const createdAt = s.createdAt?.toDate ? s.createdAt.toDate() : null;
      const checkedAt = s.checkedAt?.toDate ? s.checkedAt.toDate() : null;

      modalMetaEl.textContent = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${
        createdAt ? createdAt.toLocaleString("ru-RU") : "‚Äî"
      }${
        checkedAt ? " ¬∑ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: " + checkedAt.toLocaleString("ru-RU") : ""
      }`;

      btnApproveModal.onclick = () => {
        updateSubmissionStatus(
          currentModalSubmissionId,
          "approved",
          modalFeedbackEl.value
        );
      };

      btnNeedFixModal.onclick = () => {
        updateSubmissionStatus(
          currentModalSubmissionId,
          "needs-fix",
          modalFeedbackEl.value
        );
      };

      modalBackdrop.classList.add("visible");
    }

   async function updateSubmissionStatus(id, newStatus, feedbackText) {
  if (!id) return;

  const sub = currentSubmissions.find(s => s.id === id);
  if (!sub || !sub.path) return;

  try {
    const ref = doc(db, sub.path); // –ø—É—Ç—å –≤–∏–¥–∞ lessonSubmissions/lesson-1/answers/ans123
    const payload = {
      status: newStatus,
      checkedAt: new Date()
    };

    if (typeof feedbackText === "string") {
      payload.feedback = feedbackText;
    }

    await updateDoc(ref, payload);

    modalBackdrop.classList.remove("visible");
    currentModalSubmissionId = null;
    await loadSubmissions();

  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:", err);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
  }
}
  </script>
</body>
</html>
