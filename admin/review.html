<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π ‚Äî PolyTalky</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- –®—Ä–∏—Ñ—Ç—ã –∏ –±–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å –ø–æ—Ö–æ–∂–∏–π –Ω–∞ –∫—É—Ä—Å -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />

  <style>
    :root {
      --bg: #fffaf0;
      --card-bg: #ffffff;
      --accent: #ffba08;
      --accent-soft: #ffe8a3;
      --accent-strong: #cf2c02;
      --text-main: #222222;
      --text-soft: #70737c;
      --border-soft: #e5e5e5;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.05);
      --radius-xl: 24px;
      --radius-l: 18px;
      --radius-m: 12px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #fff2d7, #fffaf0 50%, #ffffff 100%);
      color: var(--text-main);
    }

    a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header.admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 12px;
    }

    .logo-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-title {
      font-weight: 600;
      font-size: 18px;
    }

    .back-link {
      border-radius: var(--radius-pill);
      padding: 8px 16px;
      border: 1px solid var(--border-soft);
      font-size: 14px;
      background: rgba(255,255,255,0.8);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .admin-user-pill {
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* HERO */

    .hero {
      background: rgba(255, 255, 255, 0.8);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 20px 22px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      justify-content: space-between;
    }

    .hero-text h1 {
      font-size: 22px;
      margin: 0 0 6px;
    }

    .hero-text p {
      margin: 0;
      font-size: 14px;
      color: var(--text-soft);
    }

    .hero-stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 13px;
    }

    .hero-stat-pill {
      background: #fff9e5;
      border-radius: var(--radius-pill);
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #ffe4a6;
    }

    .hero-stat-pill strong {
      font-weight: 600;
      color: var(--accent-strong);
    }

    /* –§–ò–õ–¨–¢–†–´ */

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    .filters-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .filters label {
      font-size: 13px;
      color: var(--text-soft);
    }

    .filters select,
    .filters input[type="text"] {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      padding: 6px 12px;
      font-size: 13px;
      background: #ffffff;
      min-width: 160px;
    }

    .btn-refresh {
      border-radius: var(--radius-pill);
      background: var(--accent);
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-refresh span {
      font-size: 14px;
    }

    /* –°–ü–ò–°–û–ö –ó–ê–î–ê–ù–ò–ô */

    .columns {
      display: grid;
      grid-template-columns: minmax(0, 250px) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ */

    .courses-list {
      background: rgba(255,255,255,0.85);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 12px 12px 14px;
      max-height: 520px;
      overflow-y: auto;
    }

    .courses-list h2 {
      font-size: 14px;
      margin: 0 0 8px;
      color: var(--text-soft);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .course-pill {
      border-radius: var(--radius-l);
      padding: 8px 10px;
      margin-bottom: 6px;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .course-pill span.title {
      font-weight: 500;
    }

    .course-pill span.count {
      background: #fff3cc;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      color: var(--accent-strong);
    }

    .course-pill.active {
      background: #fff3cc;
      border-color: #ffdd7a;
    }

    .course-pill.inactive {
      opacity: 0.6;
    }

    /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ */

    .submissions {
      background: rgba(255,255,255,0.9);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 20px;
      max-height: 520px;
      overflow-y: auto;
    }

    .submissions-empty {
      font-size: 14px;
      color: var(--text-soft);
      text-align: center;
      padding: 40px 0;
    }

    .lesson-group {
      margin-bottom: 16px;
    }

    .lesson-group h3 {
      font-size: 14px;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .lesson-tag {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4ff;
      color: #5553c3;
    }

    .submission-card {
      border-radius: var(--radius-l);
      border: 1px solid var(--border-soft);
      padding: 10px 12px;
      font-size: 13px;
      margin-bottom: 8px;
      background: #ffffff;
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
    }

    .submission-main p {
      margin: 2px 0;
    }

    .submission-meta {
      font-size: 12px;
      color: var(--text-soft);
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
    }

    .status-pending {
      background: #fff3cc;
      color: #b15a00;
    }

    .status-approved {
      background: #dcfce7;
      color: #166534;
    }

    .status-needs-fix {
      background: #fee2e2;
      color: #b91c1c;
    }

    .submission-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .btn-xs {
      border-radius: var(--radius-pill);
      padding: 4px 10px;
      border: 1px solid var(--border-soft);
      font-size: 12px;
      cursor: pointer;
      background: #ffffff;
    }

    .btn-xs.primary {
      background: var(--accent);
      border-color: #ffdd7a;
      font-weight: 600;
    }

    .btn-xs.success {
      background: #16a34a;
      color: #ffffff;
      border-color: #16a34a;
    }

    .btn-xs.warn {
      background: #f97316;
      color: #ffffff;
      border-color: #f97316;
    }

    /* –ú–û–î–ê–õ–ö–ê –î–õ–Ø –ü–†–û–°–ú–û–¢–†–ê/–§–ò–î–ë–ï–ö–ê */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.28);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: var(--radius-xl);
      max-width: 640px;
      width: 100%;
      padding: 18px 18px 16px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.26);
      max-height: 80vh;
      overflow: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }

    .modal-section {
      margin-bottom: 10px;
      font-size: 13px;
    }

    .modal-section h3 {
      margin: 0 0 4px;
      font-size: 13px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .feedback-textarea {
      width: 100%;
      min-height: 80px;
      border-radius: var(--radius-m);
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      font-size: 13px;
      resize: vertical;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .modal-footer-left {
      font-size: 12px;
      color: var(--text-soft);
    }

    @media (max-width: 800px) {
      .columns {
        grid-template-columns: minmax(0, 1fr);
      }
      .courses-list {
        max-height: 200px;
      }
      .submissions {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="admin-header">
      <div class="logo-block">
        <div class="logo-circle">‚úèÔ∏è</div>
        <div>
          <div class="logo-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π</div>
          <div style="font-size:12px;color:var(--text-soft);">–ö—É—Ä–∞—Ç–æ—Ä—Å–∫–∞—è –∑–æ–Ω–∞ PolyTalky</div>
        </div>
      </div>

      <div class="admin-user-pill" id="adminUserInfo">
        –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è‚Ä¶
      </div>
    </header>

    <a href="/courses/english-intro/" class="back-link">
      ‚Üê –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É
    </a>

    <section class="hero">
      <div class="hero-text">
        <h1>–í—Å–µ –∑–∞–¥–∞–Ω–∏—è —Å –∫—É—Ä—Å–æ–≤</h1>
        <p>–§–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ –∫—É—Ä—Å—É, —Å—Ç–∞—Ç—É—Å—É –∏ email, –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.</p>
      </div>
      <div class="hero-stats">
        <div class="hero-stat-pill">
          üîî –í –æ–∂–∏–¥–∞–Ω–∏–∏: <strong id="statPending">0</strong>
        </div>
        <div class="hero-stat-pill">
          ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã: <strong id="statChecked">0</strong>
        </div>
        <div class="hero-stat-pill">
          üìö –ö—É—Ä—Å–æ–≤ –≤ —Å–ø–∏—Å–∫–µ: <strong id="statCourses">0</strong>
        </div>
      </div>
    </section>

    <section class="filters">
      <div class="filters-group">
        <label for="filterCourse">–ö—É—Ä—Å:</label>
        <select id="filterCourse">
          <option value="all">–í—Å–µ –∫—É—Ä—Å—ã</option>
        </select>

        <label for="filterStatus">–°—Ç–∞—Ç—É—Å:</label>
        <select id="filterStatus">
          <option value="pending">–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</option>
          <option value="all">–í—Å–µ</option>
          <option value="approved">–û–¥–æ–±—Ä–µ–Ω—ã</option>
          <option value="needs-fix">–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏</option>
        </select>
      </div>

      <div class="filters-group">
        <label for="filterEmail">Email:</label>
        <input type="text" id="filterEmail" placeholder="–ø–æ–∏—Å–∫ –ø–æ email‚Ä¶" />
        <button class="btn-refresh" id="btnRefresh">
          <span>‚ü≥</span> –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>
    </section>

    <section class="columns">
      <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –∫—É—Ä—Å—ã + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á -->
      <aside class="courses-list" id="coursesList">
        <h2>–ö—É—Ä—Å—ã</h2>
        <!-- —Å—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç –ø–∏–ª—é–ª–∏ –∫—É—Ä—Å–æ–≤ -->
      </aside>

      <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –∑–∞–¥–∞–Ω–∏—è -->
      <div class="submissions" id="submissionsContainer">
        <div class="submissions-empty">
          –ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.
        </div>
      </div>
    </section>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞–Ω–∏—è -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞</h2>
        <button class="modal-close" id="modalCloseBtn">&times;</button>
      </div>

      <div class="modal-section">
        <h3>–£—á–µ–Ω–∏–∫</h3>
        <div id="modalStudent"></div>
      </div>

      <div class="modal-section">
        <h3>–ó–∞–¥–∞–Ω–∏–µ</h3>
        <div id="modalTask"></div>
      </div>

      <div class="modal-section">
        <h3>–û—Ç–≤–µ—Ç</h3>
        <div id="modalAnswer"></div>
      </div>

      <div class="modal-section">
        <h3>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∫—É—Ä–∞—Ç–æ—Ä–∞</h3>
        <textarea id="modalFeedback" class="feedback-textarea" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —É—á–µ–Ω–∏–∫–∞‚Ä¶"></textarea>
      </div>

      <div class="modal-footer">
        <div class="modal-footer-left" id="modalMeta"></div>
        <div>
          <button class="btn-xs warn" id="btnNeedFixModal">–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏</button>
          <button class="btn-xs success" id="btnApproveModal">–û–¥–æ–±—Ä–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + –ª–æ–≥–∏–∫–∞ -->
  <script type="module">
    // --- Firebase imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      updateDoc,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // TODO: –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ –¢–í–û–ô —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      // –∏ —Ç.–¥.
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const adminUserInfoEl      = document.getElementById("adminUserInfo");
    const filterCourseEl       = document.getElementById("filterCourse");
    const filterStatusEl       = document.getElementById("filterStatus");
    const filterEmailEl        = document.getElementById("filterEmail");
    const btnRefreshEl         = document.getElementById("btnRefresh");
    const coursesListEl        = document.getElementById("coursesList");
    const submissionsContainer = document.getElementById("submissionsContainer");

    const statPendingEl  = document.getElementById("statPending");
    const statCheckedEl  = document.getElementById("statChecked");
    const statCoursesEl  = document.getElementById("statCourses");

    // –ú–æ–¥–∞–ª–∫–∞
    const modalBackdrop   = document.getElementById("modalBackdrop");
    const modalCloseBtn   = document.getElementById("modalCloseBtn");
    const modalTitleEl    = document.getElementById("modalTitle");
    const modalStudentEl  = document.getElementById("modalStudent");
    const modalTaskEl     = document.getElementById("modalTask");
    const modalAnswerEl   = document.getElementById("modalAnswer");
    const modalFeedbackEl = document.getElementById("modalFeedback");
    const modalMetaEl     = document.getElementById("modalMeta");
    const btnApproveModal = document.getElementById("btnApproveModal");
    const btnNeedFixModal = document.getElementById("btnNeedFixModal");

    let currentUser = null;
    let currentSubmissions = [];
    let currentModalSubmissionId = null;

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        adminUserInfoEl.textContent = "–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç —Å –ø—Ä–∞–≤–∞–º–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞/–∞–¥–º–∏–Ω–∞.";
        return;
      }
      currentUser = user;
      adminUserInfoEl.textContent = user.email || "–ö—É—Ä–∞—Ç–æ—Ä";

      // –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É; –ø—Ä–∞–≤–∞ —É–∂–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤ Rules
      loadSubmissions();
    });

    btnRefreshEl.addEventListener("click", () => loadSubmissions());
    filterStatusEl.addEventListener("change", () => renderSubmissions());
    filterCourseEl.addEventListener("change", () => renderSubmissions());
    filterEmailEl.addEventListener("input",  () => renderSubmissions());

    modalCloseBtn.addEventListener("click", () => {
      modalBackdrop.classList.remove("visible");
      currentModalSubmissionId = null;
    });

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π –∏–∑ Firestore ---

    async function loadSubmissions() {
      if (!currentUser) return;

      submissionsContainer.innerHTML = "<div class='submissions-empty'>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>";

      try {
        let qRef = collection(db, "lessonSubmissions");

        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–ø—Ä–æ—Å–∞
        const statusValue = filterStatusEl.value;
        if (statusValue !== "all") {
          qRef = query(qRef, where("status", "==", statusValue), orderBy("createdAt", "desc"));
        } else {
          qRef = query(qRef, orderBy("createdAt", "desc"));
        }

        const snap = await getDocs(qRef);
        currentSubmissions = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        buildCourseFilter(currentSubmissions);
        renderSubmissions();
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:", err);
        submissionsContainer.innerHTML = "<div class='submissions-empty'>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è.</div>";
      }
    }

    // --- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫—É—Ä—Å–æ–≤ —Å–ª–µ–≤–∞ + —Å–µ–ª–µ–∫—Ç –∫—É—Ä—Å–∞ —Å–≤–µ—Ä—Ö—É ---

    function buildCourseFilter(submissions) {
      const byCourse = new Map();
      let pendingCount = 0;
      let checkedCount = 0;

      submissions.forEach(s => {
        const cid = s.courseId || "unknown";
        const title = s.courseTitle || cid;

        if (!byCourse.has(cid)) {
          byCourse.set(cid, { title, total: 0, pending: 0 });
        }

        const bucket = byCourse.get(cid);
        bucket.total += 1;
        if (s.status === "pending") {
          bucket.pending += 1;
          pendingCount++;
        } else {
          checkedCount++;
        }
      });

      // hero-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      statPendingEl.textContent  = pendingCount;
      statCheckedEl.textContent  = checkedCount;
      statCoursesEl.textContent  = byCourse.size;

      // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –∫—É—Ä—Å–∞
      const selected = filterCourseEl.value || "all";
      filterCourseEl.innerHTML = '<option value="all">–í—Å–µ –∫—É—Ä—Å—ã</option>';

      byCourse.forEach((bucket, cid) => {
        const opt = document.createElement("option");
        opt.value = cid;
        opt.textContent = `${bucket.title} (${bucket.pending || 0} –≤ –æ–∂–∏–¥–∞–Ω–∏–∏)`;
        filterCourseEl.appendChild(opt);
      });

      if ([...byCourse.keys()].includes(selected)) {
        filterCourseEl.value = selected;
      } else {
        filterCourseEl.value = "all";
      }

      // —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ —Å–ª–µ–≤–∞
      coursesListEl.innerHTML = "<h2>–ö—É—Ä—Å—ã</h2>";

      // "–í—Å–µ –∫—É—Ä—Å—ã"
      const allPill = document.createElement("div");
      allPill.className = "course-pill " + (filterCourseEl.value === "all" ? "active" : "inactive");
      allPill.innerHTML = `
        <span class="title">–í—Å–µ –∫—É—Ä—Å—ã</span>
        <span class="count">${submissions.length}</span>
      `;
      allPill.addEventListener("click", () => {
        filterCourseEl.value = "all";
        renderSubmissions();
        buildCourseFilter(currentSubmissions); // –æ–±–Ω–æ–≤–∏—Ç—å —Ö–∞–π–ª–∞–π—Ç
      });
      coursesListEl.appendChild(allPill);

      byCourse.forEach((bucket, cid) => {
        const pill = document.createElement("div");
        pill.className = "course-pill " + (filterCourseEl.value === cid ? "active" : "inactive");
        pill.innerHTML = `
          <span class="title">${bucket.title}</span>
          <span class="count">${bucket.pending || 0}</span>
        `;
        pill.addEventListener("click", () => {
          filterCourseEl.value = cid;
          renderSubmissions();
          buildCourseFilter(currentSubmissions); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ active
        });
        coursesListEl.appendChild(pill);
      });
    }

    // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ ---

    function renderSubmissions() {
      if (!currentSubmissions.length) {
        submissionsContainer.innerHTML = "<div class='submissions-empty'>–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>";
        return;
      }

      const courseFilter = filterCourseEl.value;
      const statusFilter = filterStatusEl.value;
      const emailFilter  = filterEmailEl.value.trim().toLowerCase();

      let list = currentSubmissions.slice();

      if (courseFilter !== "all") {
        list = list.filter(s => (s.courseId || "unknown") === courseFilter);
      }

      if (statusFilter !== "all") {
        list = list.filter(s => (s.status || "pending") === statusFilter);
      }

      if (emailFilter) {
        list = list.filter(s =>
          (s.userEmail || "").toLowerCase().includes(emailFilter)
        );
      }

      if (!list.length) {
        submissionsContainer.innerHTML = "<div class='submissions-empty'>–ü–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –∑–∞–¥–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>";
        return;
      }

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º: –∫—É—Ä—Å -> —É—Ä–æ–∫
      const groups = new Map(); // key: lessonId, value: { courseTitle, lessonTitle, items: [] }
      list.forEach(s => {
        const lid = s.lessonId || "unknown-lesson";
        if (!groups.has(lid)) {
          groups.set(lid, {
            courseTitle: s.courseTitle || s.courseId || "–ö—É—Ä—Å",
            lessonTitle: s.lessonTitle || lid,
            items: [],
          });
        }
        groups.get(lid).items.push(s);
      });

      submissionsContainer.innerHTML = "";

      [...groups.values()].forEach(group => {
        const wrap = document.createElement("div");
        wrap.className = "lesson-group";

        wrap.innerHTML = `
          <h3>
            <span class="lesson-tag">${group.courseTitle}</span>
            ${group.lessonTitle}
          </h3>
        `;

        group.items.forEach(s => {
          const card = document.createElement("article");
          card.className = "submission-card";
          card.dataset.id = s.id;

          const statusClass =
            s.status === "approved"
              ? "status-approved"
              : s.status === "needs-fix"
              ? "status-needs-fix"
              : "status-pending";

          const createdAt = s.createdAt?.toDate ? s.createdAt.toDate() : null;
          const createdStr = createdAt
            ? createdAt.toLocaleString("ru-RU")
            : "‚Äî";

          const shortAnswer =
            (s.answerText || s.answer || "")
              .toString()
              .slice(0, 120)
              .trim() + ((s.answerText || s.answer || "").length > 120 ? "‚Ä¶" : "");

          card.innerHTML = `
            <div class="submission-main">
              <p><strong>${s.userEmail || "–ë–µ–∑ email"}</strong></p>
              <p class="submission-meta">
                –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${createdStr} ¬∑ –¢–∏–ø: ${s.answerType || "‚Äî"}
              </p>
              <p>${shortAnswer || "<em>–û—Ç–≤–µ—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞</em>"}</p>
              <div class="status-chip ${statusClass}">
                –°—Ç–∞—Ç—É—Å: ${labelStatus(s.status)}
              </div>
            </div>
            <div class="submission-actions">
              <button class="btn-xs" data-action="open">–û—Ç–∫—Ä—ã—Ç—å</button>
              <button class="btn-xs success" data-action="approve">–û–¥–æ–±—Ä–∏—Ç—å</button>
              <button class="btn-xs warn" data-action="needs-fix">–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏</button>
            </div>
          `;

          card.addEventListener("click", (e) => {
            const action = e.target.dataset.action;
            if (!action) return;

            if (action === "open") {
              openModalForSubmission(s);
            } else if (action === "approve") {
              updateSubmissionStatus(s.id, "approved");
            } else if (action === "needs-fix") {
              updateSubmissionStatus(s.id, "needs-fix");
            }
          });

          wrap.appendChild(card);
        });

        submissionsContainer.appendChild(wrap);
      });
    }

    function labelStatus(status) {
      if (status === "approved") return "–û–¥–æ–±—Ä–µ–Ω–æ";
      if (status === "needs-fix") return "–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏";
      return "–û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏";
    }

    // --- –ú–æ–¥–∞–ª–∫–∞: –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞/—Ñ–∏–¥–±–µ–∫–∞ ---

    function openModalForSubmission(s) {
      currentModalSubmissionId = s.id;

      modalTitleEl.textContent = s.lessonTitle || "–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞";
      modalStudentEl.innerHTML = `
        <strong>${s.userEmail || "–ë–µ–∑ email"}</strong><br/>
        –ö—É—Ä—Å: ${s.courseTitle || s.courseId || "‚Äî"}<br/>
        –¢–∏–ø: ${s.answerType || "‚Äî"}
      `;
      modalTaskEl.textContent = s.taskText || "–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∑–¥–Ω–µ–µ).";

      const textAnswer = (s.answerText || s.answer || "").trim();
      modalAnswerEl.innerHTML = textAnswer
        ? `<p>${textAnswer.replace(/\n/g, "<br/>")}</p>`
        : "<em>–û—Ç–≤–µ—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞</em>";

      modalFeedbackEl.value = s.feedback || "";
      const createdAt = s.createdAt?.toDate ? s.createdAt.toDate() : null;
      const checkedAt = s.checkedAt?.toDate ? s.checkedAt.toDate() : null;

      modalMetaEl.textContent = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${
        createdAt ? createdAt.toLocaleString("ru-RU") : "‚Äî"
      }${
        checkedAt ? " ¬∑ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: " + checkedAt.toLocaleString("ru-RU") : ""
      }`;

      btnApproveModal.onclick = () => {
        updateSubmissionStatus(currentModalSubmissionId, "approved", modalFeedbackEl.value);
      };

      btnNeedFixModal.onclick = () => {
        updateSubmissionStatus(currentModalSubmissionId, "needs-fix", modalFeedbackEl.value);
      };

      modalBackdrop.classList.add("visible");
    }

    async function updateSubmissionStatus(id, newStatus, feedbackText) {
      if (!id) return;
      try {
        const ref = doc(db, "lessonSubmissions", id);
        const payload = {
          status: newStatus,
          checkedAt: new Date()
        };
        if (typeof feedbackText === "string") {
          payload.feedback = feedbackText;
        }
        await updateDoc(ref, payload);
        modalBackdrop.classList.remove("visible");
        currentModalSubmissionId = null;
        await loadSubmissions(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å–ø–∏—Å–æ–∫ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:", err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
      }
    }
  </script>
</body>
</html>
