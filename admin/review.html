<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>PolyTalky ¬∑ –ö—É—Ä–∞—Ç–æ—Ä—Å–∫–∞—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- –®—Ä–∏—Ñ—Ç—ã, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ç–≤–æ–∏ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --ink: #222222;
      --ink-2: #6B7280;
      --accent: #FFC94A;
      --accent-2: #FFB347;
      --bg-soft: #FFF6DD;
      --danger: #F97373;
      --ok: #22C55E;
      --card-radius: 1.4rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #FFEBCD 0, #FFFDF7 45%, #FFF6DD 100%);
      color: var(--ink);
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(16px);
      background: linear-gradient(to right, rgba(255, 246, 221, 0.9), rgba(255, 255, 255, 0.9));
      border-bottom: 1px solid rgba(0, 0, 0, 0.03);
    }

    .header-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 700;
      font-size: 1rem;
    }

    .brand-logo {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #FFFFFF 0, #FFE09C 45%, #FFB347 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .brand-sub {
      font-size: 0.8rem;
      color: var(--ink-2);
      font-weight: 500;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.8rem;
      color: var(--ink-2);
    }

    .tag-pill {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background: #FFF;
      border: 1px dashed rgba(0,0,0,0.08);
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--ink-2);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn-ghost {
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #FFF;
      font-size: 0.78rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .btn-ghost:hover {
      background: #FFF7E1;
    }

    .btn-main {
      padding: 0.5rem 1.1rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #111827;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      box-shadow: 0 10px 25px rgba(255,170,70,0.35);
    }

    .btn-main:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    /* LAYOUT */

    .main {
      flex: 1;
      max-width: 1120px;
      margin: 0 auto;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .hero-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: stretch;
    }

    .hero-card {
      flex: 1 1 260px;
      background: rgba(255,255,255,0.9);
      border-radius: var(--card-radius);
      padding: 1rem 1.1rem;
      box-shadow: 0 18px 45px rgba(15,23,42,0.05);
      position: relative;
      overflow: hidden;
    }

    .hero-card::before {
      content: "";
      position: absolute;
      right: -40px;
      top: -40px;
      width: 150px;
      height: 150px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #FFF7E1 0, #FFD891 45%, #FFB347 100%);
      opacity: 0.65;
    }

    .hero-title {
      position: relative;
      font-size: 1.4rem;
      margin: 0 0 .25rem;
    }

    .hero-title span {
      color: #F97316;
    }

    .hero-text {
      position: relative;
      font-size: 0.86rem;
      color: var(--ink-2);
      line-height: 1.5;
      max-width: 28rem;
    }

    .stat-row {
      position: relative;
      margin-top: 0.75rem;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      font-size: 0.75rem;
      color: var(--ink-2);
    }

    .stat-pill {
      padding: 0.2rem 0.65rem;
      border-radius: 999px;
      background: #FFF7E1;
      border: 1px solid #FFE1A7;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .hero-side {
      flex: 0 0 260px;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .hero-metric {
      background: rgba(255,255,255,0.9);
      border-radius: var(--card-radius);
      padding: 0.9rem 1rem;
      box-shadow: 0 14px 30px rgba(148,163,184,0.25);
      font-size: 0.8rem;
    }

    .hero-metric h3 {
      margin: 0 0 .4rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
    }

    .hero-metric h3 span:last-child {
      font-size: 0.72rem;
      color: var(--ink-2);
      font-weight: 500;
    }

    .metric-bar {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: #F3F4F6;
      overflow: hidden;
      margin-top: 0.3rem;
    }

    .metric-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #FCD34D, #F97316);
      width: 60%;
    }

    /* TABS */

    .tabs-row {
      margin-top: 0.5rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: var(--ink-2);
    }

    .tab-btn--active {
      background: #FFF;
      border-color: #FFE1A7;
      color: var(--ink);
      box-shadow: 0 8px 18px rgba(15,23,42,0.06);
    }

    /* CONTENT GRID */

    .content-grid {
      margin-top: 0.5rem;
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr);
      gap: 1rem;
      align-items: flex-start;
    }

    @media (max-width: 820px) {
      .content-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .hero-row {
        flex-direction: column;
      }
      .hero-side {
        flex: 1 1 auto;
      }
    }

    .card {
      background: rgba(255,255,255,0.95);
      border-radius: var(--card-radius);
      padding: 0.9rem 1rem;
      box-shadow: 0 14px 35px rgba(148,163,184,0.18);
      min-height: 220px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.6rem;
    }

    .card-header h3 {
      margin: 0;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .card-header p {
      margin: 0;
      font-size: 0.75rem;
      color: var(--ink-2);
    }

    .filter-row {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
    }

    .filter-row select {
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #E5E7EB;
      background: #FFF;
      font-size: 0.75rem;
    }

    .chip {
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      background: #F3F4F6;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .chip--ok {
      background: #DCFCE7;
      color: #166534;
    }

    .chip--warn {
      background: #FEF3C7;
      color: #92400E;
    }

    .chip--danger {
      background: #FEE2E2;
      color: #991B1B;
    }

    /* LISTS */

    .list {
      margin: 0;
      padding: 0;
      list-style: none;
      max-height: 360px;
      overflow: auto;
      scrollbar-width: thin;
    }

    .list-item {
      border-radius: 1rem;
      border: 1px solid #E5E7EB;
      padding: 0.55rem 0.7rem;
      font-size: 0.78rem;
      display: flex;
      flex-direction: column;
      gap: 0.18rem;
      cursor: pointer;
      background: #FFF;
    }

    .list-item + .list-item {
      margin-top: 0.4rem;
    }

    .list-item:hover {
      border-color: #FACC15;
      box-shadow: 0 8px 20px rgba(248,250,252,0.9);
      background: #FFFBEB;
    }

    .item-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
    }

    .item-title {
      font-weight: 600;
    }

    .item-meta {
      font-size: 0.72rem;
      color: var(--ink-2);
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem 0.4rem;
    }

    /* DETAIL PANE */

    .detail-empty {
      font-size: 0.8rem;
      color: var(--ink-2);
      padding-top: 0.4rem;
    }

    .detail-section {
      margin-bottom: 0.6rem;
    }

    .detail-section h4 {
      margin: 0 0 0.2rem;
      font-size: 0.82rem;
    }

    .detail-section p {
      margin: 0;
      font-size: 0.78rem;
      color: var(--ink-2);
      line-height: 1.5;
      white-space: pre-wrap;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 0.9rem;
      border: 1px solid #E5E7EB;
      padding: 0.5rem 0.7rem;
      font-size: 0.78rem;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #F59E0B;
      box-shadow: 0 0 0 1px rgba(245,158,11,0.35);
    }

    .detail-actions {
      margin-top: 0.5rem;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .status-select {
      padding: 0.3rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #E5E7EB;
      background: #FFF;
      font-size: 0.75rem;
    }

    audio {
      width: 100%;
      margin-top: 0.25rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      background: #EEF2FF;
      color: #3730A3;
      font-size: 0.7rem;
      gap: 0.25rem;
    }

    .hidden {
      display: none !important;
    }

    .locked {
      max-width: 640px;
      margin: 2.5rem auto;
      background: rgba(255,255,255,0.9);
      border-radius: var(--card-radius);
      padding: 1.5rem 1.6rem;
      box-shadow: 0 18px 40px rgba(148,163,184,0.25);
      text-align: center;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
<div class="page-shell">

  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-logo">PT</div>
        <div>
          PolyTalky
          <div class="brand-sub">–ö—É—Ä–∞—Ç–æ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</div>
        </div>
      </div>

      <div class="header-right">
        <span id="staff-user-email" class="tag-pill">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</span>
        <button id="to-courses" class="btn-ghost" type="button">
          ‚Üê –ö –∫—É—Ä—Å–∞–º
        </button>
        <button id="logout-btn" class="btn-main" type="button">
          <span>–í—ã–π—Ç–∏</span>
        </button>
      </div>
    </div>
  </header>

  <!-- –≠–∫—Ä–∞–Ω "–¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä–∞–º" -->
  <div id="staff-locked" class="locked hidden">
    <h2 style="margin-top:0; font-size:1.1rem;">üîí –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä–∞–º</h2>
    <p style="color:var(--ink-2);margin:0.4rem 0 0.8rem;">
      –ü–æ—Ö–æ–∂–µ, —É –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
      –ï—Å–ª–∏ –≤—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –¥–æ—Å—Ç—É–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å, –Ω–∞–ø–∏—à–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É PolyTalky.
    </p>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
  <main id="staff-main" class="main hidden">

    <section class="hero-row">
      <article class="hero-card">
        <h1 class="hero-title">
          –°—Ç–æ–ª <span>–ö—É—Ä–∞—Ç–æ—Ä–∞</span>
        </h1>
        <p class="hero-text">
          –ó–¥–µ—Å—å —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –∑–∞–¥–∞–Ω–∏—è–º —Ç–∞—Ä–∏—Ñ–∞ PRO –∏ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ —É—Ä–æ–∫–æ–≤.  
          –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å —É—á–µ–Ω–∏–∫–∞–º –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ: –ø—Ä–æ—Å–ª—É—à–∞—Ç—å, –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å,
          —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –∏ –±–µ—Ä–µ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å.
        </p>

        <div class="stat-row">
          <div class="stat-pill">
            üì® <span id="counter-pending">0</span> –Ω–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π
          </div>
          <div class="stat-pill">
            ‚ùì <span id="counter-questions">0</span> –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
          </div>
          <div class="stat-pill">
            ‚ú® –í–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ = –∏—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å
          </div>
        </div>
      </article>

      <aside class="hero-side">
        <div class="hero-metric">
          <h3>
            –§–æ–∫—É—Å —Å–µ–≥–æ–¥–Ω—è
            <span id="focus-label">–ó–∞–¥–∞–Ω–∏—è PRO</span>
          </h3>
          <p style="margin:0;font-size:0.78rem;color:var(--ink-2);">
            –ù–∞—á–Ω–∏—Ç–µ —Å —Ä–∞–∑–¥–µ–ª–∞ ¬´–ó–∞–¥–∞–Ω–∏—è PRO¬ª: —Ç–∞–º –∂–¥—É—Ç –∂–∏–≤—ã–µ –≥–æ–ª–æ—Å–∞ —É—á–µ–Ω–∏–∫–æ–≤.
          </p>
          <div class="metric-bar"><div class="metric-bar-fill"></div></div>
        </div>
        <div class="hero-metric">
          <h3>
            –õ–∞–π—Ñ—Ö–∞–∫ –∫—É—Ä–∞—Ç–æ—Ä–∞
            <span>3‚Äì5 –º–∏–Ω—É—Ç</span>
          </h3>
          <p style="margin:0;font-size:0.78rem;color:var(--ink-2);">
            –û–¥–Ω–æ –Ω–µ–±–æ–ª—å—à–æ–µ, –Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ + –æ–¥–Ω–∞ –ø–æ—Ö–≤–∞–ª–∞ ‚Äî
            —É–∂–µ —Ü–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å.
          </p>
        </div>
      </aside>
    </section>

    <section>
      <div class="tabs-row">
        <button class="tab-btn tab-btn--active" data-tab="submissions">
          üì® –ó–∞–¥–∞–Ω–∏—è PRO
        </button>
        <button class="tab-btn" data-tab="questions">
          ‚ùì –í–æ–ø—Ä–æ—Å—ã –ø–æ —É—Ä–æ–∫–∞–º
        </button>
      </div>

      <div class="content-grid">

        <!-- –õ–∏—Å—Ç -->
        <div class="card" id="tab-submissions">
          <div class="card-header">
            <div>
              <h3>–í—Ö–æ–¥—è—â–∏–µ –∑–∞–¥–∞–Ω–∏—è</h3>
              <p>–ù–æ–≤—ã–µ –∏ –æ–∂–∏–¥–∞—é—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Ç–∞—Ä–∏—Ñ–∞ PRO.</p>
            </div>
            <span class="badge">
              üß© –í—Å–µ –∫—É—Ä—Å—ã
            </span>
          </div>

          <div class="filter-row">
            <div class="chip">
              –°—Ç–∞—Ç—É—Å:
              <select id="filter-status">
                <option value="all">–í—Å–µ</option>
                <option value="pending">–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ</option>
                <option value="checked">–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ</option>
                <option value="needs-more-practice">–ù—É–∂–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–∞</option>
              </select>
            </div>
          </div>

          <ul id="submissions-list" class="list">
            <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ JS -->
          </ul>
        </div>

        <div class="card hidden" id="tab-questions">
          <div class="card-header">
            <div>
              <h3>–í–æ–ø—Ä–æ—Å—ã –ø–æ —É—Ä–æ–∫–∞–º</h3>
              <p>–ü—É–±–ª–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —É—á–µ–Ω–∏–∫–æ–≤ –∏–∑ –±–ª–æ–∫–∞ Q&A.</p>
            </div>
          </div>

          <div class="filter-row">
            <div class="chip">
              –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
            </div>
          </div>

          <ul id="qa-list-staff" class="list">
            <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ JS -->
          </ul>
        </div>

        <!-- –î–µ—Ç–∞–ª–∏ -->
        <div class="card">
          <div class="card-header">
            <div>
              <h3 id="detail-title">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å</h3>
              <p id="detail-meta">–°–ø—Ä–∞–≤–∞ –ø–æ—è–≤–∏—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ–Ω–∏–∫–∞, –µ–≥–æ –æ—Ç–≤–µ—Ç –∏ –ø–æ–ª–µ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.</p>
            </div>
          </div>

          <div id="detail-empty" class="detail-empty">
            –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±—É—é —Å—Ç—Ä–æ–∫—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É.  
            –ú–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å, –Ω–∞–ø–∏—Å–∞—Ç—å —Ç—ë–ø–ª—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë –≤ –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É.
          </div>

          <div id="detail-body" class="hidden">
            <!-- –î–∏–Ω–∞–º–∏—á–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
          </div>
        </div>

      </div>
    </section>
  </main>

</div>

<!-- SCRIPTS -->
<script type="module">
  import {
    onAuthStateChanged,
    signOut,
    getIdTokenResult
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    collectionGroup,
    query,
    orderBy,
    limit,
    onSnapshot,
    updateDoc,
    doc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const auth = window.firebaseAuth;
  const db   = window.firebaseDb;

  const emailEl        = document.getElementById("staff-user-email");
  const logoutBtn      = document.getElementById("logout-btn");
  const toCoursesBtn   = document.getElementById("to-courses");
  const lockedBlock    = document.getElementById("staff-locked");
  const mainBlock      = document.getElementById("staff-main");

  const counterPending   = document.getElementById("counter-pending");
  const counterQuestions = document.getElementById("counter-questions");
  const focusLabel       = document.getElementById("focus-label");

  const tabsBtns = document.querySelectorAll(".tab-btn");
  const tabSubmissions = document.getElementById("tab-submissions");
  const tabQuestions   = document.getElementById("tab-questions");

  const submissionsList = document.getElementById("submissions-list");
  const qaListStaff     = document.getElementById("qa-list-staff");

  const detailTitle = document.getElementById("detail-title");
  const detailMeta  = document.getElementById("detail-meta");
  const detailEmpty = document.getElementById("detail-empty");
  const detailBody  = document.getElementById("detail-body");

  const filterStatus = document.getElementById("filter-status");

  let currentUser = null;
  let isStaff     = false;

  let submissions = []; // {id, data, ref}
  let questions   = [];

  // ========= –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–µ–π–º–æ–≤ =========
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      currentUser = null;
      isStaff = false;
      emailEl.textContent = "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã";
      lockedBlock.classList.remove("hidden");
      mainBlock.classList.add("hidden");
      return;
    }

    currentUser = user;
    emailEl.textContent = user.email || "–ë–µ–∑ email";

    try {
      const token = await getIdTokenResult(user);
      const claims = token.claims || {};
      isStaff = !!(
        claims.role === "admin" ||
        claims.role === "curator" ||
        claims.admin === true   ||
        claims.curator === true
      );
    } catch (e) {
      console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å custom claims:", e);
      isStaff = false;
    }

    if (!isStaff) {
      lockedBlock.classList.remove("hidden");
      mainBlock.classList.add("hidden");
      return;
    }

    lockedBlock.classList.add("hidden");
    mainBlock.classList.remove("hidden");

    initSubmissionsListener();
    initQuestionsListener();
  });

  logoutBtn.addEventListener("click", () => {
    signOut(auth).catch(console.error);
  });

  toCoursesBtn.addEventListener("click", () => {
    window.location.href = "/courses/";
  });

  // ========= –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ =========
  tabsBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      tabsBtns.forEach(b => b.classList.remove("tab-btn--active"));
      btn.classList.add("tab-btn--active");

      if (tab === "submissions") {
        tabSubmissions.classList.remove("hidden");
        tabQuestions.classList.add("hidden");
        focusLabel.textContent = "–ó–∞–¥–∞–Ω–∏—è PRO";
      } else {
        tabSubmissions.classList.add("hidden");
        tabQuestions.classList.remove("hidden");
        focusLabel.textContent = "–í–æ–ø—Ä–æ—Å—ã –ø–æ —É—Ä–æ–∫–∞–º";
      }

      clearDetail();
    });
  });

  // ========= LISTENERS: submissions =========
  function initSubmissionsListener() {
    const qRef = query(
      collectionGroup(db, "answers"),
      orderBy("updatedAt", "desc"),
      limit(80)
    );

    onSnapshot(qRef, (snap) => {
      submissions = [];
      snap.forEach(docSnap => {
        const data = docSnap.data();
        submissions.push({
          id: docSnap.id,
          ref: docSnap.ref,
          data
        });
      });
      renderSubmissions();
    });
  }

  function renderSubmissions() {
    submissionsList.innerHTML = "";
    let pendingCount = 0;

    const statusFilter = filterStatus.value;

    const filtered = submissions.filter(item => {
      const st = item.data.status || "pending";
      if (st === "pending") pendingCount++;
      if (statusFilter === "all") return true;
      return st === statusFilter;
    });

    counterPending.textContent = pendingCount;

    if (!filtered.length) {
      const li = document.createElement("li");
      li.className = "detail-empty";
      li.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π —Å —Ç–∞–∫–∏–º —Ñ–∏–ª—å—Ç—Ä–æ–º.";
      submissionsList.appendChild(li);
      return;
    }

    filtered.forEach(item => {
      const li = document.createElement("li");
      li.className = "list-item";
      li.addEventListener("click", () => openSubmissionDetail(item));

      const top = document.createElement("div");
      top.className = "item-top";

      const title = document.createElement("div");
      title.className = "item-title";
      const course = item.data.courseId || "–∫—É—Ä—Å?";
      const lesson = item.data.lessonSlug || "";
      title.textContent = `${course} ¬∑ ${lesson || "—É—Ä–æ–∫"}`;

      const status = document.createElement("span");
      const st = item.data.status || "pending";
      status.className = "chip " + (
        st === "pending" ? "chip--warn" :
        st === "checked" ? "chip--ok" :
        st === "needs-more-practice" ? "chip--danger" : ""
      );
      status.textContent =
        st === "pending" ? "–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å" :
        st === "checked" ? "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ" :
        st === "needs-more-practice" ? "–ù—É–∂–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–∞" :
        st;

      top.appendChild(title);
      top.appendChild(status);

      const meta = document.createElement("div");
      meta.className = "item-meta";

      if (item.data.userEmail) {
        meta.innerHTML += `<span>üë§ ${item.data.userEmail}</span>`;
      }
      if (item.data.helloAnswer) {
        meta.innerHTML += `<span>‚úèÔ∏è —Ç–µ–∫—Å—Ç –µ—Å—Ç—å</span>`;
      }
      if (item.data.audioAnswerBase64) {
        meta.innerHTML += `<span>üéß –∞—É–¥–∏–æ</span>`;
      }

      li.appendChild(top);
      li.appendChild(meta);
      submissionsList.appendChild(li);
    });
  }

  filterStatus.addEventListener("change", renderSubmissions);

  function openSubmissionDetail(item) {
    detailEmpty.classList.add("hidden");
    detailBody.classList.remove("hidden");
    detailBody.innerHTML = "";

    const d = item.data;

    detailTitle.textContent =
      `${d.courseId || "–ö—É—Ä—Å"} ¬∑ ${d.lessonSlug || "–£—Ä–æ–∫"} ‚Äî –∑–∞–¥–∞–Ω–∏–µ PRO`;
    detailMeta.textContent =
      d.userEmail ? `–£—á–µ–Ω–∏–∫: ${d.userEmail}` : "–£—á–µ–Ω–∏–∫ (email –Ω–µ —É–∫–∞–∑–∞–Ω)";

    // –¢–µ–∫—Å—Ç
    if (d.helloAnswer) {
      const sec = document.createElement("div");
      sec.className = "detail-section";
      sec.innerHTML = `
        <h4>‚úèÔ∏è –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç</h4>
        <p>${d.helloAnswer}</p>
      `;
      detailBody.appendChild(sec);
    }

    // –ê—É–¥–∏–æ
    if (d.audioAnswerBase64) {
      const sec = document.createElement("div");
      sec.className = "detail-section";
      const src = "data:audio/webm;base64," + d.audioAnswerBase64;
      sec.innerHTML = `
        <h4>üéß –ê—É–¥–∏–æ–æ—Ç–≤–µ—Ç</h4>
        <audio controls src="${src}"></audio>
        <p style="margin-top:0.2rem;font-size:0.72rem;color:var(--ink-2);">
          –°–ª—É—à–∞–π—Ç–µ, –∫–∞–∫ –±—É–¥—Ç–æ —Ä—è–¥–æ–º —Å –≤–∞–º–∏ —É—á–µ–Ω–∏–∫. –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–º–µ—Ç–∫—É, –∫–∞–∫–∏–µ –∑–≤—É–∫–∏ –æ—Å–æ–±–µ–Ω–Ω–æ —Ö–æ—Ä–æ—à–æ –ø–æ–ª—É—á–∏–ª–∏—Å—å.
        </p>
      `;
      detailBody.appendChild(sec);
    }

    if (!d.helloAnswer && !d.audioAnswerBase64) {
      const sec = document.createElement("div");
      sec.className = "detail-section";
      sec.innerHTML = `<p class="detail-empty">–í —ç—Ç–æ–º –∑–∞–¥–∞–Ω–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.</p>`;
      detailBody.appendChild(sec);
    }

    // –§–∏–¥–±–µ–∫
    const feedbackSec = document.createElement("div");
    feedbackSec.className = "detail-section";

    feedbackSec.innerHTML = `
      <h4>üí¨ –í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–µ–Ω–∏–∫—É</h4>
      <textarea id="feedback-text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–û—á–µ–Ω—å –∂–∏–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ! –û—Å–æ–±–µ–Ω–Ω–æ –∫–ª–∞—Å—Å–Ω–æ –∑–≤—É—á–∏—Ç –∑–≤—É–∫ /h/. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Å–ª–æ–≤–∞ morning ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞—Å—Ç—è–Ω—É—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–≤—É–∫.¬ª"></textarea>
      <div class="detail-actions">
        <div>
          <label style="font-size:0.72rem;color:var(--ink-2);margin-right:0.35rem;">–°—Ç–∞—Ç—É—Å:</label>
          <select id="status-select" class="status-select">
            <option value="checked">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚úÖ</option>
            <option value="needs-more-practice">–ù—É–∂–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–∞ ‚úèÔ∏è</option>
            <option value="pending">–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–æ–≤–æ–µ</option>
          </select>
        </div>
        <button id="save-feedback" class="btn-main" type="button">
          üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
        </button>
      </div>
      <p id="feedback-hint" style="margin-top:0.3rem;font-size:0.72rem;color:var(--ink-2);"></p>
    `;

    detailBody.appendChild(feedbackSec);

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    const fbText = feedbackSec.querySelector("#feedback-text");
    const stSel  = feedbackSec.querySelector("#status-select");
    const hint   = feedbackSec.querySelector("#feedback-hint");

    if (d.feedback) fbText.value = d.feedback;
    if (d.status)  stSel.value  = d.status;

    feedbackSec.querySelector("#save-feedback").addEventListener("click", async () => {
      if (!currentUser) return;
      const newFeedback = fbText.value.trim();
      const newStatus   = stSel.value;

      try {
        await updateDoc(item.ref, {
          feedback: newFeedback || null,
          status: newStatus,
          checkedAt: serverTimestamp(),
          checkedBy: currentUser.email || null
        });
        hint.textContent = "‚úîÔ∏è –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω —É—á–µ–Ω–∏–∫—É –≤ –µ–≥–æ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.";
      } catch (e) {
        console.error(e);
        hint.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
        hint.style.color = "#B91C1C";
      }
    });
  }

  // ========= LISTENERS: –≤–æ–ø—Ä–æ—Å—ã =========
  function initQuestionsListener() {
    const qRef = query(
      collectionGroup(db, "questions"),
      orderBy("createdAt", "desc"),
      limit(80)
    );

    onSnapshot(qRef, (snap) => {
      questions = [];
      snap.forEach(docSnap => {
        questions.push({
          id: docSnap.id,
          ref: docSnap.ref,
          data: docSnap.data()
        });
      });
      renderQuestions();
    });
  }

  function renderQuestions() {
    qaListStaff.innerHTML = "";
    counterQuestions.textContent = questions.length;

    if (!questions.length) {
      const li = document.createElement("li");
      li.className = "detail-empty";
      li.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç —É—á–µ–Ω–∏–∫–æ–≤.";
      qaListStaff.appendChild(li);
      return;
    }

    questions.forEach(item => {
      const li = document.createElement("li");
      li.className = "list-item";
      li.addEventListener("click", () => openQuestionDetail(item));

      const top = document.createElement("div");
      top.className = "item-top";

      const title = document.createElement("div");
      title.className = "item-title";
      const lessonId = item.data.lessonId || "–£—Ä–æ–∫";
      title.textContent = `–í–æ–ø—Ä–æ—Å ¬∑ ${lessonId}`;

      const status = document.createElement("span");
      const answered = !!item.data.answer;
      status.className = "chip " + (answered ? "chip--ok" : "chip--warn");
      status.textContent = answered ? "–û—Ç–≤–µ—á–µ–Ω–æ" : "–ñ–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞";

      top.appendChild(title);
      top.appendChild(status);

      const meta = document.createElement("div");
      meta.className = "item-meta";
      if (item.data.userEmail) {
        meta.innerHTML += `<span>üë§ ${item.data.userEmail}</span>`;
      }
      if (item.data.text) {
        const short = item.data.text.length > 80
          ? item.data.text.slice(0,77) + "‚Ä¶"
          : item.data.text;
        meta.innerHTML += `<span>¬´${short}¬ª</span>`;
      }

      li.appendChild(top);
      li.appendChild(meta);
      qaListStaff.appendChild(li);
    });
  }

  function openQuestionDetail(item) {
    detailEmpty.classList.add("hidden");
    detailBody.classList.remove("hidden");
    detailBody.innerHTML = "";

    const d = item.data;

    detailTitle.textContent = `–í–æ–ø—Ä–æ—Å –∏–∑ —É—Ä–æ–∫–∞: ${d.lessonId || "–ù–µ —É–∫–∞–∑–∞–Ω"}`;
    detailMeta.textContent = d.userEmail
      ? `–£—á–µ–Ω–∏–∫: ${d.userEmail}`
      : "–£—á–µ–Ω–∏–∫ (email –Ω–µ —É–∫–∞–∑–∞–Ω)";

    const secQ = document.createElement("div");
    secQ.className = "detail-section";
    secQ.innerHTML = `
      <h4>‚ùì –í–æ–ø—Ä–æ—Å —É—á–µ–Ω–∏–∫–∞</h4>
      <p>${d.text || "‚Äî"}</p>
    `;
    detailBody.appendChild(secQ);

    const secA = document.createElement("div");
    secA.className = "detail-section";
    secA.innerHTML = `
      <h4>üí¨ –í–∞—à –æ—Ç–≤–µ—Ç</h4>
      <textarea id="answer-text" placeholder="–û—Ç–≤–µ—Ç—å—Ç–µ –ø—Ä–æ—Å—Ç—ã–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º —è–∑—ã–∫–æ–º. –ú–æ–∂–Ω–æ –¥–∞—Ç—å 1‚Äì2 –ø—Ä–∏–º–µ—Ä–∞, –Ω–æ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Ç–µ–æ—Ä–∏–µ–π."></textarea>
      <div class="detail-actions">
        <span style="font-size:0.72rem;color:var(--ink-2);">–û—Ç–≤–µ—Ç –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º –≤ –±–ª–æ–∫–µ Q&A.</span>
        <button id="save-answer" class="btn-main" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
      </div>
      <p id="answer-hint" style="margin-top:0.3rem;font-size:0.72rem;color:var(--ink-2);"></p>
    `;
    detailBody.appendChild(secA);

    const ansText = secA.querySelector("#answer-text");
    const ansHint = secA.querySelector("#answer-hint");
    if (d.answer) ansText.value = d.answer;

    secA.querySelector("#save-answer").addEventListener("click", async () => {
      if (!currentUser) return;
      const text = ansText.value.trim();
      if (!text) {
        ansHint.textContent = "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.";
        ansHint.style.color = "#B91C1C";
        return;
      }

      try {
        await updateDoc(item.ref, {
          answer: text,
          answerBy: currentUser.email || null,
          answeredAt: serverTimestamp()
        });
        ansHint.textContent = "‚úîÔ∏è –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –£—á–µ–Ω–∏–∫–∏ —É–≤–∏–¥—è—Ç –µ–≥–æ –≤ —Å–≤–æ–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.";
        ansHint.style.color = "var(--ink-2)";
      } catch (e) {
        console.error(e);
        ansHint.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
        ansHint.style.color = "#B91C1C";
      }
    });
  }

  function clearDetail() {
    detailBody.classList.add("hidden");
    detailEmpty.classList.remove("hidden");
    detailTitle.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å";
    detailMeta.textContent = "–°–ø—Ä–∞–≤–∞ –ø–æ—è–≤–∏—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ–Ω–∏–∫–∞, –µ–≥–æ –æ—Ç–≤–µ—Ç –∏ –ø–æ–ª–µ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.";
  }

</script>

</body>
</html>
