<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>PolyTalky ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="/">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                   "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top left,#ffffff 0,#f9fafb 45%,#eef2ff 100%);
      color:#020617;
    }
    .card {
      border-radius: 1.25rem;
      border: 1px solid rgba(15,23,42,0.06);
      background: #ffffff;
      box-shadow: 0 22px 45px rgba(15,23,42,0.08);
    }
    .badge {
      border-radius:999px;
      padding:.25rem .8rem;
      font-size:.7rem;
      border:1px solid rgba(15,23,42,.08);
      background:#fffef7ee;
      backdrop-filter:blur(8px);
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

<header class="border-b border-slate-200 bg-white/80 backdrop-blur sticky top-0 z-40">
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <span class="inline-flex h-8 w-8 rounded-xl bg-slate-900 items-center justify-center text-white text-lg">P</span>
      <div>
        <p class="font-semibold text-sm">PolyTalky Admin</p>
        <p class="text-[11px] text-slate-500">–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏ –∏ PRO</p>
      </div>
    </div>
  </div>
</header>

<main class="flex-1 py-8">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 space-y-6">

    <!-- –ë–ª–æ–∫ —Å –∫–ª—é—á–æ–º -->
    <section class="card p-4 sm:p-5 space-y-3">
      <div class="flex items-center justify-between gap-2">
        <div>
          <p class="text-sm font-semibold">–î–æ—Å—Ç—É–ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
          <p class="text-xs text-slate-500 mt-0.5">
            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ADMIN_API_KEY –∏–∑ Render ‚Üí Environment.
          </p>
        </div>
        <span class="badge text-[10px] uppercase tracking-[0.16em] text-slate-600">–¢–æ–ª—å–∫–æ –≤—ã</span>
      </div>

      <div class="space-y-2">
        <label for="adminKey" class="block text-xs text-slate-600">Admin key</label>
        <input
          id="adminKey"
          type="password"
          class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/80"
          placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ ADMIN_API_KEY"
        />
        <p class="text-[11px] text-slate-500">
          –ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <b>localStorage</b> –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
          <code class="bg-slate-100 px-1 rounded text-[10px]">x-admin-key</code>.
        </p>
      </div>
    </section>

    <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <section class="card p-4 sm:p-5 space-y-5">
      <div class="space-y-1">
        <p class="text-sm font-semibold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</p>
        <p class="text-xs text-slate-500">–í–≤–µ–¥–∏—Ç–µ email ‚Äî –∑–∞–≥—Ä—É–∑—è—Ç—Å—è PRO –∏ –∫—É—Ä—Å—ã.</p>
      </div>

      <div class="grid gap-3 sm:grid-cols-[2fr,auto] items-end">
        <div>
          <label for="email" class="block text-xs text-slate-600 mb-1">Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
          <input
            id="email"
            type="email"
            class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/80"
            placeholder="user@example.com"
          />
        </div>
        <button
          id="btnLoad"
          class="inline-flex items-center justify-center rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold px-4 py-2.5"
        >
          –ó–∞–≥—Ä—É–∑–∏—Ç—å
        </button>
      </div>

      <div id="loadStatus" class="text-xs text-slate-500 min-h-[1.25rem]"></div>

      <!-- –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
      <div id="userBlock" class="hidden border-t border-dashed border-slate-200 pt-4 mt-2 space-y-4">
        <div class="flex items-center justify-between gap-2">
          <div>
            <p class="text-sm font-semibold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
            <p id="userIdLabel" class="text-xs text-slate-500"></p>
          </div>
          <span id="proBadge" class="badge text-xs font-semibold text-emerald-700 hidden">PRO –∞–∫—Ç–∏–≤–µ–Ω</span>
        </div>

        <div class="grid sm:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="space-y-2">
              <label class="block text-xs text-slate-600">–°—Ç–∞—Ç—É—Å PRO</label>
              <label class="inline-flex items-center gap-2 text-xs text-slate-700">
                <input id="proCheckbox" type="checkbox" class="rounded border-slate-300">
                <span>–í–∫–ª—é—á–∏—Ç—å PRO –¥–ª—è —ç—Ç–æ–≥–æ email</span>
              </label>
              <p class="text-[11px] text-slate-500">
                –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—é <code class="bg-slate-100 px-1 rounded">proGlobal</code> –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ <code class="bg-slate-100 px-1 rounded">users</code>.
              </p>
            </div>

            <div class="space-y-2">
              <label for="proUntil" class="block text-xs text-slate-600">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è PRO (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input
                id="proUntil"
                type="date"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-slate-900/80"
              />
              <p class="text-[11px] text-slate-500">
                –•—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ <code class="bg-slate-100 px-1 rounded">YYYY-MM-DD</code> –≤ –ø–æ–ª–µ
                <code class="bg-slate-100 px-1 rounded">proUntil</code>. –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî PRO –±–µ–∑ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è.
              </p>
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-xs text-slate-600">–ö—É—Ä—Å—ã</label>
            <!-- —á–µ–∫–±–æ–∫—Å—ã –∫—É—Ä—Å–æ–≤ -->
            <div id="coursesCheckboxes" class="grid grid-cols-1 gap-1.5 text-xs text-slate-700 mb-2">
              <!-- —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ—Ç—Ä–∏—Å—É—é—Ç—Å—è –≥–∞–ª–æ—á–∫–∏ -->
            </div>
            <label for="coursesExtra" class="block text-xs text-slate-600 mt-1">–î–æ–ø. –∫—É—Ä—Å—ã (ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <textarea
              id="coursesExtra"
              rows="2"
              class="w-full rounded-xl border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-slate-900/80"
              placeholder="–µ—Å–ª–∏ –∫—É—Ä—Å –Ω–µ –≤ —Å–ø–∏—Å–∫–µ ‚Äî –≤–ø–∏—à–∏—Ç–µ —Å—é–¥–∞ –µ–≥–æ ID"
            ></textarea>
            <p class="text-[11px] text-slate-500">
              –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ <code class="bg-slate-100 px-1 rounded">courses</code> —É–π–¥—É—Ç –∏ –≥–∞–ª–æ—á–∫–∏, –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã.
            </p>
          </div>
        </div>

        <div class="flex items-center justify-between gap-2 pt-2">
          <p class="text-[11px] text-slate-500 max-w-xs">
            –í–Ω–∏–º–∞–Ω–∏–µ: —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ <b>–ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º</b> —Ç–µ–º, —á—Ç–æ —É–∫–∞–∑–∞–Ω–æ –∑–¥–µ—Å—å.
          </p>
          <button
            id="btnSave"
            class="inline-flex items-center justify-center rounded-xl bg-amber-400 hover:bg-amber-300 text-slate-900 text-sm font-semibold px-4 py-2.5"
          >
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          </button>
        </div>

        <div id="saveStatus" class="text-xs text-slate-500 min-h-[1.25rem]"></div>
      </div>
    </section>

    <!-- –õ–æ–≥–∏ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ -->
    <section class="card p-4 sm:p-5 space-y-3">
      <div class="flex items-center justify-between gap-2">
        <div>
          <p class="text-sm font-semibold">–õ–æ–≥–∏ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏</p>
          <p class="text-xs text-slate-500">–ó–¥–µ—Å—å —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Å–¥–µ–ª–∞–ª–∏ —á–µ—Ä–µ–∑ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
        </div>
      </div>
      <div id="logs" class="text-xs text-slate-600 space-y-1 max-h-48 overflow-auto">
        <p class="text-[11px] text-slate-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>
      </div>
    </section>

  </div>
</main>

<script>
  const backendBase = "https://polytalky-backend.onrender.com";

  // –°–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ (–º–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω—è—Ç—å)
  const KNOWN_COURSES = [
    { id: "english-intro",      label: "English Intro" },
    { id: "swedish-from-zero",  label: "Swedish from zero" },
    { id: "afrikaans",          label: "Afrikaans" },
    { id: "german-from-zero",   label: "German from zero" },
    { id: "spanish-from-zero",  label: "Spanish from zero" },
    // –¥–æ–±–∞–≤—å —Å—é–¥–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ ID –∫—É—Ä—Å–æ–≤ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  ];

  const adminKeyInput  = document.getElementById("adminKey");
  const emailInput     = document.getElementById("email");
  const btnLoad        = document.getElementById("btnLoad");
  const btnSave        = document.getElementById("btnSave");
  const loadStatus     = document.getElementById("loadStatus");
  const saveStatus     = document.getElementById("saveStatus");
  const userBlock      = document.getElementById("userBlock");
  const userIdLabel    = document.getElementById("userIdLabel");
  const proCheckbox    = document.getElementById("proCheckbox");
  const proUntilInput  = document.getElementById("proUntil");
  const coursesExtra   = document.getElementById("coursesExtra");
  const coursesBox     = document.getElementById("coursesCheckboxes");
  const proBadge       = document.getElementById("proBadge");
  const logsContainer  = document.getElementById("logs");

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º admin key –∏–∑ localStorage
  const storedKey = localStorage.getItem("pt_admin_key");
  if (storedKey) adminKeyInput.value = storedKey;

  adminKeyInput.addEventListener("change", () => {
    localStorage.setItem("pt_admin_key", adminKeyInput.value.trim());
  });

  function getAdminKey() {
    return adminKeyInput.value.trim();
  }

  function setLoadStatus(msg, err = false) {
    loadStatus.textContent = msg || "";
    loadStatus.className = "text-xs " + (err ? "text-red-600" : "text-slate-500");
  }

  function setSaveStatus(msg, err = false) {
    saveStatus.textContent = msg || "";
    saveStatus.className = "text-xs " + (err ? "text-red-600" : "text-slate-500");
  }

  function showUserBlock(show) {
    userBlock.classList.toggle("hidden", !show);
  }

  function updateProBadge(active) {
    proBadge.classList.toggle("hidden", !active);
  }

  function appendLog(message) {
    const ts = new Date().toLocaleString();
    const line = document.createElement("p");
    line.textContent = `[${ts}] ${message}`;
    logsContainer.querySelectorAll("p")[0]?.remove(); // —É–±–∏—Ä–∞–µ–º "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π", –µ—Å–ª–∏ –µ—â—ë –µ—Å—Ç—å
    logsContainer.appendChild(line);
  }

  // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤-–≥–∞–ª–æ—á–µ–∫
  function renderCourseCheckboxes() {
    coursesBox.innerHTML = "";
    KNOWN_COURSES.forEach(course => {
      const label = document.createElement("label");
      label.className = "inline-flex items-center gap-2";

      const input = document.createElement("input");
      input.type = "checkbox";
      input.value = course.id;
      input.className = "course-checkbox rounded border-slate-300";

      const span = document.createElement("span");
      span.textContent = `${course.label} (${course.id})`;

      label.appendChild(input);
      label.appendChild(span);

      const wrapper = document.createElement("div");
      wrapper.appendChild(label);

      coursesBox.appendChild(wrapper);
    });
  }

  renderCourseCheckboxes();

  function getSelectedCourseIds() {
    return Array.from(document.querySelectorAll(".course-checkbox"))
      .filter(cb => cb.checked)
      .map(cb => cb.value);
  }

  function setCourseCheckboxesFromList(courseIds) {
    const idsSet = new Set(courseIds);
    document.querySelectorAll(".course-checkbox").forEach(cb => {
      cb.checked = idsSet.has(cb.value);
    });
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async function loadUser() {
    setSaveStatus("");
    const adminKey = getAdminKey();
    const email = emailInput.value.trim();

    if (!adminKey) return setLoadStatus("–£–∫–∞–∂–∏—Ç–µ admin key.", true);
    if (!email) return setLoadStatus("–í–≤–µ–¥–∏—Ç–µ email.", true);

    setLoadStatus("–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...");
    showUserBlock(false);

    try {
      const resp = await fetch(backendBase + "/api/admin/get-user", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-admin-key": adminKey
        },
        body: JSON.stringify({ email })
      });

      if (!resp.ok) {
        setLoadStatus("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + resp.status, true);
        return;
      }

      const data = await resp.json();

      let coursesForUser = [];
      let pro = false;
      let proUntil = "";

      if (!data.found) {
        setLoadStatus("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.", false);
        userIdLabel.textContent = "–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω users/" + email;
        pro = false;
        coursesForUser = [];
        proUntil = "";
      } else {
        const u = data.user;
        userIdLabel.textContent = "users/" + u.id;
        pro = !!u.proGlobal;
        coursesForUser = Array.isArray(u.courses) ? u.courses : [];
        // proUntil –±–µ—Ä—ë–º –∏–∑ raw.proUntil –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
        if (u.raw && typeof u.raw.proUntil === "string") {
          proUntil = u.raw.proUntil;
        } else {
          proUntil = "";
        }
        setLoadStatus("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.", false);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è PRO
      proCheckbox.checked = pro;
      updateProBadge(pro);
      proUntilInput.value = proUntil;

      // –†–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –∫—É—Ä—Å—ã –ø–æ –≥–∞–ª–æ—á–∫–∞–º + extra
      setCourseCheckboxesFromList(coursesForUser);
      const knownIds = new Set(KNOWN_COURSES.map(c => c.id));
      const extra = coursesForUser.filter(id => !knownIds.has(id));
      coursesExtra.value = extra.join(", ");

      showUserBlock(true);
      appendLog(`–ó–∞–≥—Ä—É–∂–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${email} (found: ${data.found})`);

    } catch (e) {
      console.error(e);
      setLoadStatus("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.", true);
    }
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async function saveUser() {
    const adminKey = getAdminKey();
    const email = emailInput.value.trim();

    if (!adminKey) return setSaveStatus("–£–∫–∞–∂–∏—Ç–µ admin key.", true);
    if (!email) return setSaveStatus("–í–≤–µ–¥–∏—Ç–µ email.", true);

    const pro = proCheckbox.checked;
    const proUntil = proUntilInput.value || null;
    const selected = getSelectedCourseIds();
    const extraStr = (coursesExtra.value || "").trim();

    // –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤
    let finalCourses = [...selected];
    if (extraStr) {
      const extraList = extraStr
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);
      finalCourses = [...new Set([...finalCourses, ...extraList])];
    }

    setSaveStatus("–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è...");

    try {
      const resp = await fetch(backendBase + "/api/admin/save-user", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-admin-key": adminKey
        },
        body: JSON.stringify({
          email,
          proGlobal: pro,
          courses: finalCourses,
          proUntil: proUntil    // <- —ç—Ç–æ –ø–æ–ª–µ –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –Ω–∞ backend
        })
      });

      if (!resp.ok) {
        setSaveStatus("–û—à–∏–±–∫–∞: " + resp.status, true);
        return;
      }

      const data = await resp.json();

      if (data.ok) {
        setSaveStatus("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.", false);
        updateProBadge(pro);
        appendLog(`–°–æ—Ö—Ä–∞–Ω—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${email}: PRO=${pro}, courses=[${finalCourses.join(", ")}], proUntil=${proUntil || "‚Äî"}`);
      } else {
        setSaveStatus("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.", true);
      }

    } catch (e) {
      console.error(e);
      setSaveStatus("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.", true);
    }
  }

  btnLoad.addEventListener("click", loadUser);
  btnSave.addEventListener("click", saveUser);

  emailInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      loadUser();
    }
  });
</script>

</body>
</html>
