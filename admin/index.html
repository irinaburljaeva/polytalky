<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PolyTalky — Живой редактор</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .edit-outline{ outline:2px dashed #FFBA08; outline-offset:2px; }
    .img-chip{ position:absolute; bottom:6px; right:6px; font-size:12px; background:#0009; color:#fff; padding:2px 6px; border-radius:6px }
    .img-wrap{ position:relative; display:inline-block }
  </style>
</head>
<body class="min-h-screen bg-[#0f1115] text-white">
  <main class="grid lg:grid-cols-[320px,1fr] gap-0 min-h-screen">
    <!-- Sidebar -->
    <aside class="border-r border-white/10 bg-black/30 p-4 space-y-4">
      <h1 class="text-xl font-bold">Живой редактор</h1>

      <section class="space-y-2">
        <h2 class="font-semibold">Подключение к GitHub</h2>
        <input id="gh-user"   class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Владелец (напр. irinaburljaeva)" />
        <input id="gh-repo"   class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Репозиторий (напр. polytalky)" />
        <input id="gh-branch" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" value="main" placeholder="Ветка (main)" />
        <input id="gh-token"  type="password" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Personal Access Token (repo)" />
        <button id="connect" class="w-full px-3 py-2 rounded-xl bg-white text-gray-900 font-semibold">Подключиться</button>
        <div id="status" class="text-sm text-white/70"></div>
      </section>

      <section class="space-y-2">
        <h2 class="font-semibold">Страница</h2>
        <select id="page" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10">
          <option value="/">Главная (index.html)</option>
          <option value="/courses/">Курсы (/courses/index.html)</option>
          <option value="/shop/">Магазин (/shop/index.html)</option>
          <option value="/student/">Личный кабинет (/student/index.html)</option>
        </select>
        <button id="load" class="w-full px-3 py-2 rounded-xl bg-white text-gray-900 font-semibold">Открыть</button>
      </section>

      <section class="space-y-2">
        <h2 class="font-semibold">Редактирование</h2>
        <button id="toggle-edit" class="w-full px-3 py-2 rounded-xl bg-yellow-400 text-gray-900 font-semibold">Включить редактирование</button>
        <button id="save" class="w-full px-3 py-2 rounded-xl bg-emerald-400 text-gray-900 font-semibold">Сохранить изменения</button>
        <div class="text-xs text-white/60">
          Редактируются все элементы с атрибутом <code>data-ct="ключ"</code>.  
          Картинки — с <code>data-ct-img="ключ"</code>.
        </div>
      </section>

      <section class="space-y-2">
        <h2 class="font-semibold">Картинка (заменить)</h2>
        <input id="img-key" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Ключ (например, logo)" />
        <input id="img-path" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Куда сохранить (assets/logo.png)" />
        <input id="img-file" type="file" accept="image/*" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10 bg-transparent" />
        <button id="img-upload" class="w-full px-3 py-2 rounded-xl bg-white text-gray-900 font-semibold">Загрузить и подставить</button>
        <div class="text-xs text-white/60">Выберите элемент на странице с таким же ключом <code>data-ct-img</code> — ссылка обновится.</div>
      </section>

      <section class="space-y-2">
        <h2 class="font-semibold">Справка</h2>
        <div class="text-sm text-white/70 space-y-2">
          <p>Пометьте редактируемые места на страницах:</p>
          <pre class="text-xs bg-black/40 p-2 rounded border border-white/10 overflow-auto">
&lt;h1 data-ct="hero-title"&gt;Заголовок&lt;/h1&gt;
&lt;p data-ct="hero-sub"&gt;Подзаголовок&lt;/p&gt;
&lt;a data-ct="cta-1"&gt;Кнопка 1&lt;/a&gt;
&lt;img data-ct-img="logo" src="assets/logo.png" alt="Логотип"&gt;
          </pre>
          <p>Текст попадает в <code>data/content.json</code>, картинки — в <code>/assets/</code>.</p>
        </div>
      </section>
    </aside>

    <!-- Preview -->
    <section class="min-h-screen">
      <iframe id="frame" class="w-full h-screen" src="/" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
    </section>
  </main>

  <script>
    // --- helpers for GitHub API ---
    const E = s => document.querySelector(s);
    const store = {
      get k(){ return JSON.parse(localStorage.getItem('pt_live') || '{}') },
      set k(v){ localStorage.setItem('pt_live', JSON.stringify(v)) }
    };
    function setStatus(t){ E('#status').textContent = t||'' }
    function b64(bytes){ return btoa(Array.from(bytes).map(b=>String.fromCharCode(b)).join('')) }
    function apiPath(path){
      const {user,repo,branch} = store.k;
      return `https://api.github.com/repos/${user}/${repo}/contents/${path}?ref=${branch}`;
    }
    async function ghGet(path){
      const r = await fetch(apiPath(path), { headers: { Authorization:`Bearer ${store.k.token}` }});
      if(!r.ok) throw new Error('GET '+path+' '+r.status);
      return r.json();
    }
    async function ghPut(path, content, sha, message){
      const body = { message, content, branch: store.k.branch };
      if(sha) body.sha = sha;
      const r = await fetch(apiPath(path), {
        method:'PUT',
        headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${store.k.token}` },
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error('PUT '+path+' '+r.status+' '+await r.text());
      return r.json();
    }

    // connect
    E('#connect').onclick = async () => {
      const user = E('#gh-user').value.trim();
      const repo = E('#gh-repo').value.trim();
      const branch = E('#gh-branch').value.trim() || 'main';
      const token = E('#gh-token').value.trim();
      store.k = {user, repo, branch, token};
      setStatus('Пробую прочитать data/content.json...');
      try{
        const r = await ghGet('data/content.json');
        // просто проверка доступа
        setStatus('OK: доступ есть. Изменения можно сохранять.');
      }catch(e){
        setStatus('Предупреждение: data/content.json пока нет. Он будет создан автоматически при сохранении.');
      }
    };

    // load page into iframe
    E('#load').onclick = () => {
      const url = E('#page').value;
      E('#frame').src = url;
    };

    // make editable
    let editOn = false;
    E('#toggle-edit').onclick = () => {
      const w = E('#frame').contentWindow;
      const d = w.document;
      if(!d || !d.body){ alert('Страница ещё не загрузилась'); return; }

      editOn = !editOn;
      E('#toggle-edit').textContent = editOn ? 'Выключить редактирование' : 'Включить редактирование';

      // текстовые узлы
      d.querySelectorAll('[data-ct]').forEach(el=>{
        el.contentEditable = editOn ? 'true' : 'false';
        el.classList.toggle('edit-outline', editOn);
      });

      // картинки
      d.querySelectorAll('[data-ct-img]').forEach(el=>{
        if(editOn){
          el.classList.add('edit-outline');
          // бейдж
          if(!el.parentElement.classList.contains('img-wrap')){
            const wrap = d.createElement('span');
            wrap.className = 'img-wrap';
            el.parentNode.insertBefore(wrap, el);
            wrap.appendChild(el);
            const chip = d.createElement('span');
            chip.className = 'img-chip';
            chip.textContent = 'Картинка: ' + el.getAttribute('data-ct-img');
            wrap.appendChild(chip);
          }
        } else {
          el.classList.remove('edit-outline');
          // упрощённо: не разворачиваем обратно, это не влияет на отображение
        }
      });
    };

    // save to content.json (collect all [data-ct] from iframe)
    E('#save').onclick = async () => {
      const w = E('#frame').contentWindow;
      const d = w.document;
      if(!d || !d.body){ alert('Страница не загружена'); return; }

      // Собираем текстовые/кнопочные значения
      const index = {};
      d.querySelectorAll('[data-ct]').forEach(el=>{
        const key = el.getAttribute('data-ct');
        // если есть теги внутри — сохраняем HTML, иначе текст
        const hasInnerTags = el.innerHTML.trim() !== el.textContent.trim();
        index[key] = hasInnerTags ? el.innerHTML : el.textContent;
      });

      // Загружаем существующий JSON (если есть)
      let cfg = {};
      let sha;
      try{
        const res = await ghGet('data/content.json');
        cfg = JSON.parse(atob(res.content));
        sha = res.sha;
      }catch(e){
        cfg = {};
        sha = undefined;
      }
      cfg.index = Object.assign(cfg.index||{}, index);

      try{
        const res = await ghPut('data/content.json',
          btoa(new TextEncoder().encode(JSON.stringify(cfg,null,2))),
          sha,
          'feat: update content.json via live editor'
        );
        setStatus('Сохранено ✔ ' + new Date().toLocaleTimeString());
      }catch(e){
        setStatus('Ошибка сохранения: ' + e.message);
      }
    };

    // upload image and set src
    E('#img-upload').onclick = async ()=>{
      const key = E('#img-key').value.trim();
      const path = (E('#img-path').value||'').replace(/^\/+/, '');
      const file = E('#img-file').files?.[0];
      if(!key || !path || !file){ setStatus('Укажите ключ, путь и файл'); return; }

      setStatus('Загружаю изображение в репозиторий...');
      try{
        const bytes = new Uint8Array(await file.arrayBuffer());
        await ghPut(path, b64(bytes), undefined, 'feat: upload asset '+path);
      }catch(e){ setStatus('Ошибка загрузки: '+e.message); return; }

      // Меняем src у картинки в iframe
      const w = E('#frame').contentWindow;
      const d = w.document;
      const img = d.querySelector(`[data-ct-img="${key}"]`);
      if(!img){ setStatus('На странице нет элемента data-ct-img="'+key+'"'); return; }
      img.setAttribute('src', '/'+path.replace(/^\/+/,''));
      setStatus('Готово: картинка обновлена');

      // (опционально) можно вынести ссылки на картинки тоже в JSON, но чаще достаточно просто менять src
    };

    // preload saved creds
    const saved = store.k; if(saved.user){
      E('#gh-user').value = saved.user;
      E('#gh-repo').value = saved.repo;
      E('#gh-branch').value = saved.branch||'main';
    }
  </script>
</body>
</html>
