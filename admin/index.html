{
  "index": {
    "heroTitle": "Изучайте языки <span class=\"text-[var(--brand-2)]\">для жизни</span>, а не только для тестов",
    "heroSub": "Короткие уроки, понятные объяснения и практические задания. Испанский, английский, немецкий и китайский — с нуля до уверенного общения.",
    "cta1": "Посмотреть все курсы",
    "cta2": "Демо: Испанский A0"
  }
}

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PolyTalky — Панель редактирования</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}</style>
</head>
<body class="min-h-screen bg-[#0f1115] text-white">
  <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold mb-4">Панель редактирования</h1>

    <section class="p-4 rounded-2xl border border-white/10 bg-white/5 mb-6">
      <h2 class="font-semibold mb-2">Подключение к GitHub</h2>
      <div class="grid sm:grid-cols-2 gap-3">
        <input id="gh-user" class="px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Владелец/организация (например, IrinaB)" />
        <input id="gh-repo" class="px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Репозиторий (например, polytalky)" />
        <input id="gh-branch" class="px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Ветка (обычно main)" value="main" />
        <input id="gh-token" type="password" class="px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Персональный токен (repo доступ)" />
      </div>
      <div class="mt-3 flex gap-2">
        <button id="connect" class="px-4 py-2 rounded-xl bg-white text-gray-900 font-semibold">Подключиться</button>
        <span id="status" class="text-sm text-white/80"></span>
      </div>
      <p class="text-xs text-white/60 mt-2">
        Токен создаётся в GitHub → Settings → Developer settings → Personal access tokens → Fine-grained. Дайте доступ к нужному репозиторию (read/write).
      </p>
    </section>

    <section class="p-4 rounded-2xl border border-white/10 bg-white/5 mb-6">
      <h2 class="font-semibold mb-2">Главная страница (index)</h2>
      <label class="block text-sm mb-1">Заголовок (hero) — можно с HTML</label>
      <textarea id="index-heroTitle" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" rows="2"></textarea>
      <label class="block text-sm mt-3 mb-1">Подзаголовок</label>
      <textarea id="index-heroSub" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" rows="2"></textarea>
      <div class="grid sm:grid-cols-2 gap-3 mt-3">
        <div>
          <label class="block text-sm mb-1">Кнопка 1 (текст)</label>
          <input id="index-cta1" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" />
        </div>
        <div>
          <label class="block text-sm mb-1">Кнопка 2 (текст)</label>
          <input id="index-cta2" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" />
        </div>
      </div>
      <div class="mt-3">
        <button id="save-content" class="px-4 py-2 rounded-xl bg-white text-gray-900 font-semibold">Сохранить текст</button>
        <span id="save-msg" class="text-sm text-white/80 ml-2"></span>
      </div>
    </section>

    <section class="p-4 rounded-2xl border border-white/10 bg-white/5 mb-6">
      <h2 class="font-semibold mb-2">Загрузка изображений</h2>
      <div class="grid sm:grid-cols-2 gap-3">
        <input id="asset-path" class="px-3 py-2 rounded bg-black/40 border border-white/10" placeholder="Путь (напр. assets/hero.jpg)" />
        <input id="asset-file" type="file" class="px-3 py-2 rounded bg-black/40 border border-white/10 bg-transparent" accept="image/*" />
      </div>
      <div class="mt-3 flex gap-2">
        <button id="upload" class="px-4 py-2 rounded-xl bg-white text-gray-900 font-semibold">Загрузить</button>
        <span id="upload-msg" class="text-sm text-white/80"></span>
      </div>
      <p class="text-xs text-white/60 mt-2">После загрузки обращайтесь к файлу как <code>/assets/имя-файла</code> из HTML/JSON.</p>
    </section>

<section class="p-4 rounded-2xl border border-white/10 bg-white/5">
      <h2 class="font-semibold mb-2">Продвинутые: редактор JSON</h2>
      <p class="text-white/80 text-sm mb-2">Правка <code>/data/content.json</code> напрямую.</p>
      <textarea id="raw" class="w-full px-3 py-2 rounded bg-black/40 border border-white/10" rows="12"></textarea>
      <div class="mt-3 flex gap-2">
        <button id="save-raw" class="px-4 py-2 rounded-xl bg-white text-gray-900 font-semibold">Сохранить JSON</button>
        <span id="raw-msg" class="text-sm text-white/80"></span>
      </div>
    </section>
  </main>

  <script>
    const ui = s=>document.querySelector(s);
    const store = {
      get k(){return JSON.parse(localStorage.getItem('pt_admin')||'{}')},
      set k(v){localStorage.setItem('pt_admin', JSON.stringify(v))}
    };
    function setStatus(msg){ ui('#status').textContent = msg||'' }
    function b64(bytes){ return btoa(Array.from(bytes).map(b=>String.fromCharCode(b)).join('')) }
    function apiPath(path){
      const {user,repo,branch} = store.k;
      return https://api.github.com/repos/${user}/${repo}/contents/${path}?ref=${branch};
    }
    async function githubGet(path){
      const r = await fetch(apiPath(path), { headers: { Authorization:Bearer ${store.k.token} } });
      if(!r.ok) throw new Error('GET '+path+' '+r.status);
      return r.json();
    }
    async function githubPut(path, content, sha, message){
      const body = { message, content, branch: store.k.branch };
      if(sha) body.sha = sha;
      const r = await fetch(apiPath(path), {
        method:'PUT',
        headers:{ 'Content-Type':'application/json', Authorization:Bearer ${store.k.token} },
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error('PUT '+path+' '+r.status+' '+await r.text());
      return r.json();
    }

    // connect
    ui('#connect').onclick = async ()=>{
      const user = ui('#gh-user').value.trim();
      const repo = ui('#gh-repo').value.trim();
      const branch = ui('#gh-branch').value.trim()||'main';
      const token = ui('#gh-token').value.trim();
      store.k = {user,repo,branch,token};
      setStatus('Пробую получить /data/content.json...');
      try{
        let json, sha;
        try{ const res = await githubGet('data/content.json'); json = JSON.parse(atob(res.content)); sha = res.sha; }
        catch(e){ json = { index:{ heroTitle:'', heroSub:'', cta1:'', cta2:'' } }; sha = undefined; }
        ui('#index-heroTitle').value = json.index?.heroTitle||'';
        ui('#index-heroSub').value   = json.index?.heroSub||'';
        ui('#index-cta1').value      = json.index?.cta1||'';
        ui('#index-cta2').value      = json.index?.cta2||'';
        ui('#raw').value = JSON.stringify(json, null, 2);
        store.k.sha = sha;
        setStatus('Готово. Соединение установлено.');
      }catch(e){ setStatus('Ошибка подключения: '+e.message) }
    };

    // save content fields
    ui('#save-content').onclick = async ()=>{
      const data = {
        index: {
          heroTitle: ui('#index-heroTitle').value,
          heroSub: ui('#index-heroSub').value,
          cta1: ui('#index-cta1').value,
          cta2: ui('#index-cta2').value
        }
      };
      try{
        const sha = store.k.sha;
        const res = await githubPut('data/content.json', btoa(new TextEncoder().encode(JSON.stringify(data,null,2))), sha, 'chore: update content.json via admin');
        store.k.sha = res.content.sha;
        ui('#save-msg').textContent = 'Сохранено ✔';
        ui('#raw').value = JSON.stringify(data, null, 2);
      }catch(e){ ui('#save-msg').textContent = 'Ошибка: '+e.message }
    };

    // save raw JSON
    ui('#save-raw').onclick = async ()=>{
      try{
        const text = ui('#raw').value;

const parsed = JSON.parse(text);
        const sha = store.k.sha;
        const res = await githubPut('data/content.json', btoa(new TextEncoder().encode(JSON.stringify(parsed,null,2))), sha, 'chore: update content.json (raw)');
        store.k.sha = res.content.sha;
        ui('#raw-msg').textContent = 'Сохранено ✔';
      }catch(e){ ui('#raw-msg').textContent = 'Ошибка: '+e.message }
    };

    // upload image
    ui('#upload').onclick = async ()=>{
      const file = ui('#asset-file').files?.[0];
      const path = (ui('#asset-path').value||'').replace(/^\/+/, '');
      if(!file || !path){ ui('#upload-msg').textContent = 'Укажите путь и выберите файл.'; return; }
      ui('#upload-msg').textContent = 'Загружаю...';
      try{
        const bytes = new Uint8Array(await file.arrayBuffer());
        await githubPut(path, b64(bytes), undefined, 'feat: upload asset '+path);
        ui('#upload-msg').textContent = 'Загружено ✔ ('+path+')';
      }catch(e){ ui('#upload-msg').textContent = 'Ошибка: '+e.message }
    };

    // preload saved credentials
    const saved = store.k; if(saved.user){ ui('#gh-user').value=saved.user; ui('#gh-repo').value=saved.repo; ui('#gh-branch').value=saved.branch||'main'; }
  </script>
</body>
</html>
